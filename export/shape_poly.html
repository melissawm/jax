
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Shape polymorphism &#8212; JAX  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/style.css?v=537c1ddb" />
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=30646c52"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'export/shape_poly';</script>
    <link rel="icon" href="../_static/favicon.png"/>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Interoperation with TensorFlow" href="jax2tf.html" />
    <link rel="prev" title="Exporting and serializing staged-out computations" href="export.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/jax_logo_250px.png" class="logo__image only-light" alt="JAX  documentation - Home"/>
    <script>document.write(`<img src="../_static/jax_logo_250px.png" class="logo__image only-dark" alt="JAX  documentation - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/thinking_in_jax.html">Quickstart: How to think in JAX</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../notebooks/Common_Gotchas_in_JAX.html">🔪 JAX - The Sharp Bits 🔪</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../tutorials.html">Tutorials</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../jit-compilation.html">Just-in-time compilation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../automatic-vectorization.html">Automatic vectorization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../automatic-differentiation.html">Automatic differentiation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tracing.html">Tracing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../random-numbers.html">Pseudorandom numbers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../stateful-computations.html">Stateful computations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../control-flow.html">Control flow and logical operators with JIT</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pytrees.html">Pytrees</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro_parallel.html">Introduction to Parallel Programming with JAX</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Resources and Advanced Guides</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../key-concepts.html">Key concepts</a></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../advanced_guide.html">Resources and Advanced Guides</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../notebooks/autodiff_cookbook.html">The Autodiff Cookbook</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/Custom_derivative_rules_for_Python_code.html">Custom derivative rules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/autodiff_remat.html">Control autodiff’s saved values with <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code> (aka <code class="docutils literal notranslate"><span class="pre">jax.remat</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../advanced-autodiff.html">Advanced automatic differentiation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../custom_pytrees.html">Custom pytrees and initialization with unexpected values</a></li>
<li class="toctree-l2"><a class="reference internal" href="../errors.html">Errors</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../debugging.html">Introduction to debugging</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../debugging/print_breakpoint.html">Compiled prints and breakpoints</a></li>
<li class="toctree-l3"><a class="reference internal" href="../debugging/checkify_guide.html">The <code class="docutils literal notranslate"><span class="pre">checkify</span></code> transformation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../debugging/flags.html">JAX debugging flags</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../debugging/flags.html">JAX debugging flags</a></li>
<li class="toctree-l2"><a class="reference internal" href="../transfer_guard.html">Transfer guard</a></li>
<li class="toctree-l2"><a class="reference internal" href="../persistent_compilation_cache.html">Persistent compilation cache</a></li>
<li class="toctree-l2"><a class="reference internal" href="../buffer_donation.html">Buffer donation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gpu_performance_tips.html">GPU performance tips</a></li>
<li class="toctree-l2"><a class="reference internal" href="../benchmarking.html">Benchmarking JAX code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../profiling.html">Profiling computation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../device_memory_profiling.html">Profiling device memory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/Distributed_arrays_and_automatic_parallelization.html">Distributed arrays and automatic parallelization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/explicit-sharding.html">Explicit sharding (a.k.a. “sharding in types”)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/shard_map.html">Manual parallelism with <code class="docutils literal notranslate"><span class="pre">shard_map</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/host-offloading.html">JAX Memories and Host Offloading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../multi_process.html">Introduction to multi-controller JAX (aka multi-process/multi-host JAX)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../distributed_data_loading.html">Distributed data loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../external-callbacks.html">External callbacks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ffi.html">Foreign function interface (FFI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gradient-checkpointing.html">Gradient checkpointing with <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code> (<code class="docutils literal notranslate"><span class="pre">jax.remat</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../aot.html">Ahead-of-time lowering and compilation</a></li>
<li class="toctree-l2 current active has-children"><a class="reference internal" href="index.html">Exporting and serialization</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="export.html">Exporting and serializing staged-out computations</a></li>
<li class="toctree-l3 current active"><a class="current reference internal" href="#">Shape polymorphism</a></li>
<li class="toctree-l3"><a class="reference internal" href="jax2tf.html">Interoperation with TensorFlow</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../type_promotion.html">Type promotion semantics</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../pallas/index.html">Pallas: a JAX kernel language</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../pallas/quickstart.html">Pallas Quickstart</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pallas/pipelining.html">Software Pipelining</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pallas/grid_blockspec.html">Grids and BlockSpecs</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../pallas/tpu/index.html">Pallas TPU</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../pallas/tpu/details.html">Writing TPU kernels with Pallas</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pallas/tpu/pipelining.html">TPU Pipelining</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pallas/tpu/matmul.html">Matrix Multiplication</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pallas/tpu/sparse.html">Scalar Prefetch and Block-Sparse Computation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pallas/tpu/distributed.html">Distributed Computing in Pallas for TPUs</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../pallas/gpu/index.html">Pallas:Mosaic GPU</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../pallas/gpu/reference.html">Writing Mosaic GPU kernels with Pallas</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../pallas/design/index.html">Pallas Design Notes</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../pallas/design/design.html">Pallas Design</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pallas/design/async_note.html">Pallas Async Operations</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../pallas/CHANGELOG.html">Pallas Changelog</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/neural_network_with_tfds_data.html">Training a simple neural network, with tensorflow/datasets data loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/Neural_Network_and_Data_Loading.html">Training a simple neural network, with PyTorch data loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/vmapped_log_probs.html">Autobatching for Bayesian inference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/convolutions.html">Generalized convolutions in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../xla_flags.html">List of XLA compiler flags</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sharded-computation.html">Introduction to parallel programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-primitives.html">JAX Internals: primitives</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jaxpr.html">JAX internals: The jaxpr language</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../contributor_guide.html">Developer notes</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-9"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html">Contributing to JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer.html">Building from source</a></li>
<li class="toctree-l2"><a class="reference internal" href="../investigating_a_regression.html">Investigating a regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../autodidax.html">Autodidax: JAX core from scratch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../autodidax2_part1.html">Autodidax2, part 1: JAX from scratch, again</a></li>

<li class="toctree-l2 has-children"><a class="reference internal" href="../jep/index.html">JAX Enhancement Proposals (JEPs)</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-10"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jep/263-prng.html">263: JAX PRNG Design</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/2026-custom-derivatives.html">2026: Custom JVP/VJP rules for JAX-transformable functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/4008-custom-vjp-update.html">4008: Custom VJP and `nondiff_argnums` update</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/4410-omnistaging.html">4410: Omnistaging</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/9263-typed-keys.html">9263: Typed keys &amp; pluggable RNGs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/9407-type-promotion.html">9407: Design of Type Promotion Semantics for JAX</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/9419-jax-versioning.html">9419: Jax and Jaxlib versioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/10657-sequencing-effects.html">10657: Sequencing side-effects in JAX</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/11830-new-remat-checkpoint.html">11830: `jax.remat` / `jax.checkpoint` new implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/12049-type-annotations.html">12049: Type Annotation Roadmap for JAX</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/14273-shard-map.html">14273: `shard_map` (`shmap`) for simple per-device code</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/15856-jex.html">15856: `jax.extend`, an extensions module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/17111-shmap-transpose.html">17111: Efficient transposition of `shard_map` (and other maps)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/18137-numpy-scipy-scope.html">18137: Scope of JAX NumPy &amp; SciPy Wrappers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/25516-effver.html">25516: Effort-based versioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/28661-jax-array-protocol.html">28661: Supporting the `__jax_array__` protocol</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../extensions.html">Extension guides</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-11"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/Writing_custom_interpreters_in_Jax.html">Writing custom Jaxpr interpreters in JAX</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.extend.html"><code class="docutils literal notranslate"><span class="pre">jax.extend</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-12"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.core.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.core</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.linear_util.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.linear_util</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.mlir.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.mlir</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.random.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.random</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../building_on_jax.html">Building on JAX</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../notes.html">Notes</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-13"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../api_compatibility.html">API compatibility</a></li>
<li class="toctree-l2"><a class="reference internal" href="../deprecation.html">Python and NumPy version support policy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../async_dispatch.html">Asynchronous dispatch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concurrency.html">Concurrency</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gpu_memory_allocation.html">GPU memory allocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rank_promotion_warning.html">Rank promotion warning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../default_dtypes.html">Default dtypes and the X64 flag</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../jax.html">Public API: <code class="docutils literal notranslate"><span class="pre">jax</span></code> package</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-14"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.numpy.html"><code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-15"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fft.html">jax.numpy.fft.fft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fft2.html">jax.numpy.fft.fft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fftfreq.html">jax.numpy.fft.fftfreq</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fftn.html">jax.numpy.fft.fftn</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fftshift.html">jax.numpy.fft.fftshift</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.hfft.html">jax.numpy.fft.hfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ifft.html">jax.numpy.fft.ifft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ifft2.html">jax.numpy.fft.ifft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ifftn.html">jax.numpy.fft.ifftn</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ifftshift.html">jax.numpy.fft.ifftshift</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ihfft.html">jax.numpy.fft.ihfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.irfft.html">jax.numpy.fft.irfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.irfft2.html">jax.numpy.fft.irfft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.irfftn.html">jax.numpy.fft.irfftn</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.rfft.html">jax.numpy.fft.rfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.rfft2.html">jax.numpy.fft.rfft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.rfftfreq.html">jax.numpy.fft.rfftfreq</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.rfftn.html">jax.numpy.fft.rfftn</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.scipy.html"><code class="docutils literal notranslate"><span class="pre">jax.scipy</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-16"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.scipy.stats.bernoulli.logpmf.html">jax.scipy.stats.bernoulli.logpmf</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.scipy.stats.bernoulli.pmf.html">jax.scipy.stats.bernoulli.pmf</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.scipy.stats.bernoulli.cdf.html">jax.scipy.stats.bernoulli.cdf</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.scipy.stats.bernoulli.ppf.html">jax.scipy.stats.bernoulli.ppf</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../jax.lax.html"><code class="docutils literal notranslate"><span class="pre">jax.lax</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.random.html"><code class="docutils literal notranslate"><span class="pre">jax.random</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.sharding.html"><code class="docutils literal notranslate"><span class="pre">jax.sharding</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.debug.html"><code class="docutils literal notranslate"><span class="pre">jax.debug</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.dlpack.html"><code class="docutils literal notranslate"><span class="pre">jax.dlpack</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.distributed.html"><code class="docutils literal notranslate"><span class="pre">jax.distributed</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.dtypes.html"><code class="docutils literal notranslate"><span class="pre">jax.dtypes</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.ffi.html"><code class="docutils literal notranslate"><span class="pre">jax.ffi</span></code> module</a></li>

<li class="toctree-l2"><a class="reference internal" href="../jax.flatten_util.html"><code class="docutils literal notranslate"><span class="pre">jax.flatten_util</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.image.html"><code class="docutils literal notranslate"><span class="pre">jax.image</span></code> module</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.nn.html"><code class="docutils literal notranslate"><span class="pre">jax.nn</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-17"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jax.nn.initializers.html"><code class="docutils literal notranslate"><span class="pre">jax.nn.initializers</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../jax.ops.html"><code class="docutils literal notranslate"><span class="pre">jax.ops</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.profiler.html"><code class="docutils literal notranslate"><span class="pre">jax.profiler</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.stages.html"><code class="docutils literal notranslate"><span class="pre">jax.stages</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.test_util.html"><code class="docutils literal notranslate"><span class="pre">jax.test_util</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.tree.html"><code class="docutils literal notranslate"><span class="pre">jax.tree</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.tree_util.html"><code class="docutils literal notranslate"><span class="pre">jax.tree_util</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.typing.html"><code class="docutils literal notranslate"><span class="pre">jax.typing</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.export.html"><code class="docutils literal notranslate"><span class="pre">jax.export</span></code> module</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.extend.html"><code class="docutils literal notranslate"><span class="pre">jax.extend</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-18"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.core.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.core</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.linear_util.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.linear_util</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.mlir.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.mlir</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.random.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.random</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.example_libraries.html"><code class="docutils literal notranslate"><span class="pre">jax.example_libraries</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-19"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jax.example_libraries.optimizers.html"><code class="docutils literal notranslate"><span class="pre">jax.example_libraries.optimizers</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.example_libraries.stax.html"><code class="docutils literal notranslate"><span class="pre">jax.example_libraries.stax</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.experimental.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-20" name="toctree-checkbox-20" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-20"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.checkify.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.checkify</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.compilation_cache.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.compilation_cache</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.custom_dce.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.custom_dce</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.custom_partitioning.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.custom_partitioning</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.jet.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.jet</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.key_reuse.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.key_reuse</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.mesh_utils.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.mesh_utils</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.multihost_utils.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.multihost_utils</span></code> module</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../jax.experimental.pallas.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.pallas</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-21" name="toctree-checkbox-21" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-21"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../jax.experimental.pallas.mosaic_gpu.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.pallas.mosaic_gpu</span></code> module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../jax.experimental.pallas.triton.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.pallas.triton</span></code> module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../jax.experimental.pallas.tpu.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.pallas.tpu</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.pjit.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.pjit</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.serialize_executable.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.serialize_executable</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.shard_map.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.shard_map</span></code> module</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../jax.experimental.sparse.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.sparse</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-22" name="toctree-checkbox-22" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-22"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.BCOO.html">jax.experimental.sparse.BCOO</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_broadcast_in_dim.html">jax.experimental.sparse.bcoo_broadcast_in_dim</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_concatenate.html">jax.experimental.sparse.bcoo_concatenate</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_dot_general.html">jax.experimental.sparse.bcoo_dot_general</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_dot_general_sampled.html">jax.experimental.sparse.bcoo_dot_general_sampled</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_dynamic_slice.html">jax.experimental.sparse.bcoo_dynamic_slice</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_extract.html">jax.experimental.sparse.bcoo_extract</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_fromdense.html">jax.experimental.sparse.bcoo_fromdense</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_gather.html">jax.experimental.sparse.bcoo_gather</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_multiply_dense.html">jax.experimental.sparse.bcoo_multiply_dense</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_multiply_sparse.html">jax.experimental.sparse.bcoo_multiply_sparse</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_update_layout.html">jax.experimental.sparse.bcoo_update_layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_reduce_sum.html">jax.experimental.sparse.bcoo_reduce_sum</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_reshape.html">jax.experimental.sparse.bcoo_reshape</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_slice.html">jax.experimental.sparse.bcoo_slice</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_sort_indices.html">jax.experimental.sparse.bcoo_sort_indices</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_squeeze.html">jax.experimental.sparse.bcoo_squeeze</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_sum_duplicates.html">jax.experimental.sparse.bcoo_sum_duplicates</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_todense.html">jax.experimental.sparse.bcoo_todense</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_transpose.html">jax.experimental.sparse.bcoo_transpose</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../jax.lib.html"><code class="docutils literal notranslate"><span class="pre">jax.lib</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.addressable_shards.html">jax.Array.addressable_shards</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.all.html">jax.Array.all</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.any.html">jax.Array.any</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.argmax.html">jax.Array.argmax</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.argmin.html">jax.Array.argmin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.argpartition.html">jax.Array.argpartition</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.argsort.html">jax.Array.argsort</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.astype.html">jax.Array.astype</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.at.html">jax.Array.at</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.choose.html">jax.Array.choose</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.clip.html">jax.Array.clip</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.compress.html">jax.Array.compress</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.committed.html">jax.Array.committed</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.conj.html">jax.Array.conj</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.conjugate.html">jax.Array.conjugate</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.copy.html">jax.Array.copy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.copy_to_host_async.html">jax.Array.copy_to_host_async</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.cumprod.html">jax.Array.cumprod</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.cumsum.html">jax.Array.cumsum</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.device.html">jax.Array.device</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.diagonal.html">jax.Array.diagonal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.dot.html">jax.Array.dot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.dtype.html">jax.Array.dtype</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.flat.html">jax.Array.flat</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.flatten.html">jax.Array.flatten</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.global_shards.html">jax.Array.global_shards</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.imag.html">jax.Array.imag</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.is_fully_addressable.html">jax.Array.is_fully_addressable</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.is_fully_replicated.html">jax.Array.is_fully_replicated</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.item.html">jax.Array.item</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.itemsize.html">jax.Array.itemsize</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.max.html">jax.Array.max</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.mean.html">jax.Array.mean</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.min.html">jax.Array.min</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.nbytes.html">jax.Array.nbytes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.ndim.html">jax.Array.ndim</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.nonzero.html">jax.Array.nonzero</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.prod.html">jax.Array.prod</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.ptp.html">jax.Array.ptp</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.ravel.html">jax.Array.ravel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.real.html">jax.Array.real</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.repeat.html">jax.Array.repeat</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.reshape.html">jax.Array.reshape</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.round.html">jax.Array.round</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.searchsorted.html">jax.Array.searchsorted</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.shape.html">jax.Array.shape</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.sharding.html">jax.Array.sharding</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.size.html">jax.Array.size</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.sort.html">jax.Array.sort</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.squeeze.html">jax.Array.squeeze</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.std.html">jax.Array.std</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.sum.html">jax.Array.sum</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.swapaxes.html">jax.Array.swapaxes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.take.html">jax.Array.take</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.to_device.html">jax.Array.to_device</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.trace.html">jax.Array.trace</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.transpose.html">jax.Array.transpose</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.var.html">jax.Array.var</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.view.html">jax.Array.view</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.T.html">jax.Array.T</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.mT.html">jax.Array.mT</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../about.html">About the project</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../faq.html">Frequently asked questions (FAQ)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Change log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary of terms</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../config_options.html">Configuration Options</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../advanced_guide.html" class="nav-link">Resources and Advanced Guides</a></li>
    
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">Exporting and serialization</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Shape polymorphism</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/jax-ml/jax" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/export/shape_poly.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Shape polymorphism</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#correctness-of-shape-polymorphism">Correctness of shape polymorphism</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#computing-with-dimension-variables">Computing with dimension variables</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#errors-in-presence-of-shape-polymorphism">Errors in presence of shape polymorphism</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparison-of-symbolic-dimensions-is-partially-supported">Comparison of symbolic dimensions is partially supported</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#user-specified-symbolic-constraints">User-specified symbolic constraints</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#symbolic-dimension-scopes">Symbolic dimension scopes</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#caveat-for-equality-comparisons">Caveat for equality comparisons</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dimension-variables-must-be-solvable-from-the-input-shapes">Dimension variables must be solvable from the input shapes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#shape-assertion-errors">Shape assertion errors</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#debugging">Debugging</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="shape-polymorphism">
<span id="shape-poly"></span><h1>Shape polymorphism<a class="headerlink" href="#shape-polymorphism" title="Link to this heading">#</a></h1>
<p>When JAX is used in JIT mode, a function will be traced, lowered to StableHLO, and compiled for each
combination of input types and shapes. After exporting a function and
deserializing it on another system we don’t have the Python sources available anymore,
so we cannot re-trace and re-lower it. <strong>Shape polymorphism</strong> is a feature of JAX export
to allow some exported functions to be used for a whole family of input shapes.
These functions are traced and lowered once, during exporting, and <code class="docutils literal notranslate"><span class="pre">Exported</span></code>
object contains the information needed to be able to compile and execute the function
on many concrete input shapes. We do this by specifying shapes that contain
dimension variables (symbolic shapes) when exporting, as in the
following example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">jax</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">export</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">jnp</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>  <span class="c1"># f: f32[a, b]</span>
<span class="gp">... </span>  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># We construct symbolic dimension variables.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">export</span><span class="o">.</span><span class="n">symbolic_shape</span><span class="p">(</span><span class="s2">&quot;a, b&quot;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># We can use the symbolic dimensions to construct shapes.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">x_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">x_shape</span>
<span class="go">(a, b)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Then we export with symbolic shapes:</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">exp</span><span class="p">:</span> <span class="n">export</span><span class="o">.</span><span class="n">Exported</span> <span class="o">=</span> <span class="n">export</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">f</span><span class="p">))(</span>
<span class="gp">... </span>    <span class="n">jax</span><span class="o">.</span><span class="n">ShapeDtypeStruct</span><span class="p">(</span><span class="n">x_shape</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">exp</span><span class="o">.</span><span class="n">in_avals</span>
<span class="go">(ShapedArray(int32[a,b]),)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">exp</span><span class="o">.</span><span class="n">out_avals</span>
<span class="go">(ShapedArray(int32[a,2*b]),)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># We can later call with concrete shapes (with a=3 and b=4), without re-tracing `f`.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">shape</span>
<span class="go">(3, 8)</span>

</pre></div>
</div>
<p>Note that such functions are still re-compiled on demand for
each concrete input shape they are invoked on. Only the
tracing and the lowering are saved.</p>
<p>The <a class="reference internal" href="../_autosummary/jax.export.symbolic_shape.html#jax.export.symbolic_shape" title="jax.export.symbolic_shape"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.export.symbolic_shape()</span></code></a> is used in the above
example to parse a string representation of a symbolic shape
into dimension expressions objects (of type <code class="docutils literal notranslate"><span class="pre">_DimExpr</span></code>) that are usable in place of integer
constants to construct shapes. The dimension expression objects
overload most integer operators, so you can use them as
you’d use integer constants in most cases.
See <a class="reference internal" href="#computing-with-dimension-variables"><span class="std std-ref">Computing with dimension variables</span></a> for more details.</p>
<p>Additionally, we provide the <a class="reference internal" href="../_autosummary/jax.export.symbolic_args_specs.html#jax.export.symbolic_args_specs" title="jax.export.symbolic_args_specs"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.export.symbolic_args_specs()</span></code></a> that
can be used to construct pytrees of <code class="docutils literal notranslate"><span class="pre">jax.ShapeDtypeStruct</span></code> objects based
on a polymorphic shape specification:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">f1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span> <span class="c1"># x: f32[a, 1], y : f32[a, 4]</span>
<span class="gp">... </span> <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Assuming you have some actual args with concrete shapes</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">args_specs</span> <span class="o">=</span> <span class="n">export</span><span class="o">.</span><span class="n">symbolic_args_specs</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="s2">&quot;a, ...&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">exp</span> <span class="o">=</span> <span class="n">export</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">f1</span><span class="p">))(</span><span class="o">*</span> <span class="n">args_specs</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">exp</span><span class="o">.</span><span class="n">in_avals</span>
<span class="go">(ShapedArray(int32[a,1]), ShapedArray(int32[a,4]))</span>

</pre></div>
</div>
<p>Note how the polymorphic shape specification <code class="docutils literal notranslate"><span class="pre">&quot;a,</span> <span class="pre">...&quot;</span></code> contains
the placeholder <code class="docutils literal notranslate"><span class="pre">...</span></code> to be filled from the concrete shapes of
the concrete shapes of the arguments <code class="docutils literal notranslate"><span class="pre">(x,</span> <span class="pre">y)</span></code>.
The placeholder <code class="docutils literal notranslate"><span class="pre">...</span></code> stands for 0 or more dimensions, while the
placeholder <code class="docutils literal notranslate"><span class="pre">_</span></code> stands for one dimension.
The <a class="reference internal" href="../_autosummary/jax.export.symbolic_args_specs.html#jax.export.symbolic_args_specs" title="jax.export.symbolic_args_specs"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.export.symbolic_args_specs()</span></code></a> supports pytrees of arguments,
which are used to fill-in the dtypes and any placeholders.
The function will construct a pytree of
argument specifications (<a class="reference internal" href="../_autosummary/jax.ShapeDtypeStruct.html#jax.ShapeDtypeStruct" title="jax.ShapeDtypeStruct"><code class="xref py py-class docutils literal notranslate"><span class="pre">jax.ShapeDtypeStruct</span></code></a>)
matching the structure of the arguments passed to it.
The polymorphic shapes specification can be a
pytree prefix in cases where one specification should apply
to multiple arguments, as in the above example.
See <a class="reference external" href="https://docs.jax.dev/en/latest/pytrees.html#applying-optional-parameters-to-pytrees">how optional parameters are matched to arguments</a>.</p>
<p>A few examples of shape specifications:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">(&quot;(b,</span> <span class="pre">_,</span> <span class="pre">_)&quot;,</span> <span class="pre">None)</span></code> can be used for a function with two arguments, the first
being a 3D array with a batch leading dimension that should be symbolic.
The other dimensions for the
first argument and the shape of the second argument are specialized based on the actual
arguments. Note that the same specification would work if the first
argument is a pytree of 3D arrays, all with the same leading dimension
but possibly with different trailing dimensions.
The value <code class="docutils literal notranslate"><span class="pre">None</span></code> for the second argument means that the argument
is not symbolic. Equivalently, one can use <code class="docutils literal notranslate"><span class="pre">...</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">(&quot;(batch,</span> <span class="pre">...)&quot;,</span> <span class="pre">&quot;(batch,)&quot;)</span></code> specifies that the two arguments
have matching leading dimensions, the first argument has rank at
least 1, and the second has rank 1.</p></li>
</ul>
<section id="correctness-of-shape-polymorphism">
<h2>Correctness of shape polymorphism<a class="headerlink" href="#correctness-of-shape-polymorphism" title="Link to this heading">#</a></h2>
<p>We want to trust that the exported program produces the same results as the
original JAX program when compiled and executed for any applicable concrete shapes.
More precisely:</p>
<p>For any JAX function <code class="docutils literal notranslate"><span class="pre">f</span></code> and any argument specification <code class="docutils literal notranslate"><span class="pre">arg_spec</span></code> containing a
symbolic shape, and any concrete argument <code class="docutils literal notranslate"><span class="pre">arg</span></code> whose shape matches <code class="docutils literal notranslate"><span class="pre">arg_spec</span></code>:</p>
<ul class="simple">
<li><p>If the JAX native execution succeeds on the concrete argument: <code class="docutils literal notranslate"><span class="pre">res</span> <span class="pre">=</span> <span class="pre">f(arg)</span></code>,</p></li>
<li><p>and if the exporting succeeds with symbolic shapes: <code class="docutils literal notranslate"><span class="pre">exp</span> <span class="pre">=</span> <span class="pre">export.export(f)(arg_spec)</span></code>,</p></li>
<li><p>then compiling and running the export will succeed with the same result: <code class="docutils literal notranslate"><span class="pre">res</span> <span class="pre">==</span> <span class="pre">exp.call(arg)</span></code></p></li>
</ul>
<p>It is crucial to understand that <code class="docutils literal notranslate"><span class="pre">f(arg)</span></code> has the freedom to re-invoke
the JAX tracing machinery,
and in fact it does so for each distinct concrete <code class="docutils literal notranslate"><span class="pre">arg</span></code> shape,
while the execution of <code class="docutils literal notranslate"><span class="pre">exp.call(arg)</span></code> cannot use JAX tracing anymore
(this execution may happen in an environment where the source code
of <code class="docutils literal notranslate"><span class="pre">f</span></code> is not available).</p>
<p>Ensuring this form of correctness is hard, and in the hardest cases
exporting fails. The rest of this chapter describes how to handle these failures.</p>
</section>
<section id="computing-with-dimension-variables">
<span id="id1"></span><h2>Computing with dimension variables<a class="headerlink" href="#computing-with-dimension-variables" title="Link to this heading">#</a></h2>
<p>JAX keeps track of the shapes of all intermediate results. When those shapes depend
on dimension variables JAX computes them as symbolic dimension expressions
involving dimension variables.
Dimension variables stand for integer values greater or equal to 1.
The symbolic expressions can represent the result
of applying arithmetic operators (add, sub, mul, floordiv, mod,
including the NumPy variants <code class="docutils literal notranslate"><span class="pre">np.sum</span></code>, <code class="docutils literal notranslate"><span class="pre">np.prod</span></code>, etc.) <strong>on dimension
expressions and integers</strong> (<code class="docutils literal notranslate"><span class="pre">int</span></code>, <code class="docutils literal notranslate"><span class="pre">np.int</span></code>, or anything convertible by <code class="docutils literal notranslate"><span class="pre">operator.index</span></code>).
These symbolic dimensions can then be used in shape-parameters of JAX primitives
and APIs, e.g., in <code class="docutils literal notranslate"><span class="pre">jnp.reshape</span></code>, <code class="docutils literal notranslate"><span class="pre">jnp.arange</span></code>, slicing indices, etc.</p>
<p>For example, in the following code to flatten a 2D array, the computation
<code class="docutils literal notranslate"><span class="pre">x.shape[0]</span> <span class="pre">*</span> <span class="pre">x.shape[1]</span></code> computes the symbolic dimension <code class="docutils literal notranslate"><span class="pre">4</span> <span class="pre">*</span> <span class="pre">b</span></code> as the
new shape:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">arg_spec</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">ShapeDtypeStruct</span><span class="p">(</span><span class="n">export</span><span class="o">.</span><span class="n">symbolic_shape</span><span class="p">(</span><span class="s2">&quot;b, 4&quot;</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">exp</span> <span class="o">=</span> <span class="n">export</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">f</span><span class="p">))(</span><span class="n">arg_spec</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">exp</span><span class="o">.</span><span class="n">out_avals</span>
<span class="go">(ShapedArray(int32[4*b]),)</span>

</pre></div>
</div>
<p>It is possible to convert dimension expressions explicitly
to JAX arrays, with <code class="docutils literal notranslate"><span class="pre">jnp.array(x.shape[0])</span></code> or even <code class="docutils literal notranslate"><span class="pre">jnp.array(x.shape)</span></code>.
The result of these operations can be used as regular JAX arrays,
but cannot be used anymore as dimensions in shapes, e.g., in <code class="docutils literal notranslate"><span class="pre">reshape</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">exp</span> <span class="o">=</span> <span class="n">export</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">x</span><span class="p">))(</span>
<span class="gp">... </span>    <span class="n">jax</span><span class="o">.</span><span class="n">ShapeDtypeStruct</span><span class="p">(</span><span class="n">export</span><span class="o">.</span><span class="n">symbolic_shape</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">exp</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
<span class="go">Array([3, 4, 5], dtype=int32)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">exp</span> <span class="o">=</span> <span class="n">export</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)))(</span>
<span class="gp">... </span>    <span class="n">jax</span><span class="o">.</span><span class="n">ShapeDtypeStruct</span><span class="p">(</span><span class="n">export</span><span class="o">.</span><span class="n">symbolic_shape</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>  
<span class="gt">Traceback (most recent call last):</span>
<span class="gr">TypeError</span>: <span class="n">Shapes must be 1D sequences of concrete values of integer type, got [Traced&lt;ShapedArray(int32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;].</span>

</pre></div>
</div>
<p>When a symbolic dimension is used in arithmetic operations with <strong>non-integers</strong>,
e.g., <code class="docutils literal notranslate"><span class="pre">float</span></code>, <code class="docutils literal notranslate"><span class="pre">np.float</span></code>, <code class="docutils literal notranslate"><span class="pre">np.ndarray</span></code>, or JAX arrays, it is automatically
converted to a JAX array using <code class="docutils literal notranslate"><span class="pre">jnp.array</span></code>.
For example, in the function below all occurrences of <code class="docutils literal notranslate"><span class="pre">x.shape[0]</span></code>
are converted implicitly to <code class="docutils literal notranslate"><span class="pre">jnp.array(x.shape[0])</span></code> because
they are involved in operations with non-integer scalars or with
JAX arrays:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">exp</span> <span class="o">=</span> <span class="n">export</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span>
<span class="gp">... </span>    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mf">5.</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<span class="gp">... </span>               <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
<span class="gp">... </span>               <span class="n">x</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))))(</span>
<span class="gp">... </span>    <span class="n">jax</span><span class="o">.</span><span class="n">ShapeDtypeStruct</span><span class="p">(</span><span class="n">export</span><span class="o">.</span><span class="n">symbolic_shape</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">exp</span><span class="o">.</span><span class="n">out_avals</span>
<span class="go">(ShapedArray(float32[], weak_type=True),</span>
<span class="go"> ShapedArray(int32[5]),</span>
<span class="go"> ShapedArray(float32[b], weak_type=True))</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">exp</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
<span class="go"> (Array(8., dtype=float32, weak_type=True),</span>
<span class="go">  Array([ 3, 2, 1, 0, -1], dtype=int32),</span>
<span class="go">  Array([4.14112, 4.14112, 4.14112], dtype=float32, weak_type=True))</span>

</pre></div>
</div>
<p>Another typical example is when computing averages
(observe how <code class="docutils literal notranslate"><span class="pre">x.shape[0]</span></code> is automatically turned into a JAX array):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">exp</span> <span class="o">=</span> <span class="n">export</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span>
<span class="gp">... </span>    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))(</span>
<span class="gp">... </span>    <span class="n">jax</span><span class="o">.</span><span class="n">ShapeDtypeStruct</span><span class="p">(</span><span class="n">export</span><span class="o">.</span><span class="n">symbolic_shape</span><span class="p">(</span><span class="s2">&quot;b, c&quot;</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">exp</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)))</span>
<span class="go">Array([4., 5., 6., 7.], dtype=float32)</span>

</pre></div>
</div>
<section id="errors-in-presence-of-shape-polymorphism">
<h3>Errors in presence of shape polymorphism<a class="headerlink" href="#errors-in-presence-of-shape-polymorphism" title="Link to this heading">#</a></h3>
<p>Most JAX code assumes that the shapes of JAX arrays are tuples of integers,
but with shape polymorphism some dimensions may be symbolic expressions.
This can lead to a number of errors. For example, we can have the usual
JAX shape check errors:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">v</span><span class="p">,</span> <span class="o">=</span> <span class="n">export</span><span class="o">.</span><span class="n">symbolic_shape</span><span class="p">(</span><span class="s2">&quot;v,&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">export</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">))(</span>
<span class="gp">... </span>    <span class="n">jax</span><span class="o">.</span><span class="n">ShapeDtypeStruct</span><span class="p">((</span><span class="n">v</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
<span class="gp">... </span>    <span class="n">jax</span><span class="o">.</span><span class="n">ShapeDtypeStruct</span><span class="p">((</span><span class="mi">4</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="gr">TypeError</span>: <span class="n">add got incompatible shapes for broadcasting: (v,), (4,).</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">export</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)))(</span>
<span class="gp">... </span>    <span class="n">jax</span><span class="o">.</span><span class="n">ShapeDtypeStruct</span><span class="p">((</span><span class="n">v</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="gr">TypeError</span>: <span class="n">dot_general requires contracting dimensions to have the same shape, got (4,) and (v,).</span>

</pre></div>
</div>
<p>We can fix the above matmul example by specifying that the
argument has shape <code class="docutils literal notranslate"><span class="pre">(v,</span> <span class="pre">v)</span></code>.</p>
</section>
<section id="comparison-of-symbolic-dimensions-is-partially-supported">
<h3>Comparison of symbolic dimensions is partially supported<a class="headerlink" href="#comparison-of-symbolic-dimensions-is-partially-supported" title="Link to this heading">#</a></h3>
<p>Inside JAX there are a number of equality and inequality comparisons
involving shapes, e.g., for doing shape checking or even for choosing
the implementation for some primitives. Comparisons are supported
as follows:</p>
<ul class="simple">
<li><p>equality is supported with a caveat: if the two symbolic dimensions denote the same
value under all valuations for dimension variables, then equality evaluates to <code class="docutils literal notranslate"><span class="pre">True</span></code>,
e.g., for <code class="docutils literal notranslate"><span class="pre">b</span> <span class="pre">+</span> <span class="pre">b</span> <span class="pre">==</span> <span class="pre">2*b</span></code>; otherwise the equality evaluates to <code class="docutils literal notranslate"><span class="pre">False</span></code>.
See <a class="reference internal" href="#caveat-for-equality-comparisons">below</a>
for a discussion of important consequences of this behavior.</p></li>
<li><p>disequality is always the negation of equality.</p></li>
<li><p>inequality is partially supported, in a similar way as partial equality.
However, in this
case we take into consideration that dimension variables range over strictly positive
integers. E.g., <code class="docutils literal notranslate"><span class="pre">b</span> <span class="pre">&gt;=</span> <span class="pre">1</span></code>, <code class="docutils literal notranslate"><span class="pre">b</span> <span class="pre">&gt;=</span> <span class="pre">0</span></code>, <code class="docutils literal notranslate"><span class="pre">2</span> <span class="pre">*</span> <span class="pre">a</span> <span class="pre">+</span> <span class="pre">b</span> <span class="pre">&gt;=</span> <span class="pre">3</span></code> are <code class="docutils literal notranslate"><span class="pre">True</span></code>, while <code class="docutils literal notranslate"><span class="pre">b</span> <span class="pre">&gt;=</span> <span class="pre">2</span></code>,
<code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">&gt;=</span> <span class="pre">b</span></code>, <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">-</span> <span class="pre">b</span> <span class="pre">&gt;=</span> <span class="pre">0</span></code> are inconclusive and result in an exception.</p></li>
</ul>
<p>In cases where a comparison operation cannot be resolved to a boolean,
we raise <code class="xref py py-class docutils literal notranslate"><span class="pre">InconclusiveDimensionOperation</span></code>. E.g.,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">jax</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">export</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="mi">1</span><span class="p">))(</span>
<span class="o">...</span>     <span class="n">jax</span><span class="o">.</span><span class="n">ShapeDtypeStruct</span><span class="p">(</span><span class="n">export</span><span class="o">.</span><span class="n">symbolic_shape</span><span class="p">(</span><span class="s2">&quot;a, b&quot;</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>  <span class="c1"># doctest: +IGNORE_EXCEPTION_DETAIL</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
<span class="n">jax</span><span class="o">.</span><span class="n">_src</span><span class="o">.</span><span class="n">export</span><span class="o">.</span><span class="n">shape_poly</span><span class="o">.</span><span class="n">InconclusiveDimensionOperation</span><span class="p">:</span> <span class="n">Symbolic</span> <span class="n">dimension</span> <span class="n">comparison</span> <span class="s1">&#39;a + 1&#39;</span> <span class="o">&gt;=</span> <span class="s1">&#39;b&#39;</span> <span class="ow">is</span> <span class="n">inconclusive</span><span class="o">.</span>
<span class="n">This</span> <span class="n">error</span> <span class="n">arises</span> <span class="k">for</span> <span class="n">comparison</span> <span class="n">operations</span> <span class="k">with</span> <span class="n">shapes</span> <span class="n">that</span>
<span class="n">are</span> <span class="n">non</span><span class="o">-</span><span class="n">constant</span><span class="p">,</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">result</span> <span class="n">of</span> <span class="n">the</span> <span class="n">operation</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">represented</span> <span class="k">as</span>
<span class="n">a</span> <span class="n">boolean</span> <span class="n">value</span> <span class="k">for</span> <span class="nb">all</span> <span class="n">values</span> <span class="n">of</span> <span class="n">the</span> <span class="n">symbolic</span> <span class="n">dimensions</span> <span class="n">involved</span><span class="o">.</span>

</pre></div>
</div>
<p>If you do get a <code class="docutils literal notranslate"><span class="pre">InconclusiveDimensionOperation</span></code>, you can try
several strategies:</p>
<ul class="simple">
<li><p>If your code uses the built-in <code class="docutils literal notranslate"><span class="pre">max</span></code> or <code class="docutils literal notranslate"><span class="pre">min</span></code>, or the
<code class="docutils literal notranslate"><span class="pre">np.max</span></code> or <code class="docutils literal notranslate"><span class="pre">np.min</span></code> then you can replace those with
<code class="docutils literal notranslate"><span class="pre">core.max_dim</span></code> and <code class="docutils literal notranslate"><span class="pre">core.min_dim</span></code>, which have the effect
of delaying the inequality comparison to the compilation
time, when shapes become known.</p></li>
<li><p>Try to rewrite conditionals using <code class="docutils literal notranslate"><span class="pre">core.max_dim</span></code> and
<code class="docutils literal notranslate"><span class="pre">core.min_dim</span></code>, e.g., instead of <code class="docutils literal notranslate"><span class="pre">d</span> <span class="pre">if</span> <span class="pre">d</span> <span class="pre">&gt;</span> <span class="pre">0</span> <span class="pre">else</span> <span class="pre">0</span></code>
you can write <code class="docutils literal notranslate"><span class="pre">core.max_dim(d,</span> <span class="pre">0)</span></code>.</p></li>
<li><p>Try to rewrite the code to be less dependent on the fact
that dimensions should be integers, and rely on the fact
that symbolic dimensions duck-type as integers for most
arithmetic operations. E.g., instead of <code class="docutils literal notranslate"><span class="pre">int(d)</span> <span class="pre">+</span> <span class="pre">5</span></code> write
<code class="docutils literal notranslate"><span class="pre">d</span> <span class="pre">+</span> <span class="pre">5</span></code>.</p></li>
<li><p>Specify symbolic constraints, as explained below.</p></li>
</ul>
<section id="user-specified-symbolic-constraints">
<h4>User-specified symbolic constraints<a class="headerlink" href="#user-specified-symbolic-constraints" title="Link to this heading">#</a></h4>
<p>By default, JAX assumes that all dimension variables range
over values greater-or-equal to 1, and it tries to derive
other simple inequalities from that, e.g.:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">+</span> <span class="pre">2</span> <span class="pre">&gt;=</span> <span class="pre">3</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">*</span> <span class="pre">2</span> <span class="pre">&gt;=</span> <span class="pre">1</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">+</span> <span class="pre">b</span> <span class="pre">+</span> <span class="pre">c</span> <span class="pre">&gt;=</span> <span class="pre">3</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">//</span> <span class="pre">4</span> <span class="pre">&gt;=</span> <span class="pre">0</span></code>, <code class="docutils literal notranslate"><span class="pre">a**2</span> <span class="pre">&gt;=</span> <span class="pre">1</span></code>, and so on.</p></li>
</ul>
<p>You can avoid some inequality comparison failures if you
change the symbolic shape specifications to add <strong>implicit</strong> constraints
for dimension sizes. E.g.,</p>
<ul class="simple">
<li><p>You can use <code class="docutils literal notranslate"><span class="pre">2*b</span></code> for a dimension to constrain it to be even and greater or equal
to 2.</p></li>
<li><p>You can use <code class="docutils literal notranslate"><span class="pre">b</span> <span class="pre">+</span> <span class="pre">15</span></code> for a dimension to constrain it to
be at least 16. E.g., the following code would fail without
the <code class="docutils literal notranslate"><span class="pre">+</span> <span class="pre">15</span></code> part, because JAX will want to verify that slice sizes
are at most as large as the axis size.</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">_</span> <span class="o">=</span> <span class="n">export</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">16</span><span class="p">]))(</span>
<span class="gp">... </span>   <span class="n">jax</span><span class="o">.</span><span class="n">ShapeDtypeStruct</span><span class="p">(</span><span class="n">export</span><span class="o">.</span><span class="n">symbolic_shape</span><span class="p">(</span><span class="s2">&quot;b + 15&quot;</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>

</pre></div>
</div>
<p>Such implicit symbolic constraints are used for deciding comparisons and are
checked at compile time, as explained <a class="reference internal" href="#shape-assertion-errors">below</a>.</p>
<p>You can also specify <strong>explicit</strong> symbolic constraints:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Introduce dimension variable with constraints.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">export</span><span class="o">.</span><span class="n">symbolic_shape</span><span class="p">(</span><span class="s2">&quot;a, b&quot;</span><span class="p">,</span>
<span class="gp">... </span>                             <span class="n">constraints</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;a &gt;= b&quot;</span><span class="p">,</span> <span class="s2">&quot;b &gt;= 16&quot;</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">_</span> <span class="o">=</span> <span class="n">export</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[:</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:</span><span class="mi">16</span><span class="p">]))(</span>
<span class="gp">... </span>   <span class="n">jax</span><span class="o">.</span><span class="n">ShapeDtypeStruct</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>

</pre></div>
</div>
<p>The constraints form a conjunction together with the implicit
constraints. You can specify <code class="docutils literal notranslate"><span class="pre">&gt;=</span></code>, <code class="docutils literal notranslate"><span class="pre">&lt;=</span></code>, and <code class="docutils literal notranslate"><span class="pre">==</span></code> constraints.
At the moment, JAX has limited support for reasoning with
symbolic constraints:</p>
<ul class="simple">
<li><p>You get the most from constraints of the form
of a variable being greater-or-equal or
less-or-equal to a constant.
For example, from the constraints that
<code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">&gt;=</span> <span class="pre">16</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span> <span class="pre">&gt;=</span> <span class="pre">8</span></code> we can infer
that <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">+</span> <span class="pre">2*b</span> <span class="pre">&gt;=</span> <span class="pre">32</span></code>.</p></li>
<li><p>You get limited power when the constraint involves
more complex expressions, e.g., from <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">&gt;=</span> <span class="pre">b</span> <span class="pre">+</span> <span class="pre">8</span></code> we
can infer that <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">-</span> <span class="pre">b</span> <span class="pre">&gt;=</span> <span class="pre">8</span></code> but not that <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">&gt;=</span> <span class="pre">9</span></code>.
We may improve somewhat this area in the future.</p></li>
<li><p>Equality constraints are treated as rewrite rules:
whenever the symbolic expression on the left of <code class="docutils literal notranslate"><span class="pre">==</span></code>
is encountered, it is rewritten to the expression on
the right.
E.g., <code class="docutils literal notranslate"><span class="pre">floordiv(a,</span> <span class="pre">b)</span> <span class="pre">==</span> <span class="pre">c</span></code> works by replacing all
occurrences of <code class="docutils literal notranslate"><span class="pre">floordiv(a,</span> <span class="pre">b)</span></code> with <code class="docutils literal notranslate"><span class="pre">c</span></code>.
Equality constraints must not contain addition or
subtraction at the top-level on the left-hand-side. Examples of
valid left-hand-sides are <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">*</span> <span class="pre">b</span></code>, or <code class="docutils literal notranslate"><span class="pre">4</span> <span class="pre">*</span> <span class="pre">a</span></code>, or
<code class="docutils literal notranslate"><span class="pre">floordiv(a</span> <span class="pre">+</span> <span class="pre">c,</span> <span class="pre">b)</span></code>.</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Introduce dimension variable with equality constraints.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">export</span><span class="o">.</span><span class="n">symbolic_shape</span><span class="p">(</span><span class="s2">&quot;a, b, c, d&quot;</span><span class="p">,</span>
<span class="gp">... </span>                                   <span class="n">constraints</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;a * b == c + d&quot;</span><span class="p">,))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="mi">2</span> <span class="o">*</span> <span class="n">b</span> <span class="o">*</span> <span class="n">a</span>
<span class="go">2*d + 2*c</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">*</span> <span class="n">b</span> <span class="o">*</span> <span class="n">b</span>
<span class="go">b*d + b*c</span>

</pre></div>
</div>
<p>The symbolic constraints can also help to work around the
limitations in the JAX reasoning mechanisms.
For example, in the code below JAX will attempt to prove that
the slice size <code class="docutils literal notranslate"><span class="pre">x.shape[0]</span> <span class="pre">%</span> <span class="pre">3</span></code>, which is the symbolic expression
<code class="docutils literal notranslate"><span class="pre">mod(b,</span> <span class="pre">3)</span></code>, is less or equal to the axis size, which is <code class="docutils literal notranslate"><span class="pre">b</span></code>.
This happens to be true for all strictly positive values of
<code class="docutils literal notranslate"><span class="pre">b</span></code>, but it is not something JAX’s symbolic comparison rules
can prove. Hence, the following code raises an error:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">lax</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">b</span><span class="p">,</span> <span class="o">=</span> <span class="n">export</span><span class="o">.</span><span class="n">symbolic_shape</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">lax</span><span class="o">.</span><span class="n">slice_in_dim</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="mi">3</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">export</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">f</span><span class="p">))(</span>
<span class="o">...</span>     <span class="n">jax</span><span class="o">.</span><span class="n">ShapeDtypeStruct</span><span class="p">((</span><span class="n">b</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>  <span class="c1"># doctest: +IGNORE_EXCEPTION_DETAIL</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
<span class="n">jax</span><span class="o">.</span><span class="n">_src</span><span class="o">.</span><span class="n">export</span><span class="o">.</span><span class="n">shape_poly</span><span class="o">.</span><span class="n">InconclusiveDimensionOperation</span><span class="p">:</span> <span class="n">Symbolic</span> <span class="n">dimension</span> <span class="n">comparison</span> <span class="s1">&#39;b&#39;</span> <span class="o">&gt;=</span> <span class="s1">&#39;mod(b, 3)&#39;</span> <span class="ow">is</span> <span class="n">inconclusive</span><span class="o">.</span>
<span class="n">This</span> <span class="n">error</span> <span class="n">arises</span> <span class="k">for</span> <span class="n">comparison</span> <span class="n">operations</span> <span class="k">with</span> <span class="n">shapes</span> <span class="n">that</span>
<span class="n">are</span> <span class="n">non</span><span class="o">-</span><span class="n">constant</span><span class="p">,</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">result</span> <span class="n">of</span> <span class="n">the</span> <span class="n">operation</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">represented</span> <span class="k">as</span>
<span class="n">a</span> <span class="n">boolean</span> <span class="n">value</span> <span class="k">for</span> <span class="nb">all</span> <span class="n">values</span> <span class="n">of</span> <span class="n">the</span> <span class="n">symbolic</span> <span class="n">dimensions</span> <span class="n">involved</span><span class="o">.</span>

</pre></div>
</div>
<p>One option here would be to restrict the code to work only on
axis sizes that are multiple of <code class="docutils literal notranslate"><span class="pre">3</span></code> (by replacing
<code class="docutils literal notranslate"><span class="pre">b</span></code> with <code class="docutils literal notranslate"><span class="pre">3*b</span></code> in the shape). Then, JAX would be able
to simplify the modulo operation <code class="docutils literal notranslate"><span class="pre">mod(3*b,</span> <span class="pre">3)</span></code> to <code class="docutils literal notranslate"><span class="pre">0</span></code>.
Another option is to add a symbolic constraint
with the exact inconclusive inequality that JAX
is attempting to prove:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">b</span><span class="p">,</span> <span class="o">=</span> <span class="n">export</span><span class="o">.</span><span class="n">symbolic_shape</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span>
<span class="gp">... </span>                           <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;b &gt;= mod(b, 3)&quot;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">lax</span><span class="o">.</span><span class="n">slice_in_dim</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="mi">3</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">_</span> <span class="o">=</span> <span class="n">export</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">f</span><span class="p">))(</span>
<span class="gp">... </span>    <span class="n">jax</span><span class="o">.</span><span class="n">ShapeDtypeStruct</span><span class="p">((</span><span class="n">b</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>

</pre></div>
</div>
<p>Just like the implicit constraints, the explicit
symbolic constraints are checked at compile time,
using the same mechanism as explained <a class="reference internal" href="#shape-assertion-errors">below</a>.</p>
</section>
<section id="symbolic-dimension-scopes">
<h4>Symbolic dimension scopes<a class="headerlink" href="#symbolic-dimension-scopes" title="Link to this heading">#</a></h4>
<p>The symbolic constraints are stored in αn
<a class="reference internal" href="../_autosummary/jax.export.SymbolicScope.html#jax.export.SymbolicScope" title="jax.export.SymbolicScope"><code class="xref py py-class docutils literal notranslate"><span class="pre">jax.export.SymbolicScope</span></code></a> object, which is created implicitly
for each call to <code class="xref py py-func docutils literal notranslate"><span class="pre">jax.export.symbolic_shapes()</span></code>. You must be careful
to not mix symbolic expressions that use different scopes.
For example,
the following code will fail because <code class="docutils literal notranslate"><span class="pre">a1</span></code> and <code class="docutils literal notranslate"><span class="pre">a2</span></code>
use different scopes (created by different invocations of
<a class="reference internal" href="../_autosummary/jax.export.symbolic_shape.html#jax.export.symbolic_shape" title="jax.export.symbolic_shape"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.export.symbolic_shape()</span></code></a>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a1</span><span class="p">,</span> <span class="o">=</span> <span class="n">export</span><span class="o">.</span><span class="n">symbolic_shape</span><span class="p">(</span><span class="s2">&quot;a,&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a2</span><span class="p">,</span> <span class="o">=</span> <span class="n">export</span><span class="o">.</span><span class="n">symbolic_shape</span><span class="p">(</span><span class="s2">&quot;a,&quot;</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;a &gt;= 8&quot;</span><span class="p">,))</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">a1</span> <span class="o">+</span> <span class="n">a2</span>  
<span class="gt">Traceback (most recent call last):</span>
<span class="gr">ValueError</span>: <span class="n">Invalid mixing of symbolic scopes for linear combination.</span>
<span class="x">Expected  scope 4776451856 created at &lt;doctest shape_poly.md[31]&gt;:1:6 (&lt;module&gt;)</span>
<span class="x">and found for &#39;a&#39; (unknown) scope 4776979920 created at &lt;doctest shape_poly.md[32]&gt;:1:6 (&lt;module&gt;) with constraints:</span>
<span class="x">  a &gt;= 8</span>
</pre></div>
</div>
<p>The symbolic expressions that originate from a single call
to <a class="reference internal" href="../_autosummary/jax.export.symbolic_shape.html#jax.export.symbolic_shape" title="jax.export.symbolic_shape"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.export.symbolic_shape()</span></code></a> share a scope and
can be mixed up in arithmetic operations. The result would
also share the same scope.</p>
<p>You can reuse scopes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="p">,</span> <span class="o">=</span> <span class="n">export</span><span class="o">.</span><span class="n">symbolic_shape</span><span class="p">(</span><span class="s2">&quot;a,&quot;</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;a &gt;= 8&quot;</span><span class="p">,))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span><span class="p">,</span> <span class="o">=</span> <span class="n">export</span><span class="o">.</span><span class="n">symbolic_shape</span><span class="p">(</span><span class="s2">&quot;b,&quot;</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">scope</span><span class="p">)</span>  <span class="c1"># Reuse the scope of `a`</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span>  <span class="c1"># Allowed</span>
<span class="go">b + a</span>

</pre></div>
</div>
<p>You can also create scopes explicitly:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">my_scope</span> <span class="o">=</span> <span class="n">export</span><span class="o">.</span><span class="n">SymbolicScope</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="p">,</span> <span class="o">=</span> <span class="n">export</span><span class="o">.</span><span class="n">symbolic_shape</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">my_scope</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">d</span><span class="p">,</span> <span class="o">=</span> <span class="n">export</span><span class="o">.</span><span class="n">symbolic_shape</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">my_scope</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">+</span> <span class="n">d</span>  <span class="c1"># Allowed</span>
<span class="go">d + c</span>

</pre></div>
</div>
<p>JAX tracing uses caches keyed partially by shapes, and
symbolic shapes that are printed identically will be considered
distinct if they use different scopes.</p>
</section>
</section>
<section id="caveat-for-equality-comparisons">
<h3>Caveat for equality comparisons<a class="headerlink" href="#caveat-for-equality-comparisons" title="Link to this heading">#</a></h3>
<p>The equality comparison returns <code class="docutils literal notranslate"><span class="pre">False</span></code> for <code class="docutils literal notranslate"><span class="pre">b</span> <span class="pre">+</span> <span class="pre">1</span> <span class="pre">==</span> <span class="pre">b</span></code> or <code class="docutils literal notranslate"><span class="pre">b</span> <span class="pre">==</span> <span class="pre">0</span></code>
(in which case it is certain that the dimensions are different for all values
of the dimension variables),
but also for <code class="docutils literal notranslate"><span class="pre">b</span> <span class="pre">==</span> <span class="pre">1</span></code> and for <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">==</span> <span class="pre">b</span></code>. This is unsound, and we
ought to raise <code class="docutils literal notranslate"><span class="pre">core.InconclusiveDimensionOperation</span></code> because under
some valuations the result should be <code class="docutils literal notranslate"><span class="pre">True</span></code> and under other
valuations it should be <code class="docutils literal notranslate"><span class="pre">False</span></code>. We choose to make equality total
thus allowing unsoundness because otherwise we may get spurious errors
in presence of hash collisions
when hashing dimension expressions or objects that include
them (shapes, <code class="docutils literal notranslate"><span class="pre">core.AbstractValue</span></code>, <code class="docutils literal notranslate"><span class="pre">core.Jaxpr</span></code>).
Besides the hashing errors, a partial semantics of equality
leads to errors for the following expressions <code class="docutils literal notranslate"><span class="pre">b</span> <span class="pre">==</span> <span class="pre">a</span> <span class="pre">or</span> <span class="pre">b</span> <span class="pre">==</span> <span class="pre">b</span></code> or <code class="docutils literal notranslate"><span class="pre">b</span> <span class="pre">in</span> <span class="pre">[a,</span> <span class="pre">b]</span></code>
even though the error is avoided if we change the order of the comparisons.</p>
<p>Code of the form <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">x.shape[0]</span> <span class="pre">!=</span> <span class="pre">1:</span> <span class="pre">raise</span> <span class="pre">NiceErrorMessage</span></code> is sound even
with this treatment of equality, but code of the form <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">x.shape[0]</span> <span class="pre">!=</span> <span class="pre">1:</span> <span class="pre">return</span> <span class="pre">1</span></code>
is unsound.</p>
</section>
<section id="dimension-variables-must-be-solvable-from-the-input-shapes">
<h3>Dimension variables must be solvable from the input shapes<a class="headerlink" href="#dimension-variables-must-be-solvable-from-the-input-shapes" title="Link to this heading">#</a></h3>
<p>Currently, the only way to pass the values of dimension variables
when an exported object is invoked is indirectly through the shapes
of the array arguments. E.g., the value of <code class="docutils literal notranslate"><span class="pre">b</span></code> can be inferred at the
call site from the shape of the first argument of type <code class="docutils literal notranslate"><span class="pre">f32[b]</span></code>.
This works well for most use cases, and
it mirrors the calling convention of JIT functions.</p>
<p>Sometimes you may want to export a function parameterized
by an integer value that determines some shapes in the program.
For example, we may
want to export the function <code class="docutils literal notranslate"><span class="pre">my_top_k</span></code> defined below,
parameterized by the
value of <code class="docutils literal notranslate"><span class="pre">k</span></code>, which determines the shape of the result.
The following attempt will lead to an error since the dimension
variable <code class="docutils literal notranslate"><span class="pre">k</span></code> cannot be derived from the shape of the input <code class="docutils literal notranslate"><span class="pre">x:</span> <span class="pre">i32[4,</span> <span class="pre">10]</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">my_top_k</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>  <span class="c1"># x: i32[4, 10], k &lt;= 10</span>
<span class="gp">... </span>  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">top_k</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># : i32[4, 3]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Export with static `k=3`. Since `k` appears in shapes it must be in `static_argnums`.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">exp_static_k</span> <span class="o">=</span> <span class="n">export</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">my_top_k</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="mi">0</span><span class="p">))(</span><span class="mi">3</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">exp_static_k</span><span class="o">.</span><span class="n">in_avals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="go">ShapedArray(int32[4,10])</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">exp_static_k</span><span class="o">.</span><span class="n">out_avals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="go">ShapedArray(int32[4,3])</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># When calling the exported function we pass only the non-static arguments</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">exp_static_k</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="go">Array([[ 9,  8,  7],</span>
<span class="go">       [19, 18, 17],</span>
<span class="go">       [29, 28, 27],</span>
<span class="go">       [39, 38, 37]], dtype=int32)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Now attempt to export with symbolic `k` so that we choose `k` after export.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">k</span><span class="p">,</span> <span class="o">=</span> <span class="n">export</span><span class="o">.</span><span class="n">symbolic_shape</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;k &lt;= 10&quot;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">export</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">my_top_k</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="mi">0</span><span class="p">))(</span><span class="n">k</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>  
<span class="gt">Traceback (most recent call last):</span>
<span class="gr">UnexpectedDimVar</span>: <span class="n">&quot;Encountered dimension variable &#39;k&#39; that is not appearing in the shapes of the function arguments</span>

</pre></div>
</div>
<p>In the future, we may add an additional mechanism to pass the values of
dimension variables, besides implicitly through the input shapes.
Meanwhile, the workaround for the above use case is to replace the
function parameter <code class="docutils literal notranslate"><span class="pre">k</span></code> with an array of shape <code class="docutils literal notranslate"><span class="pre">(0,</span> <span class="pre">k)</span></code>, so that
<code class="docutils literal notranslate"><span class="pre">k</span></code> can be derived from the input shape of an array.
The first dimension is 0 to ensure that the whole array is empty
and there is no performance penalty when we call the exported function.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">my_top_k_with_dimensions</span><span class="p">(</span><span class="n">dimensions</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>  <span class="c1"># dimensions: i32[0, k], x: i32[4, 10]</span>
<span class="gp">... </span>  <span class="k">return</span> <span class="n">my_top_k</span><span class="p">(</span><span class="n">dimensions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">exp</span> <span class="o">=</span> <span class="n">export</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">my_top_k_with_dimensions</span><span class="p">))(</span>
<span class="gp">... </span>    <span class="n">jax</span><span class="o">.</span><span class="n">ShapeDtypeStruct</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
<span class="gp">... </span>    <span class="n">x</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">exp</span><span class="o">.</span><span class="n">in_avals</span>
<span class="go">(ShapedArray(int32[0,k]), ShapedArray(int32[4,10]))</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">exp</span><span class="o">.</span><span class="n">out_avals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="go">ShapedArray(int32[4,k])</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># When we invoke `exp` we must construct and pass an array of shape (0, k)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">exp</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">x</span><span class="p">)</span>
<span class="go">Array([[ 9,  8,  7],</span>
<span class="go">       [19, 18, 17],</span>
<span class="go">       [29, 28, 27],</span>
<span class="go">       [39, 38, 37]], dtype=int32)</span>

</pre></div>
</div>
<p>Another situation when you may get an error is when some dimension
variables do appear in the input shapes, but in a non-linear
expression that JAX cannot currently solve:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="p">,</span> <span class="o">=</span> <span class="n">export</span><span class="o">.</span><span class="n">symbolic_shape</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">export</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))(</span>
<span class="gp">... </span>   <span class="n">jax</span><span class="o">.</span><span class="n">ShapeDtypeStruct</span><span class="p">((</span><span class="n">a</span> <span class="o">*</span> <span class="n">a</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>  
<span class="gt">Traceback (most recent call last):</span>
<span class="gr">ValueError</span>: <span class="n">Cannot solve for values of dimension variables {&#39;a&#39;}.</span>
<span class="x">We can only solve linear uni-variate constraints.</span>
<span class="x">Using the following polymorphic shapes specifications: args[0].shape = (a^2,).</span>
<span class="x">Unprocessed specifications: &#39;a^2&#39; for dimension size args[0].shape[0].</span>

</pre></div>
</div>
</section>
<section id="shape-assertion-errors">
<h3>Shape assertion errors<a class="headerlink" href="#shape-assertion-errors" title="Link to this heading">#</a></h3>
<p>JAX assumes that dimension variables range over strictly positive integers,
and this assumption is checked when the code is compiled for concrete
input shapes.</p>
<p>For example, given the symbolic input shape <code class="docutils literal notranslate"><span class="pre">(b,</span> <span class="pre">b,</span> <span class="pre">2*d)</span></code>,
JAX will generate code to check the following assertions when
invoked with actual argument <code class="docutils literal notranslate"><span class="pre">arg</span></code>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">arg.shape[0]</span> <span class="pre">&gt;=</span> <span class="pre">1</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">arg.shape[1]</span> <span class="pre">==</span> <span class="pre">arg.shape[0]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">arg.shape[2]</span> <span class="pre">%</span> <span class="pre">2</span> <span class="pre">==</span> <span class="pre">0</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">arg.shape[2]</span> <span class="pre">//</span> <span class="pre">2</span> <span class="pre">&gt;=</span> <span class="pre">1</span></code></p></li>
</ul>
<p>For example, here is the error we get when we call the exported
on an argument of shape <code class="docutils literal notranslate"><span class="pre">(3,</span> <span class="pre">3,</span> <span class="pre">5)</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>  <span class="c1"># x: f32[b, b, 2*d]</span>
<span class="gp">... </span>  <span class="k">return</span> <span class="n">x</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">exp</span> <span class="o">=</span> <span class="n">export</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">f</span><span class="p">))(</span>
<span class="gp">... </span>    <span class="n">jax</span><span class="o">.</span><span class="n">ShapeDtypeStruct</span><span class="p">(</span><span class="n">export</span><span class="o">.</span><span class="n">symbolic_shape</span><span class="p">(</span><span class="s2">&quot;b, b, 2*d&quot;</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>   
<span class="gp">&gt;&gt;&gt; </span><span class="n">exp</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>  
<span class="gt">Traceback (most recent call last):</span>
<span class="gr">ValueError</span>: <span class="n">Input shapes do not match the polymorphic shapes specification.</span>
<span class="x">Division had remainder 1 when computing the value of &#39;d&#39;.</span>
<span class="x">Using the following polymorphic shapes specifications:</span>
<span class="x">  args[0].shape = (b, b, 2*d).</span>
<span class="x">Obtained dimension variables: &#39;b&#39; = 3 from specification &#39;b&#39; for dimension args[0].shape[0] (= 3), .</span>
<span class="x">Please see https://docs.jax.dev/en/latest/export/shape_poly.html#shape-assertion-errors for more details.</span>

</pre></div>
</div>
<p>These errors arise in a pre-processing step before the
compilation.</p>
</section>
</section>
<section id="debugging">
<span id="shape-poly-debugging"></span><h2>Debugging<a class="headerlink" href="#debugging" title="Link to this heading">#</a></h2>
<p>First, see the <a class="reference internal" href="export.html#export-debugging"><span class="std std-ref">Debugging</span></a> documentation.
Additionally, you can debug the shape refinement, which is
invoked at compilation time for modules that have dimension variables or multi-platform
support.</p>
<p>If there is an error during shape refinement, you can set the <code class="docutils literal notranslate"><span class="pre">JAX_DUMP_IR_TO</span></code>
environment variable to see a dump of the HLO module before
shape refinement (named <code class="docutils literal notranslate"><span class="pre">..._before_refine_polymorphic_shapes.mlir</span></code>).
This module should already have static input shapes.</p>
<p>To enable the logging of all stages of shape refinement you can set the
environment variable <code class="docutils literal notranslate"><span class="pre">TF_CPP_VMODULE=refine_polymorphic_shapes=3</span></code> in OSS
(inside Google, you pass <code class="docutils literal notranslate"><span class="pre">--vmodule=refine_polymorphic_shapes=3</span></code>):</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># Log from python</span>
<span class="nv">JAX_DUMP_IR_TO</span><span class="o">=</span>/tmp/export.dumps/<span class="w"> </span><span class="nv">TF_CPP_VMODULE</span><span class="o">=</span><span class="nv">refine_polymorphic_shapes</span><span class="o">=</span><span class="m">3</span><span class="w"> </span>python<span class="w"> </span>tests/shape_poly_test.py<span class="w"> </span>ShapePolyTest.test_simple_unary<span class="w"> </span>-v<span class="o">=</span><span class="m">3</span>
</pre></div>
</div>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="export.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Exporting and serializing staged-out computations</p>
      </div>
    </a>
    <a class="right-next"
       href="jax2tf.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Interoperation with TensorFlow</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#correctness-of-shape-polymorphism">Correctness of shape polymorphism</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#computing-with-dimension-variables">Computing with dimension variables</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#errors-in-presence-of-shape-polymorphism">Errors in presence of shape polymorphism</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparison-of-symbolic-dimensions-is-partially-supported">Comparison of symbolic dimensions is partially supported</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#user-specified-symbolic-constraints">User-specified symbolic constraints</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#symbolic-dimension-scopes">Symbolic dimension scopes</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#caveat-for-equality-comparisons">Caveat for equality comparisons</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dimension-variables-must-be-solvable-from-the-input-shapes">Dimension variables must be solvable from the input shapes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#shape-assertion-errors">Shape assertion errors</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#debugging">Debugging</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The JAX authors
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024, The JAX Authors.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>