
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Gradient checkpointing with jax.checkpoint (jax.remat) &#8212; JAX  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="_static/style.css?v=7143c0a5" />
    <link rel="stylesheet" href="_static/style.css" type="text/css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=30646c52"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'gradient-checkpointing';</script>
    <link rel="icon" href="_static/favicon.png"/>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Ahead-of-time lowering and compilation" href="aot.html" />
    <link rel="prev" title="Foreign function interface (FFI)" href="ffi.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/jax_logo_250px.png" class="logo__image only-light" alt="JAX  documentation - Home"/>
    <script>document.write(`<img src="_static/jax_logo_250px.png" class="logo__image only-dark" alt="JAX  documentation - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="notebooks/thinking_in_jax.html">Quickstart: How to think in JAX</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="notebooks/Common_Gotchas_in_JAX.html">🔪 JAX - The Sharp Bits 🔪</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="tutorials.html">Tutorials</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="jit-compilation.html">Just-in-time compilation</a></li>
<li class="toctree-l2"><a class="reference internal" href="automatic-vectorization.html">Automatic vectorization</a></li>
<li class="toctree-l2"><a class="reference internal" href="automatic-differentiation.html">Automatic differentiation</a></li>
<li class="toctree-l2"><a class="reference internal" href="random-numbers.html">Pseudorandom numbers</a></li>
<li class="toctree-l2"><a class="reference internal" href="stateful-computations.html">Stateful computations</a></li>
<li class="toctree-l2"><a class="reference internal" href="control-flow.html">Control flow and logical operators with JIT</a></li>
<li class="toctree-l2"><a class="reference internal" href="pytrees.html">Pytrees</a></li>
<li class="toctree-l2"><a class="reference internal" href="working-with-pytrees.html">Working with pytrees</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Resources, guides, and references</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="key-concepts.html">Key concepts</a></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="advanced_guides.html">Resources and Advanced Guides</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="notebooks/autodiff_cookbook.html">The Autodiff Cookbook</a></li>
<li class="toctree-l2"><a class="reference internal" href="notebooks/Custom_derivative_rules_for_Python_code.html">Custom derivative rules</a></li>
<li class="toctree-l2"><a class="reference internal" href="notebooks/autodiff_remat.html">Control autodiff’s saved values with <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code> (aka <code class="docutils literal notranslate"><span class="pre">jax.remat</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced-autodiff.html">Advanced automatic differentiation</a></li>
<li class="toctree-l2"><a class="reference internal" href="errors.html">Errors</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="debugging.html">Introduction to debugging</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="debugging/print_breakpoint.html">Compiled prints and breakpoints</a></li>
<li class="toctree-l3"><a class="reference internal" href="debugging/checkify_guide.html">The <code class="docutils literal notranslate"><span class="pre">checkify</span></code> transformation</a></li>
<li class="toctree-l3"><a class="reference internal" href="debugging/flags.html">JAX debugging flags</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="debugging/flags.html">JAX debugging flags</a></li>
<li class="toctree-l2"><a class="reference internal" href="transfer_guard.html">Transfer guard</a></li>
<li class="toctree-l2"><a class="reference internal" href="persistent_compilation_cache.html">Persistent compilation cache</a></li>
<li class="toctree-l2"><a class="reference internal" href="gpu_performance_tips.html">GPU performance tips</a></li>
<li class="toctree-l2"><a class="reference internal" href="profiling.html">Profiling computation</a></li>
<li class="toctree-l2"><a class="reference internal" href="device_memory_profiling.html">Profiling device memory</a></li>
<li class="toctree-l2"><a class="reference internal" href="notebooks/Distributed_arrays_and_automatic_parallelization.html">Distributed arrays and automatic parallelization</a></li>
<li class="toctree-l2"><a class="reference internal" href="notebooks/explicit-sharding.html">Explicit sharding (a.k.a. “sharding in types”)</a></li>
<li class="toctree-l2"><a class="reference internal" href="notebooks/shard_map.html">Manual parallelism with <code class="docutils literal notranslate"><span class="pre">shard_map</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="notebooks/layout.html">Device-local array layout control</a></li>
<li class="toctree-l2"><a class="reference internal" href="notebooks/host-offloading.html">JAX Memories and Host Offloading</a></li>

<li class="toctree-l2"><a class="reference internal" href="multi_process.html">Introduction to multi-controller JAX (aka multi-process/multi-host JAX)</a></li>
<li class="toctree-l2"><a class="reference internal" href="distributed_data_loading.html">Distributed data loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="external-callbacks.html">External callbacks</a></li>
<li class="toctree-l2"><a class="reference internal" href="ffi.html">Foreign function interface (FFI)</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Gradient checkpointing with <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code> (<code class="docutils literal notranslate"><span class="pre">jax.remat</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="aot.html">Ahead-of-time lowering and compilation</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="export/index.html">Exporting and serialization</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="export/export.html">Exporting and serializing staged-out computations</a></li>
<li class="toctree-l3"><a class="reference internal" href="export/shape_poly.html">Shape polymorphism</a></li>
<li class="toctree-l3"><a class="reference internal" href="export/jax2tf.html">Interoperation with TensorFlow</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="type_promotion.html">Type promotion semantics</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="pallas/index.html">Pallas: a JAX kernel language</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="pallas/quickstart.html">Pallas Quickstart</a></li>
<li class="toctree-l3"><a class="reference internal" href="pallas/pipelining.html">Software Pipelining</a></li>
<li class="toctree-l3"><a class="reference internal" href="pallas/grid_blockspec.html">Grids and BlockSpecs</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="pallas/tpu/index.html">Pallas TPU</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="pallas/tpu/details.html">Writing TPU kernels with Pallas</a></li>
<li class="toctree-l4"><a class="reference internal" href="pallas/tpu/pipelining.html">TPU Pipelining</a></li>
<li class="toctree-l4"><a class="reference internal" href="pallas/tpu/matmul.html">Matrix Multiplication</a></li>
<li class="toctree-l4"><a class="reference internal" href="pallas/tpu/sparse.html">Scalar Prefetch and Block-Sparse Computation</a></li>
<li class="toctree-l4"><a class="reference internal" href="pallas/tpu/distributed.html">Distributed Computing in Pallas for TPUs</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="pallas/gpu/index.html">Pallas:Mosaic GPU</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="pallas/gpu/reference.html">Writing Mosaic GPU kernels with Pallas</a></li>
<li class="toctree-l4"><a class="reference internal" href="pallas/gpu/pipelining.html">Mosaic GPU Pipelining</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="pallas/design/index.html">Pallas Design Notes</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="pallas/design/design.html">Pallas Design</a></li>
<li class="toctree-l4"><a class="reference internal" href="pallas/design/async_note.html">Pallas Async Operations</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="pallas/CHANGELOG.html">Pallas Changelog</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="notebooks/neural_network_with_tfds_data.html">Training a simple neural network, with tensorflow/datasets data loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="notebooks/Neural_Network_and_Data_Loading.html">Training a simple neural network, with PyTorch data loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="notebooks/vmapped_log_probs.html">Autobatching for Bayesian inference</a></li>
<li class="toctree-l2"><a class="reference internal" href="notebooks/convolutions.html">Generalized convolutions in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="xla_flags.html">XLA compiler flags</a></li>
<li class="toctree-l2"><a class="reference internal" href="sharded-computation.html">Introduction to parallel programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="jax-primitives.html">JAX Internals: primitives</a></li>
<li class="toctree-l2"><a class="reference internal" href="jaxpr.html">JAX internals: The jaxpr language</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="contributor_guide.html">Developer notes</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-9"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="contributing.html">Contributing to JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="developer.html">Building from source</a></li>
<li class="toctree-l2"><a class="reference internal" href="investigating_a_regression.html">Investigating a regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="autodidax.html">Autodidax: JAX core from scratch</a></li>
<li class="toctree-l2"><a class="reference internal" href="autodidax2_part1.html">Autodidax2, part 1: JAX from scratch, again</a></li>

<li class="toctree-l2 has-children"><a class="reference internal" href="jep/index.html">JAX Enhancement Proposals (JEPs)</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-10"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="jep/263-prng.html">263: JAX PRNG Design</a></li>
<li class="toctree-l3"><a class="reference internal" href="jep/2026-custom-derivatives.html">2026: Custom JVP/VJP rules for JAX-transformable functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="jep/4008-custom-vjp-update.html">4008: Custom VJP and `nondiff_argnums` update</a></li>
<li class="toctree-l3"><a class="reference internal" href="jep/4410-omnistaging.html">4410: Omnistaging</a></li>
<li class="toctree-l3"><a class="reference internal" href="jep/9263-typed-keys.html">9263: Typed keys &amp; pluggable RNGs</a></li>
<li class="toctree-l3"><a class="reference internal" href="jep/9407-type-promotion.html">9407: Design of Type Promotion Semantics for JAX</a></li>
<li class="toctree-l3"><a class="reference internal" href="jep/9419-jax-versioning.html">9419: Jax and Jaxlib versioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="jep/10657-sequencing-effects.html">10657: Sequencing side-effects in JAX</a></li>
<li class="toctree-l3"><a class="reference internal" href="jep/11830-new-remat-checkpoint.html">11830: `jax.remat` / `jax.checkpoint` new implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="jep/12049-type-annotations.html">12049: Type Annotation Roadmap for JAX</a></li>
<li class="toctree-l3"><a class="reference internal" href="jep/14273-shard-map.html">14273: `shard_map` (`shmap`) for simple per-device code</a></li>
<li class="toctree-l3"><a class="reference internal" href="jep/15856-jex.html">15856: `jax.extend`, an extensions module</a></li>
<li class="toctree-l3"><a class="reference internal" href="jep/17111-shmap-transpose.html">17111: Efficient transposition of `shard_map` (and other maps)</a></li>
<li class="toctree-l3"><a class="reference internal" href="jep/18137-numpy-scipy-scope.html">18137: Scope of JAX NumPy &amp; SciPy Wrappers</a></li>
<li class="toctree-l3"><a class="reference internal" href="jep/25516-effver.html">25516: Effort-based versioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="jep/28661-jax-array-protocol.html">28661: Supporting the `__jax_array__` protocol</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="extensions.html">Extension guides</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-11"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="notebooks/Writing_custom_interpreters_in_Jax.html">Writing custom Jaxpr interpreters in JAX</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="jax.extend.html"><code class="docutils literal notranslate"><span class="pre">jax.extend</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-12"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="jax.extend.core.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.core</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="jax.extend.linear_util.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.linear_util</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="jax.extend.mlir.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.mlir</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="jax.extend.random.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.random</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="building_on_jax.html">Building on JAX</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="notes.html">Notes</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-13"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="api_compatibility.html">API compatibility</a></li>
<li class="toctree-l2"><a class="reference internal" href="deprecation.html">Python and NumPy version support policy</a></li>
<li class="toctree-l2"><a class="reference internal" href="async_dispatch.html">Asynchronous dispatch</a></li>
<li class="toctree-l2"><a class="reference internal" href="concurrency.html">Concurrency</a></li>
<li class="toctree-l2"><a class="reference internal" href="gpu_memory_allocation.html">GPU memory allocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="rank_promotion_warning.html">Rank promotion warning</a></li>
<li class="toctree-l2"><a class="reference internal" href="type_promotion.html">Type promotion semantics</a></li>
<li class="toctree-l2"><a class="reference internal" href="default_dtypes.html">Default dtypes and the X64 flag</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="jax.html">Public API: <code class="docutils literal notranslate"><span class="pre">jax</span></code> package</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-14"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="jax.numpy.html"><code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-15"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="_autosummary/jax.numpy.fft.fft.html">jax.numpy.fft.fft</a></li>
<li class="toctree-l3"><a class="reference internal" href="_autosummary/jax.numpy.fft.fft2.html">jax.numpy.fft.fft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="_autosummary/jax.numpy.fft.fftfreq.html">jax.numpy.fft.fftfreq</a></li>
<li class="toctree-l3"><a class="reference internal" href="_autosummary/jax.numpy.fft.fftn.html">jax.numpy.fft.fftn</a></li>
<li class="toctree-l3"><a class="reference internal" href="_autosummary/jax.numpy.fft.fftshift.html">jax.numpy.fft.fftshift</a></li>
<li class="toctree-l3"><a class="reference internal" href="_autosummary/jax.numpy.fft.hfft.html">jax.numpy.fft.hfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="_autosummary/jax.numpy.fft.ifft.html">jax.numpy.fft.ifft</a></li>
<li class="toctree-l3"><a class="reference internal" href="_autosummary/jax.numpy.fft.ifft2.html">jax.numpy.fft.ifft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="_autosummary/jax.numpy.fft.ifftn.html">jax.numpy.fft.ifftn</a></li>
<li class="toctree-l3"><a class="reference internal" href="_autosummary/jax.numpy.fft.ifftshift.html">jax.numpy.fft.ifftshift</a></li>
<li class="toctree-l3"><a class="reference internal" href="_autosummary/jax.numpy.fft.ihfft.html">jax.numpy.fft.ihfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="_autosummary/jax.numpy.fft.irfft.html">jax.numpy.fft.irfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="_autosummary/jax.numpy.fft.irfft2.html">jax.numpy.fft.irfft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="_autosummary/jax.numpy.fft.irfftn.html">jax.numpy.fft.irfftn</a></li>
<li class="toctree-l3"><a class="reference internal" href="_autosummary/jax.numpy.fft.rfft.html">jax.numpy.fft.rfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="_autosummary/jax.numpy.fft.rfft2.html">jax.numpy.fft.rfft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="_autosummary/jax.numpy.fft.rfftfreq.html">jax.numpy.fft.rfftfreq</a></li>
<li class="toctree-l3"><a class="reference internal" href="_autosummary/jax.numpy.fft.rfftn.html">jax.numpy.fft.rfftn</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="jax.scipy.html"><code class="docutils literal notranslate"><span class="pre">jax.scipy</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-16"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="_autosummary/jax.scipy.stats.bernoulli.logpmf.html">jax.scipy.stats.bernoulli.logpmf</a></li>
<li class="toctree-l3"><a class="reference internal" href="_autosummary/jax.scipy.stats.bernoulli.pmf.html">jax.scipy.stats.bernoulli.pmf</a></li>
<li class="toctree-l3"><a class="reference internal" href="_autosummary/jax.scipy.stats.bernoulli.cdf.html">jax.scipy.stats.bernoulli.cdf</a></li>
<li class="toctree-l3"><a class="reference internal" href="_autosummary/jax.scipy.stats.bernoulli.ppf.html">jax.scipy.stats.bernoulli.ppf</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="jax.lax.html"><code class="docutils literal notranslate"><span class="pre">jax.lax</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="jax.random.html"><code class="docutils literal notranslate"><span class="pre">jax.random</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="jax.sharding.html"><code class="docutils literal notranslate"><span class="pre">jax.sharding</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="jax.debug.html"><code class="docutils literal notranslate"><span class="pre">jax.debug</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="jax.dlpack.html"><code class="docutils literal notranslate"><span class="pre">jax.dlpack</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="jax.distributed.html"><code class="docutils literal notranslate"><span class="pre">jax.distributed</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="jax.dtypes.html"><code class="docutils literal notranslate"><span class="pre">jax.dtypes</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="jax.ffi.html"><code class="docutils literal notranslate"><span class="pre">jax.ffi</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="jax.flatten_util.html"><code class="docutils literal notranslate"><span class="pre">jax.flatten_util</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="jax.image.html"><code class="docutils literal notranslate"><span class="pre">jax.image</span></code> module</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="jax.nn.html"><code class="docutils literal notranslate"><span class="pre">jax.nn</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-17"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="jax.nn.initializers.html"><code class="docutils literal notranslate"><span class="pre">jax.nn.initializers</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="jax.ops.html"><code class="docutils literal notranslate"><span class="pre">jax.ops</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="jax.profiler.html"><code class="docutils literal notranslate"><span class="pre">jax.profiler</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="jax.stages.html"><code class="docutils literal notranslate"><span class="pre">jax.stages</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="jax.test_util.html"><code class="docutils literal notranslate"><span class="pre">jax.test_util</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="jax.tree.html"><code class="docutils literal notranslate"><span class="pre">jax.tree</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="jax.tree_util.html"><code class="docutils literal notranslate"><span class="pre">jax.tree_util</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="jax.typing.html"><code class="docutils literal notranslate"><span class="pre">jax.typing</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="jax.export.html"><code class="docutils literal notranslate"><span class="pre">jax.export</span></code> module</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="jax.extend.html"><code class="docutils literal notranslate"><span class="pre">jax.extend</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-18"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="jax.extend.core.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.core</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="jax.extend.linear_util.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.linear_util</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="jax.extend.mlir.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.mlir</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="jax.extend.random.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.random</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="jax.example_libraries.html"><code class="docutils literal notranslate"><span class="pre">jax.example_libraries</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-19"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="jax.example_libraries.optimizers.html"><code class="docutils literal notranslate"><span class="pre">jax.example_libraries.optimizers</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="jax.example_libraries.stax.html"><code class="docutils literal notranslate"><span class="pre">jax.example_libraries.stax</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="jax.experimental.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-20" name="toctree-checkbox-20" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-20"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="jax.experimental.checkify.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.checkify</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="jax.experimental.compilation_cache.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.compilation_cache</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="jax.experimental.custom_dce.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.custom_dce</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="jax.experimental.custom_partitioning.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.custom_partitioning</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="jax.experimental.jet.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.jet</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="jax.experimental.key_reuse.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.key_reuse</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="jax.experimental.mesh_utils.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.mesh_utils</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="jax.experimental.multihost_utils.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.multihost_utils</span></code> module</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="jax.experimental.pallas.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.pallas</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-21" name="toctree-checkbox-21" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-21"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="jax.experimental.pallas.mosaic_gpu.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.pallas.mosaic_gpu</span></code> module</a></li>
<li class="toctree-l4"><a class="reference internal" href="jax.experimental.pallas.triton.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.pallas.triton</span></code> module</a></li>
<li class="toctree-l4"><a class="reference internal" href="jax.experimental.pallas.tpu.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.pallas.tpu</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="jax.experimental.pjit.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.pjit</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="jax.experimental.serialize_executable.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.serialize_executable</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="jax.experimental.shard_map.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.shard_map</span></code> module</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="jax.experimental.sparse.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.sparse</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-22" name="toctree-checkbox-22" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-22"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="_autosummary/jax.experimental.sparse.BCOO.html">jax.experimental.sparse.BCOO</a></li>
<li class="toctree-l4"><a class="reference internal" href="_autosummary/jax.experimental.sparse.bcoo_broadcast_in_dim.html">jax.experimental.sparse.bcoo_broadcast_in_dim</a></li>
<li class="toctree-l4"><a class="reference internal" href="_autosummary/jax.experimental.sparse.bcoo_concatenate.html">jax.experimental.sparse.bcoo_concatenate</a></li>
<li class="toctree-l4"><a class="reference internal" href="_autosummary/jax.experimental.sparse.bcoo_dot_general.html">jax.experimental.sparse.bcoo_dot_general</a></li>
<li class="toctree-l4"><a class="reference internal" href="_autosummary/jax.experimental.sparse.bcoo_dot_general_sampled.html">jax.experimental.sparse.bcoo_dot_general_sampled</a></li>
<li class="toctree-l4"><a class="reference internal" href="_autosummary/jax.experimental.sparse.bcoo_dynamic_slice.html">jax.experimental.sparse.bcoo_dynamic_slice</a></li>
<li class="toctree-l4"><a class="reference internal" href="_autosummary/jax.experimental.sparse.bcoo_extract.html">jax.experimental.sparse.bcoo_extract</a></li>
<li class="toctree-l4"><a class="reference internal" href="_autosummary/jax.experimental.sparse.bcoo_fromdense.html">jax.experimental.sparse.bcoo_fromdense</a></li>
<li class="toctree-l4"><a class="reference internal" href="_autosummary/jax.experimental.sparse.bcoo_gather.html">jax.experimental.sparse.bcoo_gather</a></li>
<li class="toctree-l4"><a class="reference internal" href="_autosummary/jax.experimental.sparse.bcoo_multiply_dense.html">jax.experimental.sparse.bcoo_multiply_dense</a></li>
<li class="toctree-l4"><a class="reference internal" href="_autosummary/jax.experimental.sparse.bcoo_multiply_sparse.html">jax.experimental.sparse.bcoo_multiply_sparse</a></li>
<li class="toctree-l4"><a class="reference internal" href="_autosummary/jax.experimental.sparse.bcoo_update_layout.html">jax.experimental.sparse.bcoo_update_layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="_autosummary/jax.experimental.sparse.bcoo_reduce_sum.html">jax.experimental.sparse.bcoo_reduce_sum</a></li>
<li class="toctree-l4"><a class="reference internal" href="_autosummary/jax.experimental.sparse.bcoo_reshape.html">jax.experimental.sparse.bcoo_reshape</a></li>
<li class="toctree-l4"><a class="reference internal" href="_autosummary/jax.experimental.sparse.bcoo_slice.html">jax.experimental.sparse.bcoo_slice</a></li>
<li class="toctree-l4"><a class="reference internal" href="_autosummary/jax.experimental.sparse.bcoo_sort_indices.html">jax.experimental.sparse.bcoo_sort_indices</a></li>
<li class="toctree-l4"><a class="reference internal" href="_autosummary/jax.experimental.sparse.bcoo_squeeze.html">jax.experimental.sparse.bcoo_squeeze</a></li>
<li class="toctree-l4"><a class="reference internal" href="_autosummary/jax.experimental.sparse.bcoo_sum_duplicates.html">jax.experimental.sparse.bcoo_sum_duplicates</a></li>
<li class="toctree-l4"><a class="reference internal" href="_autosummary/jax.experimental.sparse.bcoo_todense.html">jax.experimental.sparse.bcoo_todense</a></li>
<li class="toctree-l4"><a class="reference internal" href="_autosummary/jax.experimental.sparse.bcoo_transpose.html">jax.experimental.sparse.bcoo_transpose</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="jax.lib.html"><code class="docutils literal notranslate"><span class="pre">jax.lib</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.addressable_shards.html">jax.Array.addressable_shards</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.all.html">jax.Array.all</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.any.html">jax.Array.any</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.argmax.html">jax.Array.argmax</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.argmin.html">jax.Array.argmin</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.argpartition.html">jax.Array.argpartition</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.argsort.html">jax.Array.argsort</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.astype.html">jax.Array.astype</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.at.html">jax.Array.at</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.choose.html">jax.Array.choose</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.clip.html">jax.Array.clip</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.compress.html">jax.Array.compress</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.committed.html">jax.Array.committed</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.conj.html">jax.Array.conj</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.conjugate.html">jax.Array.conjugate</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.copy.html">jax.Array.copy</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.copy_to_host_async.html">jax.Array.copy_to_host_async</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.cumprod.html">jax.Array.cumprod</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.cumsum.html">jax.Array.cumsum</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.device.html">jax.Array.device</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.diagonal.html">jax.Array.diagonal</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.dot.html">jax.Array.dot</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.dtype.html">jax.Array.dtype</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.flat.html">jax.Array.flat</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.flatten.html">jax.Array.flatten</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.global_shards.html">jax.Array.global_shards</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.imag.html">jax.Array.imag</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.is_fully_addressable.html">jax.Array.is_fully_addressable</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.is_fully_replicated.html">jax.Array.is_fully_replicated</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.item.html">jax.Array.item</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.itemsize.html">jax.Array.itemsize</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.max.html">jax.Array.max</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.mean.html">jax.Array.mean</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.min.html">jax.Array.min</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.nbytes.html">jax.Array.nbytes</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.ndim.html">jax.Array.ndim</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.nonzero.html">jax.Array.nonzero</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.prod.html">jax.Array.prod</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.ptp.html">jax.Array.ptp</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.ravel.html">jax.Array.ravel</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.real.html">jax.Array.real</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.repeat.html">jax.Array.repeat</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.reshape.html">jax.Array.reshape</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.round.html">jax.Array.round</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.searchsorted.html">jax.Array.searchsorted</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.shape.html">jax.Array.shape</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.sharding.html">jax.Array.sharding</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.size.html">jax.Array.size</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.sort.html">jax.Array.sort</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.squeeze.html">jax.Array.squeeze</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.std.html">jax.Array.std</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.sum.html">jax.Array.sum</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.swapaxes.html">jax.Array.swapaxes</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.take.html">jax.Array.take</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.to_device.html">jax.Array.to_device</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.trace.html">jax.Array.trace</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.transpose.html">jax.Array.transpose</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.var.html">jax.Array.var</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.view.html">jax.Array.view</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.T.html">jax.Array.T</a></li>
<li class="toctree-l2"><a class="reference internal" href="_autosummary/jax.Array.mT.html">jax.Array.mT</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="about.html">About the project</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="faq.html">Frequently asked questions (FAQ)</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Change log</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary of terms</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="config_options.html">Configuration Options</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="advanced_guides.html" class="nav-link">Resources and Advanced Guides</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Gradient...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/jax-ml/jax" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/gradient-checkpointing.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Gradient checkpointing with jax.checkpoint (jax.remat)</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#let-s-think-step-by-step">Let’s think step by step</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#jax-checkpoint-fundamentals"><code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code> fundamentals</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-policies-for-what-s-saveable">Custom policies for what’s saveable</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-policies-for-offload">Custom policies for offload</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#list-of-policies">List of policies</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-recursive-jax-checkpoint">Advanced: Recursive <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#practical-notes">Practical notes</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="gradient-checkpointing-with-jax-checkpoint-jax-remat">
<span id="gradient-checkpointing"></span><h1>Gradient checkpointing with <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code> (<code class="docutils literal notranslate"><span class="pre">jax.remat</span></code>)<a class="headerlink" href="#gradient-checkpointing-with-jax-checkpoint-jax-remat" title="Link to this heading">#</a></h1>
<!--* freshness: { reviewed: '2024-05-03' } *-->
<p>In this tutorial, you will learn how to control JAX automatic differentiation’s saved values using <a class="reference internal" href="_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> (also known as <code class="xref py py-func docutils literal notranslate"><span class="pre">jax.remat()</span></code>), which can be particularly helpful in machine learning.</p>
<p>If you are new to automatic differentiation (autodiff) or need to refresh your memory, JAX has <a class="reference internal" href="automatic-differentiation.html#automatic-differentiation"><span class="std std-ref">Automatic differentiation</span></a> and <a class="reference internal" href="advanced-autodiff.html#advanced-autodiff"><span class="std std-ref">Advanced automatic differentiation</span></a> tutorials.</p>
<p><strong>TL;DR</strong> Use the <a class="reference internal" href="_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> decorator (aliased as <code class="xref py py-func docutils literal notranslate"><span class="pre">jax.remat()</span></code>) with <a class="reference internal" href="_autosummary/jax.grad.html#jax.grad" title="jax.grad"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.grad()</span></code></a> to control which intermediates are saved on the forward pass versus the recomputed intermediates on the backward pass, trading off memory and FLOPs.</p>
<p>If you don’t use <a class="reference internal" href="_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a>, the <code class="docutils literal notranslate"><span class="pre">jax.grad(f)(x)</span></code> forward pass stores Jacobian coefficients and other intermediates to use during the backward pass. These saved values are called <em>residuals</em>.</p>
<p><strong>Note:</strong> Don’t miss the <a class="reference internal" href="#gradient-checkpointing-practical-notes"><span class="std std-ref">Practical notes</span></a> for a discussion about how <a class="reference internal" href="_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> interacts with <a class="reference internal" href="_autosummary/jax.jit.html#jax.jit" title="jax.jit"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.jit()</span></code></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>

<span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">W1</span><span class="p">,</span> <span class="n">W2</span><span class="p">,</span> <span class="n">W3</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="n">W1</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="n">W2</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="n">W3</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">x</span>

<span class="n">W1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">W2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">W3</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

<span class="c1"># Inspect the &#39;residual&#39; values to be saved on the forward pass</span>
<span class="c1"># if you were to evaluate `jax.grad(f)(W1, W2, W3, x)`</span>
<span class="kn">from</span> <span class="nn">jax.ad_checkpoint</span> <span class="kn">import</span> <span class="n">print_saved_residuals</span>
<span class="n">jax</span><span class="o">.</span><span class="n">ad_checkpoint</span><span class="o">.</span><span class="n">print_saved_residuals</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">W1</span><span class="p">,</span> <span class="n">W2</span><span class="p">,</span> <span class="n">W3</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f32[5,4] from the argument W1
f32[6,5] from the argument W2
f32[7,6] from the argument W3
f32[4] from the argument x
f32[5] output of sin from /tmp/ipykernel_143759/1801108376.py:6:9 (g)
f32[5] output of cos from /tmp/ipykernel_143759/1801108376.py:6:9 (g)
f32[6] output of sin from /tmp/ipykernel_143759/1801108376.py:6:9 (g)
f32[6] output of cos from /tmp/ipykernel_143759/1801108376.py:6:9 (g)
f32[7] output of cos from /tmp/ipykernel_143759/1801108376.py:6:9 (g)
</pre></div>
</div>
</div>
</div>
<p>By applying <a class="reference internal" href="_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> to sub-functions, as a decorator or at specific application sites, you force JAX not to save any of that sub-function’s residuals. Instead, only the inputs of a <a class="reference internal" href="_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a>-decorated function might be saved, and any residuals consumed on the backward pass are re-computed from those inputs as needed:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f2</span><span class="p">(</span><span class="n">W1</span><span class="p">,</span> <span class="n">W2</span><span class="p">,</span> <span class="n">W3</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">(</span><span class="n">g</span><span class="p">)(</span><span class="n">W1</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">(</span><span class="n">g</span><span class="p">)(</span><span class="n">W2</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">(</span><span class="n">g</span><span class="p">)(</span><span class="n">W3</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">x</span>

<span class="n">jax</span><span class="o">.</span><span class="n">ad_checkpoint</span><span class="o">.</span><span class="n">print_saved_residuals</span><span class="p">(</span><span class="n">f2</span><span class="p">,</span> <span class="n">W1</span><span class="p">,</span> <span class="n">W2</span><span class="p">,</span> <span class="n">W3</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f32[5,4] from the argument W1
f32[6,5] from the argument W2
f32[7,6] from the argument W3
f32[4] from the argument x
f32[5] output of sin from /tmp/ipykernel_143759/1801108376.py:6:9 (g)
f32[6] output of sin from /tmp/ipykernel_143759/1801108376.py:6:9 (g)
</pre></div>
</div>
</div>
</div>
<p>Here, the values of two <code class="docutils literal notranslate"><span class="pre">sin</span></code> applications are saved because they are arguments
in subsequent applications of the <a class="reference internal" href="_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a>-decorated <code class="docutils literal notranslate"><span class="pre">g</span></code> function, and
inputs to a <a class="reference internal" href="_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a>-decorated function may be saved. But no values of
<code class="docutils literal notranslate"><span class="pre">cos</span></code> applications are saved.</p>
<p>To control which values are saveable without having to edit the definition of the function to be differentiated, you can use a rematerialization <em>policy</em>. Here is an example that saves only the results of <code class="docutils literal notranslate"><span class="pre">dot</span></code> operations with no batch dimensions (since they are often FLOP-bound, and hence worth saving rather than recomputing):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f3</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="n">jax</span><span class="o">.</span><span class="n">checkpoint_policies</span><span class="o">.</span><span class="n">dots_with_no_batch_dims_saveable</span><span class="p">)</span>
<span class="n">jax</span><span class="o">.</span><span class="n">ad_checkpoint</span><span class="o">.</span><span class="n">print_saved_residuals</span><span class="p">(</span><span class="n">f3</span><span class="p">,</span> <span class="n">W1</span><span class="p">,</span> <span class="n">W2</span><span class="p">,</span> <span class="n">W3</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f32[5,4] from the argument W1
f32[6,5] from the argument W2
f32[7,6] from the argument W3
f32[4] from the argument x
f32[5] output of reduce_precision from /tmp/ipykernel_143759/1801108376.py:5:6 (g)
f32[6] output of reduce_precision from /tmp/ipykernel_143759/1801108376.py:5:6 (g)
f32[7] output of reduce_precision from /tmp/ipykernel_143759/1801108376.py:5:6 (g)
</pre></div>
</div>
</div>
</div>
<p>You can also use policies to refer to intermediate values you name using <code class="xref py py-func docutils literal notranslate"><span class="pre">jax.ad_checkpoint.checkpoint_name()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax.ad_checkpoint</span> <span class="kn">import</span> <span class="n">checkpoint_name</span>

<span class="k">def</span> <span class="nf">f4</span><span class="p">(</span><span class="n">W1</span><span class="p">,</span> <span class="n">W2</span><span class="p">,</span> <span class="n">W3</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">checkpoint_name</span><span class="p">(</span><span class="n">g</span><span class="p">(</span><span class="n">W1</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">checkpoint_name</span><span class="p">(</span><span class="n">g</span><span class="p">(</span><span class="n">W2</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">checkpoint_name</span><span class="p">(</span><span class="n">g</span><span class="p">(</span><span class="n">W3</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">x</span>

<span class="n">f4</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">(</span><span class="n">f4</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="n">jax</span><span class="o">.</span><span class="n">checkpoint_policies</span><span class="o">.</span><span class="n">save_only_these_names</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">))</span>
<span class="n">jax</span><span class="o">.</span><span class="n">ad_checkpoint</span><span class="o">.</span><span class="n">print_saved_residuals</span><span class="p">(</span><span class="n">f4</span><span class="p">,</span> <span class="n">W1</span><span class="p">,</span> <span class="n">W2</span><span class="p">,</span> <span class="n">W3</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f32[5,4] from the argument W1
f32[6,5] from the argument W2
f32[7,6] from the argument W3
f32[4] from the argument x
f32[5] output of reduce_precision from /tmp/ipykernel_143759/2296542172.py:4:6 (f4)
</pre></div>
</div>
</div>
</div>
<p>When playing around with these toy examples, you can get a closer look at what’s going on using a custom <code class="docutils literal notranslate"><span class="pre">print_fwd_bwd</span></code> utility defined in this notebook:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax.tree_util</span> <span class="kn">import</span> <span class="n">tree_flatten</span><span class="p">,</span> <span class="n">tree_unflatten</span>

<span class="kn">from</span> <span class="nn">rich.console</span> <span class="kn">import</span> <span class="n">Console</span>
<span class="kn">from</span> <span class="nn">rich.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">import</span> <span class="nn">rich.text</span>

<span class="k">def</span> <span class="nf">print_fwd_bwd</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
  <span class="n">args</span><span class="p">,</span> <span class="n">in_tree</span> <span class="o">=</span> <span class="n">tree_flatten</span><span class="p">((</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">f_</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">tree_unflatten</span><span class="p">(</span><span class="n">in_tree</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

  <span class="n">fwd</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">make_jaxpr</span><span class="p">(</span><span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">vjp</span><span class="p">(</span><span class="n">f_</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">))(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">jaxpr</span>

  <span class="n">y</span><span class="p">,</span> <span class="n">f_vjp</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vjp</span><span class="p">(</span><span class="n">f_</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
  <span class="n">res</span><span class="p">,</span> <span class="n">in_tree</span> <span class="o">=</span> <span class="n">tree_flatten</span><span class="p">(</span><span class="n">f_vjp</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">g_</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">args</span>
    <span class="n">f_vjp</span> <span class="o">=</span> <span class="n">tree_unflatten</span><span class="p">(</span><span class="n">in_tree</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f_vjp</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

  <span class="n">bwd</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">make_jaxpr</span><span class="p">(</span><span class="n">g_</span><span class="p">)(</span><span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">jaxpr</span>

  <span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">show_header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_lines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
  <span class="n">table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="s2">&quot;[bold green]forward computation:&quot;</span><span class="p">,</span>
                <span class="s2">&quot;[bold green]backward computation:&quot;</span><span class="p">)</span>
  <span class="n">table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="n">rich</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">Text</span><span class="o">.</span><span class="n">from_ansi</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fwd</span><span class="p">)),</span>
                <span class="n">rich</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">Text</span><span class="o">.</span><span class="n">from_ansi</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">bwd</span><span class="p">)))</span>
  <span class="n">console</span> <span class="o">=</span> <span class="n">Console</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">240</span><span class="p">,</span> <span class="n">force_jupyter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_renderable_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">html</span>
<span class="n">rich</span><span class="o">.</span><span class="n">jupyter</span><span class="o">.</span><span class="n">JupyterRenderable</span><span class="o">.</span><span class="n">_repr_html_</span> <span class="o">=</span> <span class="n">_renderable_repr</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Without using `jax.checkpoint`:</span>
<span class="n">print_fwd_bwd</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">W1</span><span class="p">,</span> <span class="n">W2</span><span class="p">,</span> <span class="n">W3</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">                                                                                                                                                         
  <span style="color: #008000; text-decoration-color: #008000; font-weight: bold">forward computation:</span>                                         <span style="color: #008000; text-decoration-color: #008000; font-weight: bold">backward computation:</span>                                                                     
                                                                                                                                                         
  { <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">lambda </span><span style="color: #000000; text-decoration-color: #000000">; a</span><span style="color: #800080; text-decoration-color: #800080">:f32[5,4]</span><span style="color: #000000; text-decoration-color: #000000"> b</span><span style="color: #800080; text-decoration-color: #800080">:f32[6,5]</span><span style="color: #000000; text-decoration-color: #000000"> c</span><span style="color: #800080; text-decoration-color: #800080">:f32[7,6]</span><span style="color: #000000; text-decoration-color: #000000"> d</span><span style="color: #800080; text-decoration-color: #800080">:f32[4]</span><span style="color: #000000; text-decoration-color: #000000">. </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">let</span>    { <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">lambda </span><span style="color: #000000; text-decoration-color: #000000">; a</span><span style="color: #800080; text-decoration-color: #800080">:f32[4]</span><span style="color: #000000; text-decoration-color: #000000"> b</span><span style="color: #800080; text-decoration-color: #800080">:f32[5,4]</span><span style="color: #000000; text-decoration-color: #000000"> c</span><span style="color: #800080; text-decoration-color: #800080">:f32[5]</span><span style="color: #000000; text-decoration-color: #000000"> d</span><span style="color: #800080; text-decoration-color: #800080">:f32[5]</span><span style="color: #000000; text-decoration-color: #000000"> e</span><span style="color: #800080; text-decoration-color: #800080">:f32[6,5]</span><span style="color: #000000; text-decoration-color: #000000"> f</span><span style="color: #800080; text-decoration-color: #800080">:f32[6]</span><span style="color: #000000; text-decoration-color: #000000"> g</span><span style="color: #800080; text-decoration-color: #800080">:f32[6]</span><span style="color: #000000; text-decoration-color: #000000"> h</span><span style="color: #800080; text-decoration-color: #800080">:f32[7,6]</span>  
  <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">    </span><span style="color: #000000; text-decoration-color: #000000">e</span><span style="color: #800080; text-decoration-color: #800080">:f32[5]</span><span style="color: #000000; text-decoration-color: #000000"> = dot_general[</span>                                  <span style="color: #000000; text-decoration-color: #000000">    i</span><span style="color: #800080; text-decoration-color: #800080">:f32[7]</span><span style="color: #000000; text-decoration-color: #000000"> j</span><span style="color: #800080; text-decoration-color: #800080">:f32[7]</span><span style="color: #000000; text-decoration-color: #000000">. </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">let</span>                                                                
  <span style="color: #000000; text-decoration-color: #000000">      dimension_numbers=(([1], [0]), ([], []))</span>               <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">    </span><span style="color: #000000; text-decoration-color: #000000">k</span><span style="color: #800080; text-decoration-color: #800080">:f32[7]</span><span style="color: #000000; text-decoration-color: #000000"> = mul j i</span>                                                                    
  <span style="color: #000000; text-decoration-color: #000000">      preferred_element_type=float32</span>                         <span style="color: #000000; text-decoration-color: #000000">    l</span><span style="color: #800080; text-decoration-color: #800080">:f32[6]</span><span style="color: #000000; text-decoration-color: #000000"> = dot_general[</span>                                                               
  <span style="color: #000000; text-decoration-color: #000000">    ] a d</span>                                                    <span style="color: #000000; text-decoration-color: #000000">      dimension_numbers=(([0], [0]), ([], []))</span>                                            
  <span style="color: #000000; text-decoration-color: #000000">    f</span><span style="color: #800080; text-decoration-color: #800080">:f32[5]</span><span style="color: #000000; text-decoration-color: #000000"> = sin e</span>                                         <span style="color: #000000; text-decoration-color: #000000">      preferred_element_type=float32</span>                                                      
  <span style="color: #000000; text-decoration-color: #000000">    g</span><span style="color: #800080; text-decoration-color: #800080">:f32[5]</span><span style="color: #000000; text-decoration-color: #000000"> = cos e</span>                                         <span style="color: #000000; text-decoration-color: #000000">    ] k h</span>                                                                                 
  <span style="color: #000000; text-decoration-color: #000000">    h</span><span style="color: #800080; text-decoration-color: #800080">:f32[6]</span><span style="color: #000000; text-decoration-color: #000000"> = dot_general[</span>                                  <span style="color: #000000; text-decoration-color: #000000">    m</span><span style="color: #800080; text-decoration-color: #800080">:f32[7,6]</span><span style="color: #000000; text-decoration-color: #000000"> = dot_general[</span>                                                             
  <span style="color: #000000; text-decoration-color: #000000">      dimension_numbers=(([1], [0]), ([], []))</span>               <span style="color: #000000; text-decoration-color: #000000">      dimension_numbers=(([], []), ([], []))</span>                                              
  <span style="color: #000000; text-decoration-color: #000000">      preferred_element_type=float32</span>                         <span style="color: #000000; text-decoration-color: #000000">      preferred_element_type=float32</span>                                                      
  <span style="color: #000000; text-decoration-color: #000000">    ] b f</span>                                                    <span style="color: #000000; text-decoration-color: #000000">    ] k g</span>                                                                                 
  <span style="color: #000000; text-decoration-color: #000000">    i</span><span style="color: #800080; text-decoration-color: #800080">:f32[6]</span><span style="color: #000000; text-decoration-color: #000000"> = sin h</span>                                         <span style="color: #000000; text-decoration-color: #000000">    n</span><span style="color: #800080; text-decoration-color: #800080">:f32[6]</span><span style="color: #000000; text-decoration-color: #000000"> = mul l f</span>                                                                    
  <span style="color: #000000; text-decoration-color: #000000">    j</span><span style="color: #800080; text-decoration-color: #800080">:f32[6]</span><span style="color: #000000; text-decoration-color: #000000"> = cos h</span>                                         <span style="color: #000000; text-decoration-color: #000000">    o</span><span style="color: #800080; text-decoration-color: #800080">:f32[5]</span><span style="color: #000000; text-decoration-color: #000000"> = dot_general[</span>                                                               
  <span style="color: #000000; text-decoration-color: #000000">    k</span><span style="color: #800080; text-decoration-color: #800080">:f32[7]</span><span style="color: #000000; text-decoration-color: #000000"> = dot_general[</span>                                  <span style="color: #000000; text-decoration-color: #000000">      dimension_numbers=(([0], [0]), ([], []))</span>                                            
  <span style="color: #000000; text-decoration-color: #000000">      dimension_numbers=(([1], [0]), ([], []))</span>               <span style="color: #000000; text-decoration-color: #000000">      preferred_element_type=float32</span>                                                      
  <span style="color: #000000; text-decoration-color: #000000">      preferred_element_type=float32</span>                         <span style="color: #000000; text-decoration-color: #000000">    ] n e</span>                                                                                 
  <span style="color: #000000; text-decoration-color: #000000">    ] c i</span>                                                    <span style="color: #000000; text-decoration-color: #000000">    p</span><span style="color: #800080; text-decoration-color: #800080">:f32[6,5]</span><span style="color: #000000; text-decoration-color: #000000"> = dot_general[</span>                                                             
  <span style="color: #000000; text-decoration-color: #000000">    l</span><span style="color: #800080; text-decoration-color: #800080">:f32[7]</span><span style="color: #000000; text-decoration-color: #000000"> = sin k</span>                                         <span style="color: #000000; text-decoration-color: #000000">      dimension_numbers=(([], []), ([], []))</span>                                              
  <span style="color: #000000; text-decoration-color: #000000">    m</span><span style="color: #800080; text-decoration-color: #800080">:f32[7]</span><span style="color: #000000; text-decoration-color: #000000"> = cos k</span>                                         <span style="color: #000000; text-decoration-color: #000000">      preferred_element_type=float32</span>                                                      
  <span style="color: #000000; text-decoration-color: #000000">  </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">in </span><span style="color: #000000; text-decoration-color: #000000">(l, d, a, g, f, b, j, i, c, m) }</span>                        <span style="color: #000000; text-decoration-color: #000000">    ] n d</span>                                                                                 
                                                               <span style="color: #000000; text-decoration-color: #000000">    q</span><span style="color: #800080; text-decoration-color: #800080">:f32[5]</span><span style="color: #000000; text-decoration-color: #000000"> = mul o c</span>                                                                    
                                                               <span style="color: #000000; text-decoration-color: #000000">    r</span><span style="color: #800080; text-decoration-color: #800080">:f32[4]</span><span style="color: #000000; text-decoration-color: #000000"> = dot_general[</span>                                                               
                                                               <span style="color: #000000; text-decoration-color: #000000">      dimension_numbers=(([0], [0]), ([], []))</span>                                            
                                                               <span style="color: #000000; text-decoration-color: #000000">      preferred_element_type=float32</span>                                                      
                                                               <span style="color: #000000; text-decoration-color: #000000">    ] q b</span>                                                                                 
                                                               <span style="color: #000000; text-decoration-color: #000000">    s</span><span style="color: #800080; text-decoration-color: #800080">:f32[5,4]</span><span style="color: #000000; text-decoration-color: #000000"> = dot_general[</span>                                                             
                                                               <span style="color: #000000; text-decoration-color: #000000">      dimension_numbers=(([], []), ([], []))</span>                                              
                                                               <span style="color: #000000; text-decoration-color: #000000">      preferred_element_type=float32</span>                                                      
                                                               <span style="color: #000000; text-decoration-color: #000000">    ] q a</span>                                                                                 
                                                               <span style="color: #000000; text-decoration-color: #000000">  </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">in </span><span style="color: #000000; text-decoration-color: #000000">(s, p, m, r) }</span>                                                                       
</pre>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Using `jax.checkpoint` with policy=jax.checkpoint_policies.dots_with_no_batch_dims_saveable:</span>
<span class="n">print_fwd_bwd</span><span class="p">(</span><span class="n">f3</span><span class="p">,</span> <span class="n">W1</span><span class="p">,</span> <span class="n">W2</span><span class="p">,</span> <span class="n">W3</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">                                                                                                                                                                        
  <span style="color: #008000; text-decoration-color: #008000; font-weight: bold">forward computation:</span>                                                   <span style="color: #008000; text-decoration-color: #008000; font-weight: bold">backward computation:</span>                                                                          
                                                                                                                                                                        
  { <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">lambda </span><span style="color: #000000; text-decoration-color: #000000">; a</span><span style="color: #800080; text-decoration-color: #800080">:f32[5,4]</span><span style="color: #000000; text-decoration-color: #000000"> b</span><span style="color: #800080; text-decoration-color: #800080">:f32[6,5]</span><span style="color: #000000; text-decoration-color: #000000"> c</span><span style="color: #800080; text-decoration-color: #800080">:f32[7,6]</span><span style="color: #000000; text-decoration-color: #000000"> d</span><span style="color: #800080; text-decoration-color: #800080">:f32[4]</span><span style="color: #000000; text-decoration-color: #000000">. </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">let</span>              { <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">lambda </span><span style="color: #000000; text-decoration-color: #000000">; a</span><span style="color: #800080; text-decoration-color: #800080">:f32[5]</span><span style="color: #000000; text-decoration-color: #000000"> b</span><span style="color: #800080; text-decoration-color: #800080">:f32[6]</span><span style="color: #000000; text-decoration-color: #000000"> c</span><span style="color: #800080; text-decoration-color: #800080">:f32[7]</span><span style="color: #000000; text-decoration-color: #000000"> d</span><span style="color: #800080; text-decoration-color: #800080">:f32[5,4]</span><span style="color: #000000; text-decoration-color: #000000"> e</span><span style="color: #800080; text-decoration-color: #800080">:f32[6,5]</span><span style="color: #000000; text-decoration-color: #000000"> f</span><span style="color: #800080; text-decoration-color: #800080">:f32[7,6]</span><span style="color: #000000; text-decoration-color: #000000"> g</span><span style="color: #800080; text-decoration-color: #800080">:f32[4]</span><span style="color: #000000; text-decoration-color: #000000"> h</span><span style="color: #800080; text-decoration-color: #800080">:f32[7]</span><span style="color: #000000; text-decoration-color: #000000">. </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">let</span>  
  <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">    </span><span style="color: #000000; text-decoration-color: #000000">e</span><span style="color: #800080; text-decoration-color: #800080">:f32[5]</span><span style="color: #000000; text-decoration-color: #000000"> = dot_general[</span>                                            <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">    </span><span style="color: #000000; text-decoration-color: #000000">i</span><span style="color: #800080; text-decoration-color: #800080">:f32[5,4]</span><span style="color: #000000; text-decoration-color: #000000"> j</span><span style="color: #800080; text-decoration-color: #800080">:f32[6,5]</span><span style="color: #000000; text-decoration-color: #000000"> k</span><span style="color: #800080; text-decoration-color: #800080">:f32[7,6]</span><span style="color: #000000; text-decoration-color: #000000"> l</span><span style="color: #800080; text-decoration-color: #800080">:f32[4]</span><span style="color: #000000; text-decoration-color: #000000"> = remat2[</span>                                        
  <span style="color: #000000; text-decoration-color: #000000">      dimension_numbers=(([1], [0]), ([], []))</span>                         <span style="color: #000000; text-decoration-color: #000000">      differentiated=True</span>                                                                      
  <span style="color: #000000; text-decoration-color: #000000">      preferred_element_type=float32</span>                                   <span style="color: #000000; text-decoration-color: #000000">      jaxpr={ </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">lambda </span><span style="color: #000000; text-decoration-color: #000000">; m</span><span style="color: #800080; text-decoration-color: #800080">:f32[5]</span><span style="color: #000000; text-decoration-color: #000000"> n</span><span style="color: #800080; text-decoration-color: #800080">:f32[6]</span><span style="color: #000000; text-decoration-color: #000000"> o</span><span style="color: #800080; text-decoration-color: #800080">:f32[7]</span><span style="color: #000000; text-decoration-color: #000000"> p</span><span style="color: #800080; text-decoration-color: #800080">:f32[5,4]</span><span style="color: #000000; text-decoration-color: #000000"> q</span><span style="color: #800080; text-decoration-color: #800080">:f32[6,5]</span><span style="color: #000000; text-decoration-color: #000000"> r</span><span style="color: #800080; text-decoration-color: #800080">:f32[7,6]</span>             
  <span style="color: #000000; text-decoration-color: #000000">    ] a d</span>                                                              <span style="color: #000000; text-decoration-color: #000000">          s</span><span style="color: #800080; text-decoration-color: #800080">:f32[4]</span><span style="color: #000000; text-decoration-color: #000000"> t</span><span style="color: #800080; text-decoration-color: #800080">:f32[7]</span><span style="color: #000000; text-decoration-color: #000000">. </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">let</span>                                                               
  <span style="color: #000000; text-decoration-color: #000000">    f</span><span style="color: #800080; text-decoration-color: #800080">:f32[5]</span><span style="color: #000000; text-decoration-color: #000000"> = reduce_precision[exponent_bits=8 mantissa_bits=23] e</span>    <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">          </span><span style="color: #000000; text-decoration-color: #000000">u</span><span style="color: #800080; text-decoration-color: #800080">:f32[5]</span><span style="color: #000000; text-decoration-color: #000000"> = sin m</span>                                                                     
  <span style="color: #000000; text-decoration-color: #000000">    g</span><span style="color: #800080; text-decoration-color: #800080">:f32[5]</span><span style="color: #000000; text-decoration-color: #000000"> = sin f</span>                                                   <span style="color: #000000; text-decoration-color: #000000">          v</span><span style="color: #800080; text-decoration-color: #800080">:f32[5]</span><span style="color: #000000; text-decoration-color: #000000"> = cos m</span>                                                                     
  <span style="color: #000000; text-decoration-color: #000000">    h</span><span style="color: #800080; text-decoration-color: #800080">:f32[6]</span><span style="color: #000000; text-decoration-color: #000000"> = dot_general[</span>                                            <span style="color: #000000; text-decoration-color: #000000">          w</span><span style="color: #800080; text-decoration-color: #800080">:f32[6]</span><span style="color: #000000; text-decoration-color: #000000"> = sin n</span>                                                                     
  <span style="color: #000000; text-decoration-color: #000000">      dimension_numbers=(([1], [0]), ([], []))</span>                         <span style="color: #000000; text-decoration-color: #000000">          x</span><span style="color: #800080; text-decoration-color: #800080">:f32[6]</span><span style="color: #000000; text-decoration-color: #000000"> = cos n</span>                                                                     
  <span style="color: #000000; text-decoration-color: #000000">      preferred_element_type=float32</span>                                   <span style="color: #000000; text-decoration-color: #000000">          y</span><span style="color: #800080; text-decoration-color: #800080">:f32[7]</span><span style="color: #000000; text-decoration-color: #000000"> = cos o</span>                                                                     
  <span style="color: #000000; text-decoration-color: #000000">    ] b g</span>                                                              <span style="color: #000000; text-decoration-color: #000000">          z</span><span style="color: #800080; text-decoration-color: #800080">:f32[7]</span><span style="color: #000000; text-decoration-color: #000000"> = mul t y</span>                                                                   
  <span style="color: #000000; text-decoration-color: #000000">    i</span><span style="color: #800080; text-decoration-color: #800080">:f32[6]</span><span style="color: #000000; text-decoration-color: #000000"> = reduce_precision[exponent_bits=8 mantissa_bits=23] h</span>    <span style="color: #000000; text-decoration-color: #000000">          ba</span><span style="color: #800080; text-decoration-color: #800080">:f32[6]</span><span style="color: #000000; text-decoration-color: #000000"> = dot_general[</span>                                                             
  <span style="color: #000000; text-decoration-color: #000000">    j</span><span style="color: #800080; text-decoration-color: #800080">:f32[6]</span><span style="color: #000000; text-decoration-color: #000000"> = sin i</span>                                                   <span style="color: #000000; text-decoration-color: #000000">            dimension_numbers=(([0], [0]), ([], []))</span>                                           
  <span style="color: #000000; text-decoration-color: #000000">    k</span><span style="color: #800080; text-decoration-color: #800080">:f32[7]</span><span style="color: #000000; text-decoration-color: #000000"> = dot_general[</span>                                            <span style="color: #000000; text-decoration-color: #000000">            preferred_element_type=float32</span>                                                     
  <span style="color: #000000; text-decoration-color: #000000">      dimension_numbers=(([1], [0]), ([], []))</span>                         <span style="color: #000000; text-decoration-color: #000000">          ] z r</span>                                                                                
  <span style="color: #000000; text-decoration-color: #000000">      preferred_element_type=float32</span>                                   <span style="color: #000000; text-decoration-color: #000000">          bb</span><span style="color: #800080; text-decoration-color: #800080">:f32[7,6]</span><span style="color: #000000; text-decoration-color: #000000"> = dot_general[</span>                                                           
  <span style="color: #000000; text-decoration-color: #000000">    ] c j</span>                                                              <span style="color: #000000; text-decoration-color: #000000">            dimension_numbers=(([], []), ([], []))</span>                                             
  <span style="color: #000000; text-decoration-color: #000000">    l</span><span style="color: #800080; text-decoration-color: #800080">:f32[7]</span><span style="color: #000000; text-decoration-color: #000000"> = reduce_precision[exponent_bits=8 mantissa_bits=23] k</span>    <span style="color: #000000; text-decoration-color: #000000">            preferred_element_type=float32</span>                                                     
  <span style="color: #000000; text-decoration-color: #000000">    m</span><span style="color: #800080; text-decoration-color: #800080">:f32[7]</span><span style="color: #000000; text-decoration-color: #000000"> = sin l</span>                                                   <span style="color: #000000; text-decoration-color: #000000">          ] z w</span>                                                                                
  <span style="color: #000000; text-decoration-color: #000000">  </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">in </span><span style="color: #000000; text-decoration-color: #000000">(m, f, i, l, a, b, c, d) }</span>                                        <span style="color: #000000; text-decoration-color: #000000">          bc</span><span style="color: #800080; text-decoration-color: #800080">:f32[6]</span><span style="color: #000000; text-decoration-color: #000000"> = mul ba x</span>                                                                 
                                                                         <span style="color: #000000; text-decoration-color: #000000">          bd</span><span style="color: #800080; text-decoration-color: #800080">:f32[5]</span><span style="color: #000000; text-decoration-color: #000000"> = dot_general[</span>                                                             
                                                                         <span style="color: #000000; text-decoration-color: #000000">            dimension_numbers=(([0], [0]), ([], []))</span>                                           
                                                                         <span style="color: #000000; text-decoration-color: #000000">            preferred_element_type=float32</span>                                                     
                                                                         <span style="color: #000000; text-decoration-color: #000000">          ] bc q</span>                                                                               
                                                                         <span style="color: #000000; text-decoration-color: #000000">          be</span><span style="color: #800080; text-decoration-color: #800080">:f32[6,5]</span><span style="color: #000000; text-decoration-color: #000000"> = dot_general[</span>                                                           
                                                                         <span style="color: #000000; text-decoration-color: #000000">            dimension_numbers=(([], []), ([], []))</span>                                             
                                                                         <span style="color: #000000; text-decoration-color: #000000">            preferred_element_type=float32</span>                                                     
                                                                         <span style="color: #000000; text-decoration-color: #000000">          ] bc u</span>                                                                               
                                                                         <span style="color: #000000; text-decoration-color: #000000">          bf</span><span style="color: #800080; text-decoration-color: #800080">:f32[5]</span><span style="color: #000000; text-decoration-color: #000000"> = mul bd v</span>                                                                 
                                                                         <span style="color: #000000; text-decoration-color: #000000">          bg</span><span style="color: #800080; text-decoration-color: #800080">:f32[4]</span><span style="color: #000000; text-decoration-color: #000000"> = dot_general[</span>                                                             
                                                                         <span style="color: #000000; text-decoration-color: #000000">            dimension_numbers=(([0], [0]), ([], []))</span>                                           
                                                                         <span style="color: #000000; text-decoration-color: #000000">            preferred_element_type=float32</span>                                                     
                                                                         <span style="color: #000000; text-decoration-color: #000000">          ] bf p</span>                                                                               
                                                                         <span style="color: #000000; text-decoration-color: #000000">          bh</span><span style="color: #800080; text-decoration-color: #800080">:f32[5,4]</span><span style="color: #000000; text-decoration-color: #000000"> = dot_general[</span>                                                           
                                                                         <span style="color: #000000; text-decoration-color: #000000">            dimension_numbers=(([], []), ([], []))</span>                                             
                                                                         <span style="color: #000000; text-decoration-color: #000000">            preferred_element_type=float32</span>                                                     
                                                                         <span style="color: #000000; text-decoration-color: #000000">          ] bf s</span>                                                                               
                                                                         <span style="color: #000000; text-decoration-color: #000000">        </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">in </span><span style="color: #000000; text-decoration-color: #000000">(bh, be, bb, bg) }</span>                                                                  
                                                                         <span style="color: #000000; text-decoration-color: #000000">      policy=&lt;function dots_with_no_batch_dims_saveable at 0x7fa630ceb7e0&gt;</span>                     
                                                                         <span style="color: #000000; text-decoration-color: #000000">      prevent_cse=True</span>                                                                         
                                                                         <span style="color: #000000; text-decoration-color: #000000">    ] a b c d e f g h</span>                                                                          
                                                                         <span style="color: #000000; text-decoration-color: #000000">  </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">in </span><span style="color: #000000; text-decoration-color: #000000">(i, j, k, l) }</span>                                                                            
</pre>
</div></div>
</div>
<section id="let-s-think-step-by-step">
<h2>Let’s think step by step<a class="headerlink" href="#let-s-think-step-by-step" title="Link to this heading">#</a></h2>
<p><strong>Note:</strong> It may help to check out the <a class="reference internal" href="advanced-autodiff.html#advanced-autodiff"><span class="std std-ref">Advanced automatic differentiation</span></a> tutorial prior to continuing here.</p>
<section id="jax-checkpoint-fundamentals">
<h3><code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code> fundamentals<a class="headerlink" href="#jax-checkpoint-fundamentals" title="Link to this heading">#</a></h3>
<p>In both <a class="reference internal" href="_autosummary/jax.linearize.html#jax.linearize" title="jax.linearize"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.linearize()</span></code></a> and <a class="reference internal" href="_autosummary/jax.vjp.html#jax.vjp" title="jax.vjp"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.vjp()</span></code></a>, there is flexibility in how and when some values are computed. Different choices can trade off memory use against FLOPs. JAX provides control over these choices with <a class="reference internal" href="_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a>.</p>
<p>One such choice is whether to perform Jacobian coefficient computations on the forward pass, as soon as the inputs are available, or on the backward pass, just before the coefficients are needed. Consider the example of <code class="docutils literal notranslate"><span class="pre">sin_vjp</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sin_vjp</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">cos_x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">y_bar</span><span class="p">:</span> <span class="n">cos_x</span> <span class="o">*</span> <span class="n">y_bar</span>
</pre></div>
</div>
</div>
</div>
<p>Another valid implementation would compute the value of <code class="docutils literal notranslate"><span class="pre">jnp.cos(x)</span></code> on the backward pass rather than on the forward pass:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sin_vjp2</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">y_bar</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">y_bar</span>
</pre></div>
</div>
</div>
</div>
<p>For this particular function, the amount of memory used by the two versions is the same, though you’ve reduced the FLOPs for the primal computation (the forward pass) and increased the FLOPs for the cotangent computation (the backward pass).</p>
<p>There’s another choice when it comes to function composition. Recall the VJP rule for a composition of two functions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">z</span> <span class="o">=</span> <span class="n">h</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">z</span>

<span class="k">def</span> <span class="nf">f_vjp</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">y</span><span class="p">,</span> <span class="n">g_vjp</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vjp</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="n">z</span><span class="p">,</span> <span class="n">h_vjp</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vjp</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">f_bwd</span><span class="p">(</span><span class="n">z_bar</span><span class="p">):</span>
    <span class="n">y_bar</span><span class="p">,</span> <span class="o">=</span> <span class="n">h_vjp</span><span class="p">(</span><span class="n">z_bar</span><span class="p">)</span>
    <span class="n">x_bar</span><span class="p">,</span> <span class="o">=</span> <span class="n">g_vjp</span><span class="p">(</span><span class="n">y_bar</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x_bar</span>
  <span class="k">return</span> <span class="n">z</span><span class="p">,</span> <span class="n">f_bwd</span>
</pre></div>
</div>
</div>
</div>
<p>An alternative is:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f_vjp_checkpoint</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">z</span><span class="p">,</span> <span class="n">h_vjp</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vjp</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">f_bwd2</span><span class="p">(</span><span class="n">z_bar</span><span class="p">):</span>
    <span class="n">y_bar</span><span class="p">,</span> <span class="o">=</span> <span class="n">h_vjp</span><span class="p">(</span><span class="n">z_bar</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">g_vjp</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vjp</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">x_bar</span><span class="p">,</span> <span class="o">=</span> <span class="n">g_vjp</span><span class="p">(</span><span class="n">y_bar</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x_bar</span>
  <span class="k">return</span> <span class="n">z</span><span class="p">,</span> <span class="n">f_bwd2</span>
</pre></div>
</div>
</div>
</div>
<p>Using words, this alternative implementation doesn’t compute <code class="docutils literal notranslate"><span class="pre">g_vjp</span></code>, or the residual values in its closure, on the forward pass. Instead, it only computes them in the backward pass <code class="docutils literal notranslate"><span class="pre">f_bwd2</span></code>. That means <code class="docutils literal notranslate"><span class="pre">f_vjp_checkpoint</span></code> requires less memory: if <code class="docutils literal notranslate"><span class="pre">g</span></code> and <code class="docutils literal notranslate"><span class="pre">h</span></code> each required similar amounts of memory for their residuals, each much larger than <code class="docutils literal notranslate"><span class="pre">x</span></code>, then the function produced by <code class="docutils literal notranslate"><span class="pre">f_vjp_checkpoint(x)</span></code> requires half the memory as that of <code class="docutils literal notranslate"><span class="pre">f_vjp(x)</span></code>!</p>
<p>The cost you pay is redundant work: in <code class="docutils literal notranslate"><span class="pre">f_bwd2</span></code> you must re-evaluate <code class="docutils literal notranslate"><span class="pre">g(x)</span></code> as part of <code class="docutils literal notranslate"><span class="pre">jax.vjp(g,</span> <span class="pre">x)</span></code> just to discard its value (in the underscore variable on the line <code class="docutils literal notranslate"><span class="pre">_,</span> <span class="pre">g_vjp</span> <span class="pre">=</span> <span class="pre">jax.vjp(g,</span> <span class="pre">x)</span></code>).</p>
<p>You can get this VJP behavior in autodiff � without having to write VJP functions directly � by instead using <a class="reference internal" href="_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> in an alternative definition of the original function <code class="docutils literal notranslate"><span class="pre">f</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f_checkpoint</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">(</span><span class="n">g</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">z</span> <span class="o">=</span> <span class="n">h</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">z</span>
</pre></div>
</div>
</div>
</div>
<p>In other words, you apply <a class="reference internal" href="_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> to <code class="docutils literal notranslate"><span class="pre">g</span></code> — the first stage of <code class="docutils literal notranslate"><span class="pre">f</span></code> — rather than to <code class="docutils literal notranslate"><span class="pre">f</span></code> itself. This way, when you evaluate <code class="docutils literal notranslate"><span class="pre">jax.grad(f_checkpoint)(x)</span></code>, you’d get a computation like:</p>
<ol class="arabic simple">
<li><p>Run the forward pass of <code class="docutils literal notranslate"><span class="pre">g</span></code>, discarding residual values.</p></li>
<li><p>Run the forward pass of <code class="docutils literal notranslate"><span class="pre">h</span></code>, saving residuals.</p></li>
<li><p>Run the backward pass of <code class="docutils literal notranslate"><span class="pre">h</span></code>, consuming residuals from step 2.</p></li>
<li><p>Re-run the forward pass of <code class="docutils literal notranslate"><span class="pre">g</span></code>, saving residuals.</p></li>
<li><p>Run the backward pass of <code class="docutils literal notranslate"><span class="pre">g</span></code>, consuming residuals from step 4.</p></li>
</ol>
<p>That is, by evaluating <code class="docutils literal notranslate"><span class="pre">jax.grad(f_checkpoint)(x)</span></code> we’d get the same computation as:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f_checkpoint_grad</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>                  <span class="c1"># step 1</span>
  <span class="n">_</span><span class="p">,</span> <span class="n">h_vjp</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vjp</span><span class="p">(</span><span class="n">h</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>  <span class="c1"># step 2</span>
  <span class="n">y_bar</span><span class="p">,</span> <span class="o">=</span> <span class="n">h_vjp</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>       <span class="c1"># step 3</span>
  <span class="n">_</span><span class="p">,</span> <span class="n">g_vjp</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vjp</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>  <span class="c1"># step 4</span>
  <span class="n">x_bar</span><span class="p">,</span> <span class="o">=</span> <span class="n">g_vjp</span><span class="p">(</span><span class="n">y_bar</span><span class="p">)</span>     <span class="c1"># step 5</span>
  <span class="k">return</span> <span class="n">x_bar</span>
</pre></div>
</div>
</div>
</div>
<p>In general, <code class="docutils literal notranslate"><span class="pre">jax.checkpoint(foo)</span></code> is a new function which has the same input-output behavior as <code class="docutils literal notranslate"><span class="pre">foo</span></code>, but behaves differently under autodiff, particularly under <a class="reference internal" href="_autosummary/jax.linearize.html#jax.linearize" title="jax.linearize"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.linearize()</span></code></a> and <a class="reference internal" href="_autosummary/jax.vjp.html#jax.vjp" title="jax.vjp"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.vjp()</span></code></a> (and their wrappers, like <a class="reference internal" href="_autosummary/jax.grad.html#jax.grad" title="jax.grad"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.grad()</span></code></a>) but not <a class="reference internal" href="_autosummary/jax.jvp.html#jax.jvp" title="jax.jvp"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.jvp()</span></code></a>. When differentiated, only the input to a <a class="reference internal" href="_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a>-differentiated function is stored on the forward pass. On the backward pass, the residuals (intermediates from <code class="docutils literal notranslate"><span class="pre">foo</span></code> and its Jacobian coefficient values needed for the backward pass) are recomputed.</p>
<p>Notice that if <code class="docutils literal notranslate"><span class="pre">f</span> <span class="pre">=</span> <span class="pre">lambda</span> <span class="pre">x:</span> <span class="pre">h(g(x))</span></code> is the function you want to differentiate (in other words, if you want to apply <code class="docutils literal notranslate"><span class="pre">jax.grad(f)</span></code>) you don’t get any memory savings by applying <a class="reference internal" href="_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> to <code class="docutils literal notranslate"><span class="pre">f</span></code> itself. That’s because evaluating <code class="docutils literal notranslate"><span class="pre">jax.grad(jax.checkpoint(f))(x)</span></code> would lead to a computation, such as:</p>
<ol class="arabic simple">
<li><p>Run the forward pass, discarding all residuals.</p></li>
<li><p>Immediately re-run the forward pass, saving residuals.</p></li>
<li><p>Run the backward pass, consuming residuals from step 2.</p></li>
</ol>
<p>In code, you’d have something like:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f_grad_bad</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">_</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>                  <span class="c1"># step 1</span>
  <span class="n">_</span><span class="p">,</span> <span class="n">f_vjp</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vjp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>  <span class="c1"># step 2</span>
  <span class="n">x_bar</span><span class="p">,</span> <span class="o">=</span> <span class="n">f_vjp</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>       <span class="c1"># step 3</span>
  <span class="k">return</span> <span class="n">x_bar</span>
</pre></div>
</div>
</div>
</div>
<p>You also wouldn’t get any memory savings by applying <a class="reference internal" href="_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> to <code class="docutils literal notranslate"><span class="pre">h</span></code>, the second stage of <code class="docutils literal notranslate"><span class="pre">f</span></code>. That’s because evaluating <code class="docutils literal notranslate"><span class="pre">jax.grad(lambda</span> <span class="pre">x:</span> <span class="pre">jax.checkpoint(h)(g(x)))</span></code> would lead to a computation, such as:</p>
<ol class="arabic simple">
<li><p>Run the forward pass of <code class="docutils literal notranslate"><span class="pre">g</span></code>, saving residuals.</p></li>
<li><p>Run the forward pass of <code class="docutils literal notranslate"><span class="pre">h</span></code>, discarding residuals.</p></li>
<li><p>Immediately re-run the forward pass of <code class="docutils literal notranslate"><span class="pre">h</span></code>, saving residuals.</p></li>
<li><p>Run the backward pass of <code class="docutils literal notranslate"><span class="pre">h</span></code>, consuming residuals from step 3.</p></li>
<li><p>Run the backward pass of <code class="docutils literal notranslate"><span class="pre">g</span></code>, consuming residuals from step 1.</p></li>
</ol>
<p>In code you’d have something like:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f_grad_bad2</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">y</span><span class="p">,</span> <span class="n">g_vjp</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vjp</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>  <span class="c1"># step 1</span>
  <span class="n">z</span> <span class="o">=</span> <span class="n">h</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>                  <span class="c1"># step 2</span>
  <span class="n">_</span><span class="p">,</span> <span class="n">h_vjp</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vjp</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>  <span class="c1"># step 3</span>
  <span class="n">y_bar</span><span class="p">,</span> <span class="o">=</span> <span class="n">h_vjp</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>       <span class="c1"># step 3</span>
  <span class="n">x_bar</span><span class="p">,</span> <span class="o">=</span> <span class="n">g_vjp</span><span class="p">(</span><span class="n">y_bar</span><span class="p">)</span>     <span class="c1"># step 5</span>
  <span class="k">return</span> <span class="n">x_bar</span>
</pre></div>
</div>
</div>
</div>
<p>Slightly more generally, if you had a chain composition of functions, such as <code class="docutils literal notranslate"><span class="pre">f</span> <span class="pre">=</span> <span class="pre">lambda</span> <span class="pre">x:</span> <span class="pre">f3(f2(f1(x)))</span></code>, and were interested in evaluating <code class="docutils literal notranslate"><span class="pre">jax.grad(f)</span></code>, you could say that you:</p>
<ul class="simple">
<li><p>Shouldn’t apply <a class="reference internal" href="_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> to the whole function <code class="docutils literal notranslate"><span class="pre">f</span></code>, since that wouldn’t save any memory (and will perform wasteful recomputation).</p></li>
<li><p>Shouldn’t apply <a class="reference internal" href="_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> to the last sub-function <code class="docutils literal notranslate"><span class="pre">f3</span></code>, since that wouldn’t save any memory (and will perform wasteful recomputation).</p></li>
<li><p>Could apply <a class="reference internal" href="_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> to <code class="docutils literal notranslate"><span class="pre">f1</span></code>, <code class="docutils literal notranslate"><span class="pre">f2</span></code>, or their composition <code class="docutils literal notranslate"><span class="pre">lambda</span> <span class="pre">x:</span> <span class="pre">f2(f1(x))</span></code>, since any of those might save memory and would express different memory/recompute tradeoffs.</p></li>
</ul>
</section>
<section id="custom-policies-for-what-s-saveable">
<h3>Custom policies for what’s saveable<a class="headerlink" href="#custom-policies-for-what-s-saveable" title="Link to this heading">#</a></h3>
<p>As shown so far, using <a class="reference internal" href="_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> switches from one extreme to another:</p>
<ul class="simple">
<li><p>Without <a class="reference internal" href="_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a>, JAX’s autodiff tends to compute everything possible on the forward pass and store it for the backward pass.</p></li>
<li><p>With a <a class="reference internal" href="_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> decorator, you instead compute as little as possible on the forward pass and recompute values as needed on the backward pass.</p></li>
</ul>
<p>To operate between these two extremes, saving some things and not others, you can carefully place <a class="reference internal" href="_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> decorators on sub-functions. But that requires editing the function to be differentiated, e.g. model code, which may be inconvenient. It can also be hard to experiment with variations.</p>
<p>So an alternative is to use the <code class="docutils literal notranslate"><span class="pre">policy</span></code> argument to <a class="reference internal" href="_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a>. A policy is a callable (i.e. a function) which takes as input a type-level specification of a first order primitive application and returns a boolean indicating whether the corresponding output value(s) are allowed to be saved as residuals (or instead must be recomputed in the (co)tangent computation as needed). To write robust code, a policy should be selected from the attributes on <code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint_policies()</span></code>, like <code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint_policies.dots_with_no_batch_dims_saveable()</span></code>, since the API for writing custom policy callables is considered internal.</p>
<p>For example, consider this function to be differentiated:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">loss</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">predict</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="o">*</span><span class="n">Ws</span><span class="p">,</span> <span class="n">Wlast</span> <span class="o">=</span> <span class="n">params</span>
  <span class="k">for</span> <span class="n">W</span> <span class="ow">in</span> <span class="n">Ws</span><span class="p">:</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Wlast</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">layer</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">W1</span> <span class="o">=</span> <span class="n">W2</span> <span class="o">=</span> <span class="n">W3</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">W1</span><span class="p">,</span> <span class="n">W2</span><span class="p">,</span> <span class="n">W3</span><span class="p">]</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_saved_residuals</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f32[4,4] from the argument params[0]
f32[4,4] from the argument params[1]
f32[4,4] from the argument params[2]
f32[4] from the argument x
f32[4] output of sin from /tmp/ipykernel_143759/4230705069.py:12:9 (layer)
f32[4] output of cos from /tmp/ipykernel_143759/4230705069.py:12:9 (layer)
f32[4] output of sin from /tmp/ipykernel_143759/4230705069.py:12:9 (layer)
f32[4] output of cos from /tmp/ipykernel_143759/4230705069.py:12:9 (layer)
f32[4] output of mul from /tmp/ipykernel_143759/4230705069.py:2:17 (loss)
</pre></div>
</div>
</div>
</div>
<p>Instead of saving so many values on the forward pass, perhaps you only want to save the results of matrix multiplications with no batch dimension (since they may be FLOP- rather than memory-bound). You can do that using the policy <code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint_policies.dots_with_no_batch_dims_saveable()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">loss_checkpoint</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="n">jax</span><span class="o">.</span><span class="n">checkpoint_policies</span><span class="o">.</span><span class="n">dots_with_no_batch_dims_saveable</span><span class="p">)</span>
<span class="n">print_saved_residuals</span><span class="p">(</span><span class="n">loss_checkpoint</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f32[4,4] from the argument params[0]
f32[4,4] from the argument params[1]
f32[4,4] from the argument params[2]
f32[4] from the argument x
f32[4] from the argument y
f32[4] output of reduce_precision from /tmp/ipykernel_143759/4230705069.py:12:17 (layer)
f32[4] output of reduce_precision from /tmp/ipykernel_143759/4230705069.py:12:17 (layer)
f32[4] output of reduce_precision from /tmp/ipykernel_143759/4230705069.py:8:6 (predict)
</pre></div>
</div>
</div>
</div>
<p>Notice also that by providing a policy, you didn’t need to edit the code defining <code class="docutils literal notranslate"><span class="pre">loss</span></code>, <code class="docutils literal notranslate"><span class="pre">predict</span></code>, or <code class="docutils literal notranslate"><span class="pre">layer</span></code>. That is particularly convenient if you want to experiment with policies in calling code (such as a training script) without changing library code (for example, the neural network library).</p>
<p>Some policies can refer to values named with <code class="xref py py-func docutils literal notranslate"><span class="pre">jax.ad_checkpoint.checkpoint_name()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax.ad_checkpoint</span> <span class="kn">import</span> <span class="n">checkpoint_name</span>

<span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="o">*</span><span class="n">Ws</span><span class="p">,</span> <span class="n">Wlast</span> <span class="o">=</span> <span class="n">params</span>
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">W</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Ws</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">checkpoint_name</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;layer</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_output&#39;</span><span class="p">)</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Wlast</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
</div>
<p>By itself, <code class="xref py py-func docutils literal notranslate"><span class="pre">jax.ad_checkpoint.checkpoint_name()</span></code> is just an identity function. But because some policy functions know to look for them, you can use the names to control whether certain values output by <code class="xref py py-func docutils literal notranslate"><span class="pre">jax.ad_checkpoint.checkpoint_name()</span></code> are considered saveable:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_saved_residuals</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f32[4,4] from the argument params[0]
f32[4,4] from the argument params[1]
f32[4,4] from the argument params[2]
f32[4] from the argument x
f32[4] output of cos from /tmp/ipykernel_143759/4230705069.py:12:9 (layer)
f32[4] named &#39;layer0_output&#39; from /tmp/ipykernel_143759/178264713.py:7:8 (predict)
f32[4] output of cos from /tmp/ipykernel_143759/4230705069.py:12:9 (layer)
f32[4] named &#39;layer1_output&#39; from /tmp/ipykernel_143759/178264713.py:7:8 (predict)
f32[4] output of mul from /tmp/ipykernel_143759/4230705069.py:2:17 (loss)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">loss_checkpoint2</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="n">jax</span><span class="o">.</span><span class="n">checkpoint_policies</span><span class="o">.</span><span class="n">save_any_names_but_these</span><span class="p">(</span><span class="s1">&#39;layer1_output&#39;</span><span class="p">))</span>
<span class="n">print_saved_residuals</span><span class="p">(</span><span class="n">loss_checkpoint2</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f32[4,4] from the argument params[0]
f32[4,4] from the argument params[1]
f32[4,4] from the argument params[2]
f32[4] from the argument x
f32[4] from the argument y
</pre></div>
</div>
</div>
</div>
<p>Another policy which refers to names is <code class="docutils literal notranslate"><span class="pre">jax.checkpoint_policies.save_only_these_names</span></code>.</p>
</section>
<section id="custom-policies-for-offload">
<h3>Custom policies for offload<a class="headerlink" href="#custom-policies-for-offload" title="Link to this heading">#</a></h3>
<p>You may consider offloading to CPU memory instead of recomputing when checkpointing to save accelerator memory. <code class="docutils literal notranslate"><span class="pre">jax.checkpoint_policies.offload_dot_with_no_batch_dims</span></code> can offload the results of matrix multiplications with no batch dimensions to the CPU.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax.ad_checkpoint</span> <span class="kn">import</span> <span class="n">checkpoint</span>

<span class="k">def</span> <span class="nf">checkpoint_offload_dot_with_no_batch_dims</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="n">policy</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">checkpoint_policies</span><span class="o">.</span><span class="n">offload_dot_with_no_batch_dims</span><span class="p">(</span>
      <span class="s2">&quot;device&quot;</span><span class="p">,</span> <span class="s2">&quot;pinned_host&quot;</span><span class="p">)</span>

  <span class="nd">@functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="n">policy</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,jk-&gt;ik&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="n">lax</span><span class="o">.</span><span class="n">Precision</span><span class="o">.</span><span class="n">HIGHEST</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,jk-&gt;ik&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="n">lax</span><span class="o">.</span><span class="n">Precision</span><span class="o">.</span><span class="n">HIGHEST</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,jk-&gt;ik&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="n">lax</span><span class="o">.</span><span class="n">Precision</span><span class="o">.</span><span class="n">HIGHEST</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
</div>
<p>One of JAX’s checkpoint policies allows specified checkpoint names to be offloaded to CPUs. This policy is implemented through <code class="docutils literal notranslate"><span class="pre">jax.checkpoint_policies.save_and_offload_only_these_names</span></code>, which has four arguments: <code class="docutils literal notranslate"><span class="pre">names_which_can_be_saved</span></code>, <code class="docutils literal notranslate"><span class="pre">names_which_can_be_offloaded</span></code>, the offloading source, and destination. Names listed in <code class="docutils literal notranslate"><span class="pre">names_which_can_be_saved</span></code> are kept on the device, names listed in <code class="docutils literal notranslate"><span class="pre">names_which_can_be_offloaded</span></code> are moved to CPU memory, and other names or operations without names are recomputed. For example, if we have checkpoint names <code class="docutils literal notranslate"><span class="pre">y</span></code>, <code class="docutils literal notranslate"><span class="pre">z</span></code>, and <code class="docutils literal notranslate"><span class="pre">w</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code> can be saved on the device, <code class="docutils literal notranslate"><span class="pre">z</span></code> can be offloaded to CPU memory, and <code class="docutils literal notranslate"><span class="pre">w</span></code> can be recomputed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax.ad_checkpoint</span> <span class="kn">import</span> <span class="n">checkpoint</span><span class="p">,</span> <span class="n">checkpoint_name</span>
<span class="kn">from</span> <span class="nn">jax._src</span> <span class="kn">import</span> <span class="n">test_util</span> <span class="k">as</span> <span class="n">jtu</span>

<span class="k">def</span> <span class="nf">checkpoint_names_saved_offloaded_recomputed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="n">mesh</span> <span class="o">=</span> <span class="n">jtu</span><span class="o">.</span><span class="n">create_mesh</span><span class="p">((</span><span class="mi">2</span><span class="p">,),</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,))</span>
  <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
  <span class="n">np_inp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">shape</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
  <span class="n">s</span> <span class="o">=</span> <span class="n">NamedSharding</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">P</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">))</span>
  <span class="n">inp</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">device_put</span><span class="p">(</span><span class="n">np_inp</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

  <span class="n">policy</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">checkpoint_policies</span><span class="o">.</span><span class="n">save_and_offload_only_these_names</span><span class="p">(</span>
      <span class="n">names_which_can_be_saved</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span> <span class="n">names_which_can_be_offloaded</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">],</span>
      <span class="n">offload_src</span><span class="o">=</span><span class="s1">&#39;device&#39;</span><span class="p">,</span> <span class="n">offload_dst</span><span class="o">=</span><span class="s1">&#39;pinned_host&#39;</span><span class="p">)</span>

  <span class="nd">@functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="n">policy</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
      <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ys</span>
      <span class="n">y</span> <span class="o">=</span> <span class="n">checkpoint_name</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>
      <span class="n">z</span> <span class="o">=</span> <span class="n">checkpoint_name</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="s2">&quot;z&quot;</span><span class="p">)</span>
      <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">T</span>
      <span class="n">w</span> <span class="o">=</span> <span class="n">checkpoint_name</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
      <span class="k">return</span> <span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)),</span> <span class="kc">None</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">scan_out</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)),</span> <span class="p">[</span><span class="n">np_inp</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">scan_out</span>
</pre></div>
</div>
</div>
</div>
<p>The code defines a function <code class="docutils literal notranslate"><span class="pre">f</span></code> that which applies checkpointing with a custom policy. This policy determines which computations can be saved or offloaded during execution. Inside <code class="docutils literal notranslate"><span class="pre">f</span></code>, there is a nested function <code class="docutils literal notranslate"><span class="pre">g</span></code> that performs the core computations. The <code class="docutils literal notranslate"><span class="pre">jax.lax.scan</span></code> function is used to apply <code class="docutils literal notranslate"><span class="pre">g</span></code> repeatedly over the input data.</p>
</section>
<section id="list-of-policies">
<h3>List of policies<a class="headerlink" href="#list-of-policies" title="Link to this heading">#</a></h3>
<p>The policies are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">everything_saveable</span></code> (the default strategy, as if <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code> were not being used at all)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nothing_saveable</span></code> (i.e. rematerialize everything, as if a custom policy were not being used at all)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dots_saveable</span></code> or its alias <code class="docutils literal notranslate"><span class="pre">checkpoint_dots</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dots_with_no_batch_dims_saveable</span></code> or its alias <code class="docutils literal notranslate"><span class="pre">checkpoint_dots_with_no_batch_dims</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">save_anything_but_these_names</span></code> (save any values except for the output of
<code class="docutils literal notranslate"><span class="pre">checkpoint_name</span></code> with any of the names given)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">save_any_names_but_these</span></code> (save only named values, i.e. any outputs of
<code class="docutils literal notranslate"><span class="pre">checkpoint_name</span></code>, except for those with the names given)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">save_only_these_names</span></code> (save only named values, and only among the names
given)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">offload_dot_with_no_batch_dims</span></code> same as <code class="docutils literal notranslate"><span class="pre">dots_with_no_batch_dims_saveable</span></code>,
but offload to CPU memory instead of recomputing.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">save_and_offload_only_these_names</span></code> same as <code class="docutils literal notranslate"><span class="pre">save_only_these_names</span></code>, but
offload to CPU memory instead of recomputing.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">save_from_both_policies(policy_1,</span> <span class="pre">policy_2)</span></code> (like a logical <code class="docutils literal notranslate"><span class="pre">or</span></code>, so that a residual is saveable if it is saveable according to <code class="docutils literal notranslate"><span class="pre">policy_1</span></code> <em>or</em> <code class="docutils literal notranslate"><span class="pre">policy_2</span></code>)</p></li>
</ul>
<p>Policies only indicate what is saveable; a value is only saved if it’s actually needed by the backward pass.</p>
</section>
<section id="advanced-recursive-jax-checkpoint">
<h3>Advanced: Recursive <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code><a class="headerlink" href="#advanced-recursive-jax-checkpoint" title="Link to this heading">#</a></h3>
<p>By applying <a class="reference internal" href="_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> in the right way, there are many tradeoffs between memory usage and (re)computation that can be expressed. One surprising example is <em>recursive</em> checkpointing, where you apply <a class="reference internal" href="_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> to a function which itself calls <a class="reference internal" href="_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a>-decorated functions in a way so that memory usage from the chain composition of <span class="math notranslate nohighlight">\(D\)</span> functions scales like <span class="math notranslate nohighlight">\(\mathcal{O}(\log_2 D)\)</span> rather than <span class="math notranslate nohighlight">\(\mathcal{O}(D)\)</span>.</p>
<p>As a toy example, consider the chain composition of multiple <a class="reference internal" href="_autosummary/jax.numpy.sin.html#jax.numpy.sin" title="jax.numpy.sin"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.numpy.sin()</span></code></a> functions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">chain_compose</span><span class="p">(</span><span class="n">funs</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">fun</span> <span class="ow">in</span> <span class="n">funs</span><span class="p">:</span>
      <span class="n">x</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
  <span class="k">return</span> <span class="n">f</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">chain_compose</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
<span class="n">print_saved_residuals</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mf">3.</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f32[] output of cos from /tmp/ipykernel_143759/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_143759/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_143759/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_143759/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_143759/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_143759/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_143759/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_143759/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
</pre></div>
</div>
</div>
</div>
<p>In general, the number of stored residuals scales linearly with the length of the chain:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">chain_compose</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">print_saved_residuals</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mf">3.</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f32[] output of cos from /tmp/ipykernel_143759/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_143759/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_143759/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_143759/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_143759/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_143759/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_143759/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_143759/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_143759/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_143759/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_143759/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_143759/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_143759/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_143759/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_143759/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_143759/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
</pre></div>
</div>
</div>
</div>
<p>But you can apply <a class="reference internal" href="_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> recursively to improve the scaling:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">recursive_checkpoint</span><span class="p">(</span><span class="n">funs</span><span class="p">):</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">funs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">funs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">funs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">f1</span><span class="p">,</span> <span class="n">f2</span> <span class="o">=</span> <span class="n">funs</span>
    <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">f1</span><span class="p">(</span><span class="n">f2</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">recursive_checkpoint</span><span class="p">(</span><span class="n">funs</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">funs</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">f2</span> <span class="o">=</span> <span class="n">recursive_checkpoint</span><span class="p">(</span><span class="n">funs</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">funs</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">:])</span>
    <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">f1</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">(</span><span class="n">f2</span><span class="p">)(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">recursive_checkpoint</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
<span class="n">print_saved_residuals</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mf">3.</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f32[] from the argument x
f32[] output of sin from /tmp/ipykernel_143759/1943107544.py:6:21 (recursive_checkpoint.&lt;locals&gt;.&lt;lambda&gt;)
f32[] output of cos from /tmp/ipykernel_143759/1943107544.py:6:24 (recursive_checkpoint.&lt;locals&gt;.&lt;lambda&gt;)
f32[] output of cos from /tmp/ipykernel_143759/1943107544.py:6:21 (recursive_checkpoint.&lt;locals&gt;.&lt;lambda&gt;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">recursive_checkpoint</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">print_saved_residuals</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mf">3.</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f32[] from the argument x
f32[] output of sin from /tmp/ipykernel_143759/1943107544.py:6:21 (recursive_checkpoint.&lt;locals&gt;.&lt;lambda&gt;)
f32[] output of sin from /tmp/ipykernel_143759/1943107544.py:6:21 (recursive_checkpoint.&lt;locals&gt;.&lt;lambda&gt;)
f32[] output of cos from /tmp/ipykernel_143759/1943107544.py:6:24 (recursive_checkpoint.&lt;locals&gt;.&lt;lambda&gt;)
f32[] output of cos from /tmp/ipykernel_143759/1943107544.py:6:21 (recursive_checkpoint.&lt;locals&gt;.&lt;lambda&gt;)
</pre></div>
</div>
</div>
</div>
<p>The cost here, as usual, is recomputation: in particular, you end up performing <span class="math notranslate nohighlight">\(\mathcal{O}(\log_2 D)\)</span> times as many FLOPs:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">chain_compose</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
<span class="n">print_fwd_bwd</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mf">3.</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">                                                                                                                                 
  <span style="color: #008000; text-decoration-color: #008000; font-weight: bold">forward computation:</span>                  <span style="color: #008000; text-decoration-color: #008000; font-weight: bold">backward computation:</span>                                                                    
                                                                                                                                 
  { <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">lambda </span><span style="color: #000000; text-decoration-color: #000000">; a</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000">. </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">let</span>               { <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">lambda </span><span style="color: #000000; text-decoration-color: #000000">; a</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> b</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> c</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> d</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> e</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> f</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> g</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> h</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> i</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000">. </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">let</span>  
  <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">    </span><span style="color: #000000; text-decoration-color: #000000">b</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = sin a</span>                   <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">    </span><span style="color: #000000; text-decoration-color: #000000">j</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = mul i h</span>                                                                    
  <span style="color: #000000; text-decoration-color: #000000">    c</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = cos a</span>                   <span style="color: #000000; text-decoration-color: #000000">    k</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = mul j g</span>                                                                    
  <span style="color: #000000; text-decoration-color: #000000">    d</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = sin b</span>                   <span style="color: #000000; text-decoration-color: #000000">    l</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = mul k f</span>                                                                    
  <span style="color: #000000; text-decoration-color: #000000">    e</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = cos b</span>                   <span style="color: #000000; text-decoration-color: #000000">    m</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = mul l e</span>                                                                    
  <span style="color: #000000; text-decoration-color: #000000">    f</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = sin d</span>                   <span style="color: #000000; text-decoration-color: #000000">    n</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = mul m d</span>                                                                    
  <span style="color: #000000; text-decoration-color: #000000">    g</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = cos d</span>                   <span style="color: #000000; text-decoration-color: #000000">    o</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = mul n c</span>                                                                    
  <span style="color: #000000; text-decoration-color: #000000">    h</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = sin f</span>                   <span style="color: #000000; text-decoration-color: #000000">    p</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = mul o b</span>                                                                    
  <span style="color: #000000; text-decoration-color: #000000">    i</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = cos f</span>                   <span style="color: #000000; text-decoration-color: #000000">    q</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = mul p a</span>                                                                    
  <span style="color: #000000; text-decoration-color: #000000">    j</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = sin h</span>                   <span style="color: #000000; text-decoration-color: #000000">  </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">in </span><span style="color: #000000; text-decoration-color: #000000">(q,) }</span>                                                                              
  <span style="color: #000000; text-decoration-color: #000000">    k</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = cos h</span>                                                                                                            
  <span style="color: #000000; text-decoration-color: #000000">    l</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = sin j</span>                                                                                                            
  <span style="color: #000000; text-decoration-color: #000000">    m</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = cos j</span>                                                                                                            
  <span style="color: #000000; text-decoration-color: #000000">    n</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = sin l</span>                                                                                                            
  <span style="color: #000000; text-decoration-color: #000000">    o</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = cos l</span>                                                                                                            
  <span style="color: #000000; text-decoration-color: #000000">    p</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = sin n</span>                                                                                                            
  <span style="color: #000000; text-decoration-color: #000000">    q</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = cos n</span>                                                                                                            
  <span style="color: #000000; text-decoration-color: #000000">  </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">in </span><span style="color: #000000; text-decoration-color: #000000">(p, c, e, g, i, k, m, o, q) }</span>                                                                                             
</pre>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">recursive_checkpoint</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
<span class="n">print_fwd_bwd</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mf">3.</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">                                                                                                                                        
  <span style="color: #008000; text-decoration-color: #008000; font-weight: bold">forward computation:</span>                                                              <span style="color: #008000; text-decoration-color: #008000; font-weight: bold">backward computation:</span>                               
                                                                                                                                        
  { <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">lambda </span><span style="color: #000000; text-decoration-color: #000000">; a</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000">. </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">let</span>                                                           { <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">lambda </span><span style="color: #000000; text-decoration-color: #000000">; a</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> b</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> c</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> d</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000">. </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">let</span>     
  <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">    </span><span style="color: #000000; text-decoration-color: #000000">b</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = remat2[</span>                                                             <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">    </span><span style="color: #000000; text-decoration-color: #000000">e</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = mul d c</span>                               
  <span style="color: #000000; text-decoration-color: #000000">      differentiated=False</span>                                                        <span style="color: #000000; text-decoration-color: #000000">    f</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = mul e b</span>                               
  <span style="color: #000000; text-decoration-color: #000000">      jaxpr={ </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">lambda </span><span style="color: #000000; text-decoration-color: #000000">; c</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000">. </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">let</span><span style="color: #000000; text-decoration-color: #000000"> d</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = sin c; e</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = sin d </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">in </span><span style="color: #000000; text-decoration-color: #000000">(e,) }</span>    <span style="color: #000000; text-decoration-color: #000000">    g</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = remat2[</span>                               
  <span style="color: #000000; text-decoration-color: #000000">      policy=None</span>                                                                 <span style="color: #000000; text-decoration-color: #000000">      differentiated=True</span>                           
  <span style="color: #000000; text-decoration-color: #000000">      prevent_cse=True</span>                                                            <span style="color: #000000; text-decoration-color: #000000">      jaxpr={ </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">lambda </span><span style="color: #000000; text-decoration-color: #000000">; h</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> i</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000">. </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">let</span>         
  <span style="color: #000000; text-decoration-color: #000000">    ] a</span>                                                                           <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">          </span><span style="color: #000000; text-decoration-color: #000000">j</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = sin h</span>                           
  <span style="color: #000000; text-decoration-color: #000000">    f</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = sin b</span>                                                               <span style="color: #000000; text-decoration-color: #000000">          k</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = cos h</span>                           
  <span style="color: #000000; text-decoration-color: #000000">    g</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = sin f</span>                                                               <span style="color: #000000; text-decoration-color: #000000">          l</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = cos j</span>                           
  <span style="color: #000000; text-decoration-color: #000000">    h</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = sin g</span>                                                               <span style="color: #000000; text-decoration-color: #000000">          m</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = mul i l</span>                         
  <span style="color: #000000; text-decoration-color: #000000">    i</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = sin h</span>                                                               <span style="color: #000000; text-decoration-color: #000000">          n</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = mul m k</span>                         
  <span style="color: #000000; text-decoration-color: #000000">    j</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = sin i</span>                                                               <span style="color: #000000; text-decoration-color: #000000">        </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">in </span><span style="color: #000000; text-decoration-color: #000000">(n,) }</span>                                   
  <span style="color: #000000; text-decoration-color: #000000">    k</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = cos i</span>                                                               <span style="color: #000000; text-decoration-color: #000000">      policy=None</span>                                   
  <span style="color: #000000; text-decoration-color: #000000">    l</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = sin j</span>                                                               <span style="color: #000000; text-decoration-color: #000000">      prevent_cse=True</span>                              
  <span style="color: #000000; text-decoration-color: #000000">    m</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = cos j</span>                                                               <span style="color: #000000; text-decoration-color: #000000">    ] a f</span>                                           
  <span style="color: #000000; text-decoration-color: #000000">  </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">in </span><span style="color: #000000; text-decoration-color: #000000">(l, a, g, k, m) }</span>                                                            <span style="color: #000000; text-decoration-color: #000000">    o</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = remat2[</span>                               
                                                                                    <span style="color: #000000; text-decoration-color: #000000">      differentiated=True</span>                           
                                                                                    <span style="color: #000000; text-decoration-color: #000000">      jaxpr={ </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">lambda </span><span style="color: #000000; text-decoration-color: #000000">; p</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> q</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000">. </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">let</span>         
                                                                                    <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">          </span><span style="color: #000000; text-decoration-color: #000000">r</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = sin p</span>                           
                                                                                    <span style="color: #000000; text-decoration-color: #000000">          s</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = sin r</span>                           
                                                                                    <span style="color: #000000; text-decoration-color: #000000">          t</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = sin s</span>                           
                                                                                    <span style="color: #000000; text-decoration-color: #000000">          u</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = cos s</span>                           
                                                                                    <span style="color: #000000; text-decoration-color: #000000">          v</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = cos t</span>                           
                                                                                    <span style="color: #000000; text-decoration-color: #000000">          w</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = mul q v</span>                         
                                                                                    <span style="color: #000000; text-decoration-color: #000000">          x</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = mul w u</span>                         
                                                                                    <span style="color: #000000; text-decoration-color: #000000">          y</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = remat2[</span>                         
                                                                                    <span style="color: #000000; text-decoration-color: #000000">            differentiated=True</span>                     
                                                                                    <span style="color: #000000; text-decoration-color: #000000">            jaxpr={ </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">lambda </span><span style="color: #000000; text-decoration-color: #000000">; z</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> ba</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000">. </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">let</span>  
                                                                                    <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">                </span><span style="color: #000000; text-decoration-color: #000000">bb</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = sin z</span>                    
                                                                                    <span style="color: #000000; text-decoration-color: #000000">                bc</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = cos z</span>                    
                                                                                    <span style="color: #000000; text-decoration-color: #000000">                bd</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = cos bb</span>                   
                                                                                    <span style="color: #000000; text-decoration-color: #000000">                be</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = mul ba bd</span>                
                                                                                    <span style="color: #000000; text-decoration-color: #000000">                bf</span><span style="color: #800080; text-decoration-color: #800080">:f32[]</span><span style="color: #000000; text-decoration-color: #000000"> = mul be bc</span>                
                                                                                    <span style="color: #000000; text-decoration-color: #000000">              </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">in </span><span style="color: #000000; text-decoration-color: #000000">(bf,) }</span>                            
                                                                                    <span style="color: #000000; text-decoration-color: #000000">            policy=None</span>                             
                                                                                    <span style="color: #000000; text-decoration-color: #000000">            prevent_cse=True</span>                        
                                                                                    <span style="color: #000000; text-decoration-color: #000000">          ] p x</span>                                     
                                                                                    <span style="color: #000000; text-decoration-color: #000000">        </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">in </span><span style="color: #000000; text-decoration-color: #000000">(y,) }</span>                                   
                                                                                    <span style="color: #000000; text-decoration-color: #000000">      policy=None</span>                                   
                                                                                    <span style="color: #000000; text-decoration-color: #000000">      prevent_cse=True</span>                              
                                                                                    <span style="color: #000000; text-decoration-color: #000000">    ] 3.0:f32[] g</span>                                   
                                                                                    <span style="color: #000000; text-decoration-color: #000000">  </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">in </span><span style="color: #000000; text-decoration-color: #000000">(o,) }</span>                                         
</pre>
</div></div>
</div>
</section>
</section>
<section id="practical-notes">
<span id="gradient-checkpointing-practical-notes"></span><h2>Practical notes<a class="headerlink" href="#practical-notes" title="Link to this heading">#</a></h2>
<p>When differentiated functions are staged out to XLA for compilation — for example by applying <a class="reference internal" href="_autosummary/jax.jit.html#jax.jit" title="jax.jit"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.jit()</span></code></a> to a function which contains a <a class="reference internal" href="_autosummary/jax.grad.html#jax.grad" title="jax.grad"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.grad()</span></code></a> call — XLA will automatically optimize the computation, including decisions about when to compute or rematerialize values. As a result, <strong><a class="reference internal" href="_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> often isn’t needed for differentiated functions under a <a class="reference internal" href="_autosummary/jax.jit.html#jax.jit" title="jax.jit"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.jit()</span></code></a></strong>. XLA will optimize things for you.</p>
<p>One exception is when using staged-out control flow, like <a class="reference internal" href="_autosummary/jax.lax.scan.html#jax.lax.scan" title="jax.lax.scan"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.lax.scan()</span></code></a>. Automatic compiler optimizations across multiple control flow primitives (for example, across a forward-pass <code class="docutils literal notranslate"><span class="pre">scan</span></code> and the corresponding backward-pass <code class="docutils literal notranslate"><span class="pre">scan</span></code>), typically aren’t as thorough. As a result, it’s often a good idea to use <a class="reference internal" href="_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> on the body function passed to <a class="reference internal" href="_autosummary/jax.lax.scan.html#jax.lax.scan" title="jax.lax.scan"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.lax.scan()</span></code></a>.</p>
<p>For example, one common pattern in large <a class="reference external" href="https://en.wikipedia.org/wiki/Transformer_(machine_learning_model)">Transformer models</a> is to express the architecture as a <a class="reference internal" href="_autosummary/jax.lax.scan.html#jax.lax.scan" title="jax.lax.scan"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.lax.scan()</span></code></a> over layers so as to reduce compilation times. That is, using a simple fully-connected network as an analogy, instead of writing something like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">LayerParam</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>  <span class="c1"># Weights-bias pair for a layer.</span>
<span class="n">ParamsList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">LayerParam</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">net</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">ParamsList</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">W</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
</div>
<p>Instead, iterate over the layer application with <a class="reference internal" href="_autosummary/jax.lax.scan.html#jax.lax.scan" title="jax.lax.scan"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.lax.scan()</span></code></a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">params</span> <span class="o">=</span> <span class="p">[(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]]),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])),</span> 
          <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]]),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]))]</span>

<span class="n">all_weights</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">W</span> <span class="k">for</span> <span class="n">W</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">params</span><span class="p">])</span>
<span class="n">all_biases</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">b</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">params</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">layer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">W_b_pair</span><span class="p">):</span>
  <span class="n">W</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">W_b_pair</span>
  <span class="n">out</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">net</span><span class="p">(</span><span class="n">all_weights</span><span class="p">,</span> <span class="n">all_biases</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">all_weights</span><span class="p">,</span> <span class="n">all_biases</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
</div>
<p>This scan-over-layers version reduces compile times, but by foiling some compiler optimizations it can lead to inefficient computation of gradients. To mitigate the issue, you can use <a class="reference internal" href="_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> on the scanned function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">,</span>
         <span class="n">policy</span><span class="o">=</span><span class="n">jax</span><span class="o">.</span><span class="n">checkpoint_policies</span><span class="o">.</span><span class="n">dots_with_no_batch_dims_saveable</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">layer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">W_b_pair</span><span class="p">):</span>
  <span class="n">W</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">W_b_pair</span>
  <span class="n">out</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
</div>
<p>By using <a class="reference internal" href="_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> this way, you’re manually controlling which values JAX’s autodiff saves between the forward and backward passes, and therefore not relying on XLA optimizations to choose for you.</p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="ffi.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Foreign function interface (FFI)</p>
      </div>
    </a>
    <a class="right-next"
       href="aot.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Ahead-of-time lowering and compilation</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#let-s-think-step-by-step">Let’s think step by step</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#jax-checkpoint-fundamentals"><code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code> fundamentals</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-policies-for-what-s-saveable">Custom policies for what’s saveable</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-policies-for-offload">Custom policies for offload</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#list-of-policies">List of policies</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-recursive-jax-checkpoint">Advanced: Recursive <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#practical-notes">Practical notes</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The JAX authors
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024, The JAX Authors.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>