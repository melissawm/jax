
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Design of Type Promotion Semantics for JAX &#8212; JAX  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/style.css?v=17fd2dad" />
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=30646c52"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'jep/9407-type-promotion';</script>
    <link rel="icon" href="../_static/favicon.png"/>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Jax and Jaxlib versioning" href="9419-jax-versioning.html" />
    <link rel="prev" title="JEP 9263: Typed keys &amp; pluggable RNGs" href="9263-typed-keys.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/jax_logo_250px.png" class="logo__image only-light" alt="JAX  documentation - Home"/>
    <script>document.write(`<img src="../_static/jax_logo_250px.png" class="logo__image only-dark" alt="JAX  documentation - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/thinking_in_jax.html">Quickstart: How to think in JAX</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../notebooks/Common_Gotchas_in_JAX.html">üî™ JAX - The Sharp Bits üî™</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../jax-101.html">JAX 101</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../jit-compilation.html">Just-in-time compilation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../automatic-vectorization.html">Automatic vectorization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../automatic-differentiation.html">Automatic differentiation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../working-with-pytrees.html">Working with pytrees</a></li>
<li class="toctree-l2"><a class="reference internal" href="../random-numbers.html">Pseudorandom numbers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../control-flow.html">Control flow and logical operators with JIT</a></li>
<li class="toctree-l2"><a class="reference internal" href="../stateful-computations.html">Stateful computations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sharded-computation.html">Introduction to parallel programming</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Resources, guides, and references</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../key-concepts.html">Key concepts</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../advanced_guides.html">Resources and Advanced Guides</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/Distributed_arrays_and_automatic_parallelization.html">Distributed arrays and automatic parallelization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/explicit-sharding.html">Explicit sharding (a.k.a. ‚Äúsharding in types‚Äù)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/shard_map.html">Manual parallelism with <code class="docutils literal notranslate"><span class="pre">shard_map</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/layout.html">Device-local array layout control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/host-offloading.html">JAX Memories and Host Offloading</a></li>

<li class="toctree-l2"><a class="reference internal" href="../multi_process.html">Introduction to multi-controller JAX (aka multi-process/multi-host JAX)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../distributed_data_loading.html">Distributed data loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../the-training-cookbook.html">The Training Cookbook</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/autodiff_cookbook.html">The Autodiff Cookbook</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/Custom_derivative_rules_for_Python_code.html">Custom derivative rules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/autodiff_remat.html">Control autodiff‚Äôs saved values with <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code> (aka <code class="docutils literal notranslate"><span class="pre">jax.remat</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../advanced-autodiff.html">Advanced automatic differentiation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../errors.html">Errors</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../debugging.html">Introduction to debugging</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../debugging/print_breakpoint.html">Compiled prints and breakpoints</a></li>
<li class="toctree-l3"><a class="reference internal" href="../debugging/checkify_guide.html">The <code class="docutils literal notranslate"><span class="pre">checkify</span></code> transformation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../debugging/flags.html">JAX debugging flags</a></li>
<li class="toctree-l2"><a class="reference internal" href="../transfer_guard.html">Transfer guard</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pytrees.html">Pytrees</a></li>
<li class="toctree-l2"><a class="reference internal" href="../persistent_compilation_cache.html">Persistent compilation cache</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gpu_performance_tips.html">GPU performance tips</a></li>
<li class="toctree-l2"><a class="reference internal" href="../profiling.html">Profiling computation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../device_memory_profiling.html">Profiling device memory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../array_refs.html"><code class="docutils literal notranslate"><span class="pre">ArrayRef</span></code>: mutable arrays for data plumbing and memory control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../external-callbacks.html">External callbacks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ffi.html">Foreign function interface (FFI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gradient-checkpointing.html">Gradient checkpointing with <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code> (<code class="docutils literal notranslate"><span class="pre">jax.remat</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../aot.html">Ahead-of-time lowering and compilation</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../export/index.html">Exporting and serialization</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../export/export.html">Exporting and serializing staged-out computations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../export/shape_poly.html">Shape polymorphism</a></li>
<li class="toctree-l3"><a class="reference internal" href="../export/jax2tf.html">Interoperation with TensorFlow</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../pallas/index.html">Pallas: a JAX kernel language</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../pallas/quickstart.html">Pallas Quickstart</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pallas/pipelining.html">Software Pipelining</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pallas/grid_blockspec.html">Grids and BlockSpecs</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../pallas/tpu/index.html">Pallas TPU</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../pallas/tpu/details.html">Writing TPU kernels with Pallas</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pallas/tpu/pipelining.html">TPU Pipelining</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pallas/tpu/matmul.html">Matrix Multiplication</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pallas/tpu/sparse.html">Scalar Prefetch and Block-Sparse Computation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pallas/tpu/distributed.html">Distributed Computing in Pallas for TPUs</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../pallas/gpu/index.html">Pallas:Mosaic GPU</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../pallas/gpu/reference.html">Writing Mosaic GPU kernels with Pallas</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pallas/gpu/pipelining.html">Mosaic GPU Pipelining</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../pallas/design/index.html">Pallas Design Notes</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../pallas/design/design.html">Pallas Design</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pallas/design/async_note.html">Pallas Async Operations</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../pallas/CHANGELOG.html">Pallas Changelog</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/neural_network_with_tfds_data.html">Training a simple neural network, with tensorflow/datasets data loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/Neural_Network_and_Data_Loading.html">Training a simple neural network, with PyTorch data loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/vmapped_log_probs.html">Autobatching for Bayesian inference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/convolutions.html">Generalized convolutions in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../xla_flags.html">XLA compiler flags</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-primitives.html">JAX Internals: primitives</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jaxpr.html">JAX internals: The jaxpr language</a></li>
</ul>
</li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../contributor_guide.html">Developer notes</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-9"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../contributing.html">Contributing to JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer.html">Building from source</a></li>
<li class="toctree-l2"><a class="reference internal" href="../investigating_a_regression.html">Investigating a regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../autodidax.html">Autodidax: JAX core from scratch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../autodidax2_part1.html">Autodidax2, part 1: JAX from scratch, again</a></li>

<li class="toctree-l2 current active has-children"><a class="reference internal" href="index.html">JAX Enhancement Proposals (JEPs)</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-10"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="263-prng.html">263: JAX PRNG Design</a></li>
<li class="toctree-l3"><a class="reference internal" href="2026-custom-derivatives.html">2026: Custom JVP/VJP rules for JAX-transformable functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="4008-custom-vjp-update.html">4008: Custom VJP and `nondiff_argnums` update</a></li>
<li class="toctree-l3"><a class="reference internal" href="4410-omnistaging.html">4410: Omnistaging</a></li>
<li class="toctree-l3"><a class="reference internal" href="9263-typed-keys.html">9263: Typed keys &amp; pluggable RNGs</a></li>
<li class="toctree-l3 current active"><a class="current reference internal" href="#">9407: Design of Type Promotion Semantics for JAX</a></li>
<li class="toctree-l3"><a class="reference internal" href="9419-jax-versioning.html">9419: Jax and Jaxlib versioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="10657-sequencing-effects.html">10657: Sequencing side-effects in JAX</a></li>
<li class="toctree-l3"><a class="reference internal" href="11830-new-remat-checkpoint.html">11830: `jax.remat` / `jax.checkpoint` new implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="12049-type-annotations.html">12049: Type Annotation Roadmap for JAX</a></li>
<li class="toctree-l3"><a class="reference internal" href="14273-shard-map.html">14273: `shard_map` (`shmap`) for simple per-device code</a></li>
<li class="toctree-l3"><a class="reference internal" href="15856-jex.html">15856: `jax.extend`, an extensions module</a></li>
<li class="toctree-l3"><a class="reference internal" href="17111-shmap-transpose.html">17111: Efficient transposition of `shard_map` (and other maps)</a></li>
<li class="toctree-l3"><a class="reference internal" href="18137-numpy-scipy-scope.html">18137: Scope of JAX NumPy &amp; SciPy Wrappers</a></li>
<li class="toctree-l3"><a class="reference internal" href="25516-effver.html">25516: Effort-based versioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="28661-jax-array-protocol.html">28661: Supporting the `__jax_array__` protocol</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../internals/index.html">JAX Internal Implementation Notes</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-11"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../internals/constants.html">Handling of closed-over constants</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../extensions.html">Extension guides</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-12"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/Writing_custom_interpreters_in_Jax.html">Writing custom Jaxpr interpreters in JAX</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.extend.html"><code class="docutils literal notranslate"><span class="pre">jax.extend</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-13"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.core.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.core</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.linear_util.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.linear_util</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.mlir.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.mlir</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.random.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.random</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../building_on_jax.html">Building on JAX</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../notes.html">Notes</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-14"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../api_compatibility.html">API compatibility</a></li>
<li class="toctree-l2"><a class="reference internal" href="../deprecation.html">Python and NumPy version support policy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../async_dispatch.html">Asynchronous dispatch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concurrency.html">Concurrency</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gpu_memory_allocation.html">GPU memory allocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rank_promotion_warning.html">Rank promotion warning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../type_promotion.html">Type promotion semantics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../default_dtypes.html">Default dtypes and the X64 flag</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../jax.html">Public API: <code class="docutils literal notranslate"><span class="pre">jax</span></code> package</a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-15"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.numpy.html"><code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-16"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fft.html">jax.numpy.fft.fft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fft2.html">jax.numpy.fft.fft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fftfreq.html">jax.numpy.fft.fftfreq</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fftn.html">jax.numpy.fft.fftn</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fftshift.html">jax.numpy.fft.fftshift</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.hfft.html">jax.numpy.fft.hfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ifft.html">jax.numpy.fft.ifft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ifft2.html">jax.numpy.fft.ifft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ifftn.html">jax.numpy.fft.ifftn</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ifftshift.html">jax.numpy.fft.ifftshift</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ihfft.html">jax.numpy.fft.ihfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.irfft.html">jax.numpy.fft.irfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.irfft2.html">jax.numpy.fft.irfft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.irfftn.html">jax.numpy.fft.irfftn</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.rfft.html">jax.numpy.fft.rfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.rfft2.html">jax.numpy.fft.rfft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.rfftfreq.html">jax.numpy.fft.rfftfreq</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.rfftn.html">jax.numpy.fft.rfftn</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.scipy.html"><code class="docutils literal notranslate"><span class="pre">jax.scipy</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-17"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.scipy.stats.bernoulli.logpmf.html">jax.scipy.stats.bernoulli.logpmf</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.scipy.stats.bernoulli.pmf.html">jax.scipy.stats.bernoulli.pmf</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.scipy.stats.bernoulli.cdf.html">jax.scipy.stats.bernoulli.cdf</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.scipy.stats.bernoulli.ppf.html">jax.scipy.stats.bernoulli.ppf</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../jax.lax.html"><code class="docutils literal notranslate"><span class="pre">jax.lax</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.random.html"><code class="docutils literal notranslate"><span class="pre">jax.random</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.sharding.html"><code class="docutils literal notranslate"><span class="pre">jax.sharding</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.debug.html"><code class="docutils literal notranslate"><span class="pre">jax.debug</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.dlpack.html"><code class="docutils literal notranslate"><span class="pre">jax.dlpack</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.distributed.html"><code class="docutils literal notranslate"><span class="pre">jax.distributed</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.dtypes.html"><code class="docutils literal notranslate"><span class="pre">jax.dtypes</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.ffi.html"><code class="docutils literal notranslate"><span class="pre">jax.ffi</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.flatten_util.html"><code class="docutils literal notranslate"><span class="pre">jax.flatten_util</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.image.html"><code class="docutils literal notranslate"><span class="pre">jax.image</span></code> module</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.nn.html"><code class="docutils literal notranslate"><span class="pre">jax.nn</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-18"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jax.nn.initializers.html"><code class="docutils literal notranslate"><span class="pre">jax.nn.initializers</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../jax.ops.html"><code class="docutils literal notranslate"><span class="pre">jax.ops</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.profiler.html"><code class="docutils literal notranslate"><span class="pre">jax.profiler</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.ref.html"><code class="docutils literal notranslate"><span class="pre">jax.ref</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.stages.html"><code class="docutils literal notranslate"><span class="pre">jax.stages</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.test_util.html"><code class="docutils literal notranslate"><span class="pre">jax.test_util</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.tree.html"><code class="docutils literal notranslate"><span class="pre">jax.tree</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.tree_util.html"><code class="docutils literal notranslate"><span class="pre">jax.tree_util</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.typing.html"><code class="docutils literal notranslate"><span class="pre">jax.typing</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.export.html"><code class="docutils literal notranslate"><span class="pre">jax.export</span></code> module</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.extend.html"><code class="docutils literal notranslate"><span class="pre">jax.extend</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-19"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.core.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.core</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.linear_util.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.linear_util</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.mlir.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.mlir</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.random.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.random</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.example_libraries.html"><code class="docutils literal notranslate"><span class="pre">jax.example_libraries</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-20" name="toctree-checkbox-20" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-20"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jax.example_libraries.optimizers.html"><code class="docutils literal notranslate"><span class="pre">jax.example_libraries.optimizers</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.example_libraries.stax.html"><code class="docutils literal notranslate"><span class="pre">jax.example_libraries.stax</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.experimental.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-21" name="toctree-checkbox-21" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-21"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.checkify.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.checkify</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.compilation_cache.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.compilation_cache</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.custom_dce.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.custom_dce</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.custom_partitioning.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.custom_partitioning</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.jet.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.jet</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.key_reuse.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.key_reuse</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.mesh_utils.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.mesh_utils</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.multihost_utils.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.multihost_utils</span></code> module</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../jax.experimental.pallas.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.pallas</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-22" name="toctree-checkbox-22" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-22"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../jax.experimental.pallas.mosaic_gpu.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.pallas.mosaic_gpu</span></code> module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../jax.experimental.pallas.triton.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.pallas.triton</span></code> module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../jax.experimental.pallas.tpu.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.pallas.tpu</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.pjit.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.pjit</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.serialize_executable.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.serialize_executable</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.shard_map.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.shard_map</span></code> module</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../jax.experimental.sparse.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.sparse</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-23" name="toctree-checkbox-23" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-23"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.BCOO.html">jax.experimental.sparse.BCOO</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_broadcast_in_dim.html">jax.experimental.sparse.bcoo_broadcast_in_dim</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_concatenate.html">jax.experimental.sparse.bcoo_concatenate</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_dot_general.html">jax.experimental.sparse.bcoo_dot_general</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_dot_general_sampled.html">jax.experimental.sparse.bcoo_dot_general_sampled</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_dynamic_slice.html">jax.experimental.sparse.bcoo_dynamic_slice</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_extract.html">jax.experimental.sparse.bcoo_extract</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_fromdense.html">jax.experimental.sparse.bcoo_fromdense</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_gather.html">jax.experimental.sparse.bcoo_gather</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_multiply_dense.html">jax.experimental.sparse.bcoo_multiply_dense</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_multiply_sparse.html">jax.experimental.sparse.bcoo_multiply_sparse</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_update_layout.html">jax.experimental.sparse.bcoo_update_layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_reduce_sum.html">jax.experimental.sparse.bcoo_reduce_sum</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_reshape.html">jax.experimental.sparse.bcoo_reshape</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_slice.html">jax.experimental.sparse.bcoo_slice</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_sort_indices.html">jax.experimental.sparse.bcoo_sort_indices</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_squeeze.html">jax.experimental.sparse.bcoo_squeeze</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_sum_duplicates.html">jax.experimental.sparse.bcoo_sum_duplicates</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_todense.html">jax.experimental.sparse.bcoo_todense</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_transpose.html">jax.experimental.sparse.bcoo_transpose</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../jax.lib.html"><code class="docutils literal notranslate"><span class="pre">jax.lib</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.addressable_shards.html">jax.Array.addressable_shards</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.all.html">jax.Array.all</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.any.html">jax.Array.any</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.argmax.html">jax.Array.argmax</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.argmin.html">jax.Array.argmin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.argpartition.html">jax.Array.argpartition</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.argsort.html">jax.Array.argsort</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.astype.html">jax.Array.astype</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.at.html">jax.Array.at</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.choose.html">jax.Array.choose</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.clip.html">jax.Array.clip</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.compress.html">jax.Array.compress</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.committed.html">jax.Array.committed</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.conj.html">jax.Array.conj</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.conjugate.html">jax.Array.conjugate</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.copy.html">jax.Array.copy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.copy_to_host_async.html">jax.Array.copy_to_host_async</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.cumprod.html">jax.Array.cumprod</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.cumsum.html">jax.Array.cumsum</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.device.html">jax.Array.device</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.diagonal.html">jax.Array.diagonal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.dot.html">jax.Array.dot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.dtype.html">jax.Array.dtype</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.flat.html">jax.Array.flat</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.flatten.html">jax.Array.flatten</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.global_shards.html">jax.Array.global_shards</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.imag.html">jax.Array.imag</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.is_fully_addressable.html">jax.Array.is_fully_addressable</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.is_fully_replicated.html">jax.Array.is_fully_replicated</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.item.html">jax.Array.item</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.itemsize.html">jax.Array.itemsize</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.max.html">jax.Array.max</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.mean.html">jax.Array.mean</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.min.html">jax.Array.min</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.nbytes.html">jax.Array.nbytes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.ndim.html">jax.Array.ndim</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.nonzero.html">jax.Array.nonzero</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.prod.html">jax.Array.prod</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.ptp.html">jax.Array.ptp</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.ravel.html">jax.Array.ravel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.real.html">jax.Array.real</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.repeat.html">jax.Array.repeat</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.reshape.html">jax.Array.reshape</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.round.html">jax.Array.round</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.searchsorted.html">jax.Array.searchsorted</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.shape.html">jax.Array.shape</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.sharding.html">jax.Array.sharding</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.size.html">jax.Array.size</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.sort.html">jax.Array.sort</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.squeeze.html">jax.Array.squeeze</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.std.html">jax.Array.std</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.sum.html">jax.Array.sum</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.swapaxes.html">jax.Array.swapaxes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.take.html">jax.Array.take</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.to_device.html">jax.Array.to_device</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.trace.html">jax.Array.trace</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.transpose.html">jax.Array.transpose</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.var.html">jax.Array.var</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.view.html">jax.Array.view</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.T.html">jax.Array.T</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.mT.html">jax.Array.mT</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../about.html">About the project</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../faq.html">Frequently asked questions (FAQ)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Change log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary of terms</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../config_options.html">Configuration Options</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../contributor_guide.html" class="nav-link">Developer notes</a></li>
    
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">JAX Enhancement Proposals (JEPs)</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Design of...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/jax-ml/jax" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/jep/9407-type-promotion.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Design of Type Promotion Semantics for JAX</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#goals-of-jax-type-promotion">Goals of JAX Type Promotion</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#stepping-back-tables-and-lattices">Stepping Back: Tables and Lattices</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#properties-of-a-type-promotion-lattice">Properties of a Type Promotion Lattice</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#type-promotion-within-categories">Type Promotion within Categories</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#enter-python-scalars">Enter Python Scalars</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#combining-lattices">Combining Lattices</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mixed-promotion-float-and-complex">Mixed Promotion: Float and Complex</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mixed-promotion-signed-unsigned-integers">Mixed Promotion: Signed &amp; Unsigned Integers</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-handle-uint64">How to handle <code class="docutils literal notranslate"><span class="pre">uint64</span></code>?</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mixed-promotion-integer-and-floating">Mixed Promotion: Integer and Floating</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#option-0-leave-integer-floating-mixed-precision-undefined">Option 0: Leave integer/floating mixed precision undefined</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#option-1-avoiding-all-precision-loss">Option 1: Avoiding All Precision Loss</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#option-2-avoid-most-wider-than-necessary-promotions">Option 2: Avoid most wider-than-necessary promotions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#option-3-avoid-all-wider-than-necessary-promotions">Option 3: Avoid all wider-than-necessary promotions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#type-promotion-in-jax">Type Promotion in JAX</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#appendix-example-type-promotion-tables">Appendix: Example Type Promotion Tables</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#numpy-type-promotion">NumPy Type Promotion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tensorflow-type-promotion">Tensorflow Type Promotion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pytorch-type-promotion">PyTorch Type Promotion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#jax-type-promotion-jax-numpy">JAX Type Promotion: <code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#jax-type-promotion-jax-lax">JAX Type Promotion: <code class="docutils literal notranslate"><span class="pre">jax.lax</span></code></a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="design-of-type-promotion-semantics-for-jax">
<h1>Design of Type Promotion Semantics for JAX<a class="headerlink" href="#design-of-type-promotion-semantics-for-jax" title="Link to this heading">#</a></h1>
<p><a class="reference external" href="https://colab.research.google.com/github/jax-ml/jax/blob/main/docs/jep/9407-type-promotion.ipynb"><img alt="Open in Colab" src="https://colab.research.google.com/assets/colab-badge.svg" /></a> <a class="reference external" href="https://kaggle.com/kernels/welcome?src=https://github.com/jax-ml/jax/blob/main/docs/jep/9407-type-promotion.ipynb"><img alt="Open in Kaggle" src="https://kaggle.com/static/images/open-in-kaggle.svg" /></a></p>
<p><em>Jake VanderPlas, December 2021</em></p>
<p>One of the challenges faced in the design of any numerical computing library is the choice of how to handle operations between values of different types. This document outlines the thought process behind the promotion semantics used by JAX, summarized in <a class="reference external" href="https://docs.jax.dev/en/latest/type_promotion.html">JAX Type Promotion Semantics</a>.</p>
<section id="goals-of-jax-type-promotion">
<h2>Goals of JAX Type Promotion<a class="headerlink" href="#goals-of-jax-type-promotion" title="Link to this heading">#</a></h2>
<p>JAX‚Äôs numerical computing API is modeled after that of NumPy, with a few enhancements including the ability to target accelerators like GPU and TPU.
This makes adoption of NumPy‚Äôs type promotion system disadvantageous for JAX users: NumPy‚Äôs type promotion rules heavily favor 64-bit outputs, which is problematic for computation on accelerators. Devices such as GPUs and TPUs often pay a significant performance penalty to use 64-bit floating point types, and in some cases do not support native 64-bit floating point types at all.</p>
<p>A simple example of this problematic type promotion semantics can be seen in binary operations between 32-bit integers and floats:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dtype(&#39;float64&#39;)
</pre></div>
</div>
</div>
</div>
<p>NumPy‚Äôs tendency to produce 64-bit values is a <a class="reference external" href="https://github.com/numpy/numpy/issues/6860">long-standing issue</a> with using NumPy‚Äôs API for accelerator computations, for which there isn‚Äôt yet a good solution.
For this reason, JAX has sought to re-think NumPy-style type promotion with accelerators in mind.</p>
</section>
<section id="stepping-back-tables-and-lattices">
<h2>Stepping Back: Tables and Lattices<a class="headerlink" href="#stepping-back-tables-and-lattices" title="Link to this heading">#</a></h2>
<p>Before we dive into the details, let‚Äôs take a moment to step back and think about <em>how</em> to think about the problem of type promotion. Consider arithmetic operations between built-in numerical types in Python, namely those of type <code class="docutils literal notranslate"><span class="pre">int</span></code>, <code class="docutils literal notranslate"><span class="pre">float</span></code>, and <code class="docutils literal notranslate"><span class="pre">complex</span></code>. With a few lines of code we can generate the type promotion table used by Python for addition between values of these types:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">]</span>
<span class="n">name</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="vm">__name__</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="n">name</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">t1</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">t2</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span> <span class="k">for</span> <span class="n">t1</span> <span class="ow">in</span> <span class="n">types</span><span class="p">]</span> <span class="k">for</span> <span class="n">t2</span> <span class="ow">in</span> <span class="n">types</span><span class="p">],</span>
             <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">name</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">name</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
  <div id="df-d8b485e9-55e5-412f-a01e-3be03fedc9d8">
    <div class="colab-df-container">
      <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>int</th>
      <th>float</th>
      <th>complex</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>int</th>
      <td>int</td>
      <td>float</td>
      <td>complex</td>
    </tr>
    <tr>
      <th>float</th>
      <td>float</td>
      <td>float</td>
      <td>complex</td>
    </tr>
    <tr>
      <th>complex</th>
      <td>complex</td>
      <td>complex</td>
      <td>complex</td>
    </tr>
  </tbody>
</table>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-d8b485e9-55e5-412f-a01e-3be03fedc9d8')"
              title="Convert this dataframe to an interactive table."
              style="display:none;">
        
  <svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"/>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"/><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"/>
  </svg>
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-d8b485e9-55e5-412f-a01e-3be03fedc9d8 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-d8b485e9-55e5-412f-a01e-3be03fedc9d8');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  </div></div>
</div>
<p>This table enumerates Python‚Äôs numerical type promotion behavior, but it turns out there is a complementary representation that is much more compact: a <a class="reference external" href="https://en.wikipedia.org/wiki/Lattice_(order)">Lattice</a> representation, where the <a class="reference external" href="https://en.wikipedia.org/wiki/Infimum_and_supremum">supremum</a> between any two nodes is the type that they promote to. The lattice representation of Python‚Äôs promotion table is much simpler:</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="n">lattice</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;int&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">],</span> <span class="s1">&#39;float&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;complex&#39;</span><span class="p">]}</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_dict_of_lists</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">create_using</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;int&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;float&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;complex&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]}</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">4000</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">arrowsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/818a3cf499d15c3be1d4c116db142da0418c174873f21e1ffcde679c6058f918.png" src="../_images/818a3cf499d15c3be1d4c116db142da0418c174873f21e1ffcde679c6058f918.png" />
</div>
</div>
<p>This lattice is a compact encoding of the information in the promotion table above. You can find the result of a type promotion for two inputs by tracing the graph to the first common child of the two nodes (including the nodes themselves); mathematically, this common child is known as the <em>supremum</em>, or <em>least upper bound</em>, or <em>join</em> of the pair on the lattice; here we will refer to this operation as the <strong>join</strong>.</p>
<p>Conceptually, an arrow means that <em>implicit type promotion is allowed</em> between the source and the destination: for example, implicit promotion from integer to float is allowed, but implicit promotion from float to integer is not.</p>
<p>Keep in mind that in general not every directed acyclic graph (DAG) will satisfy the properties of a lattice. A lattice requires the existence of a unique least upper bound for every pair of nodes; so, for example the following two DAGs are not lattices:</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

<span class="n">lattice</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">]}</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_dict_of_lists</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">create_using</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">]}</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">arrowsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">],</span> <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="n">lattice</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">],</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">]}</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_dict_of_lists</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">create_using</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">],</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">]}</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">arrowsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">],</span> <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]);</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/a0acbd07f9486d95c10a36c11301d528fb7e65d671d622226151c431b3e36c62.png" src="../_images/a0acbd07f9486d95c10a36c11301d528fb7e65d671d622226151c431b3e36c62.png" />
</div>
</div>
<p>The left DAG is not a lattice because there exists no upper bound for nodes <code class="docutils literal notranslate"><span class="pre">B</span></code> and <code class="docutils literal notranslate"><span class="pre">C</span></code>; the right DAG fails on two counts: first, there exists no upper bound for nodes <code class="docutils literal notranslate"><span class="pre">C</span></code> and <code class="docutils literal notranslate"><span class="pre">D</span></code>, and for nodes <code class="docutils literal notranslate"><span class="pre">A</span></code> and <code class="docutils literal notranslate"><span class="pre">B</span></code> the least upper bound cannot be <em>uniquely</em> determined: both <code class="docutils literal notranslate"><span class="pre">C</span></code> and <code class="docutils literal notranslate"><span class="pre">D</span></code> are candidates, but they are unorderable.</p>
<section id="properties-of-a-type-promotion-lattice">
<h3>Properties of a Type Promotion Lattice<a class="headerlink" href="#properties-of-a-type-promotion-lattice" title="Link to this heading">#</a></h3>
<p>Specifying type promotions in terms of a lattice ensures a number of useful properties. Denoting the join on the lattice with the <span class="math notranslate nohighlight">\(\vee\)</span> operator, we have:</p>
<p><strong>Existence:</strong> A lattice by definition requires that a unique lattice join exists for every pair of elements: <span class="math notranslate nohighlight">\(\forall (a, b): \exists !(a \vee b)\)</span></p>
<p><strong>Commutativity:</strong> The lattice join is commutative: <span class="math notranslate nohighlight">\(\forall (a, b): a\vee b = b \vee a\)</span>.</p>
<p><strong>Associativity:</strong> The lattice join is associative: <span class="math notranslate nohighlight">\(\forall (a, b, c): a \vee (b \vee c) = (a \vee b) \vee c\)</span>.</p>
<p>On the other hand, these properties imply restrictions on the type promotion systems they can represent; in particular <strong>not every type promotion table can be represented by a lattice</strong>. A ready example of this is NumPy‚Äôs full type promotion table; this can be shown quickly by counterexample: here are three scalar types whose promotion behavior in NumPy is non-associative:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>float32
float16
</pre></div>
</div>
</div>
</div>
<p>Such a result may come as a surprise to users: we generally expect mathematical expressions to map to mathematical concepts, so, for example, <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">+</span> <span class="pre">b</span> <span class="pre">+</span> <span class="pre">c</span></code> should be equivalent to <code class="docutils literal notranslate"><span class="pre">c</span> <span class="pre">+</span> <span class="pre">b</span> <span class="pre">+</span> <span class="pre">a</span></code>; <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">*</span> <span class="pre">(y</span> <span class="pre">+</span> <span class="pre">z)</span></code> should be equivalent to <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">*</span> <span class="pre">y</span> <span class="pre">+</span> <span class="pre">x</span> <span class="pre">*</span> <span class="pre">z</span></code>. If type promotion is non-associative or non-commutative, these properties no longer apply.</p>
<p>Further, a lattice-based type promotion system is simpler to conceptualize and understand when compared to a table-based system. For example, JAX recognizes 18 distinct types: a promotion lattice consisting of 18 nodes and sparse, well-motivated connections between them is far easier to hold in one‚Äôs mind than a table of 324 entries.</p>
<p>For this reason, we opt to use a lattice-based type promotion system for JAX.</p>
</section>
</section>
<section id="type-promotion-within-categories">
<h2>Type Promotion within Categories<a class="headerlink" href="#type-promotion-within-categories" title="Link to this heading">#</a></h2>
<p>Numerical computing libraries generally provide more than just <code class="docutils literal notranslate"><span class="pre">int</span></code>, <code class="docutils literal notranslate"><span class="pre">float</span></code>, and <code class="docutils literal notranslate"><span class="pre">complex</span></code>; within each of these categories there are a variety of possible precisions, denoted by the number of bits used in the numerical representation. The categories we will consider here are:</p>
<ul class="simple">
<li><p><em>unsigned integers</em> which include <code class="docutils literal notranslate"><span class="pre">uint8</span></code>, <code class="docutils literal notranslate"><span class="pre">uint16</span></code>, <code class="docutils literal notranslate"><span class="pre">uint32</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">uint64</span></code> (we‚Äôll use <code class="docutils literal notranslate"><span class="pre">u8</span></code>, <code class="docutils literal notranslate"><span class="pre">u16</span></code>, <code class="docutils literal notranslate"><span class="pre">u32</span></code>, <code class="docutils literal notranslate"><span class="pre">u64</span></code> for short)</p></li>
<li><p><em>signed integers</em> which include <code class="docutils literal notranslate"><span class="pre">int8</span></code>, <code class="docutils literal notranslate"><span class="pre">int16</span></code>, <code class="docutils literal notranslate"><span class="pre">int32</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">int64</span></code> (we‚Äôll use <code class="docutils literal notranslate"><span class="pre">i8</span></code>, <code class="docutils literal notranslate"><span class="pre">i16</span></code>, <code class="docutils literal notranslate"><span class="pre">i32</span></code>, <code class="docutils literal notranslate"><span class="pre">i64</span></code> for short)</p></li>
<li><p><em>floating point</em>, which include <code class="docutils literal notranslate"><span class="pre">float16</span></code>, <code class="docutils literal notranslate"><span class="pre">float32</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">float64</span></code> (we‚Äôll use <code class="docutils literal notranslate"><span class="pre">f16</span></code>, <code class="docutils literal notranslate"><span class="pre">f32</span></code>, <code class="docutils literal notranslate"><span class="pre">f64</span></code> for short)</p></li>
<li><p><em>complex floating point</em>, which include <code class="docutils literal notranslate"><span class="pre">complex64</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">complex128</span></code> (we‚Äôll use <code class="docutils literal notranslate"><span class="pre">c64</span></code>, <code class="docutils literal notranslate"><span class="pre">c128</span></code> for short)</p></li>
</ul>
<p>Numpy‚Äôs type promotion semantics <strong>within</strong> each of these four categories is relatively straightforward: the ordered hierarchy of types translates directly to four separate lattices representing in-category type promotion rules:</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="n">lattice</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;u8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u16&#39;</span><span class="p">],</span> <span class="s1">&#39;u16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u32&#39;</span><span class="p">],</span> <span class="s1">&#39;u32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u64&#39;</span><span class="p">],</span>
  <span class="s1">&#39;i8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i16&#39;</span><span class="p">],</span> <span class="s1">&#39;i16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i32&#39;</span><span class="p">],</span> <span class="s1">&#39;i32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i64&#39;</span><span class="p">],</span>
  <span class="s1">&#39;f16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f32&#39;</span><span class="p">],</span> <span class="s1">&#39;f32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f64&#39;</span><span class="p">],</span>
  <span class="s1">&#39;c64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c128&#39;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_dict_of_lists</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">create_using</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;u8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;u16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;u32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;u64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
  <span class="s1">&#39;i8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
  <span class="s1">&#39;f16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;f32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;f64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
  <span class="s1">&#39;c64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;c128&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/2d8495bcb006c34b42eeb4f3e0c6530fdef0bd7364c56184993925f0cf157abc.png" src="../_images/2d8495bcb006c34b42eeb4f3e0c6530fdef0bd7364c56184993925f0cf157abc.png" />
</div>
</div>
<p>In terms of promotion of values to 64-bit that JAX seeks to avoid, these same-kind promotion semantics within each type category are unproblematic: the only way to produce a 64-bit output is to have a 64-bit input.</p>
</section>
<section id="enter-python-scalars">
<h2>Enter Python Scalars<a class="headerlink" href="#enter-python-scalars" title="Link to this heading">#</a></h2>
<p>Let‚Äôs now think about where Python scalars fit into the mix.</p>
<p>In NumPy, promotion behavior differs depending on whether the inputs are arrays or scalars. For example, when operating on two scalars, normal promotion rules apply:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># int8 scalar</span>
<span class="n">y</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Python int = int64 scalar</span>
<span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">dtype</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dtype(&#39;int64&#39;)
</pre></div>
</div>
</div>
</div>
<p>Here the Python value <code class="docutils literal notranslate"><span class="pre">1</span></code> is treated as an <code class="docutils literal notranslate"><span class="pre">int64</span></code>, and straightforward within-category rules lead to an <code class="docutils literal notranslate"><span class="pre">int64</span></code> result.</p>
<p>In operations between Python scalars and NumPy arrays, however, scalars defer to the dtype of the array. For example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int8&#39;</span><span class="p">)</span>  <span class="c1"># int8 array</span>
<span class="n">y</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Python int = int64 scalar</span>
<span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">dtype</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dtype(&#39;int8&#39;)
</pre></div>
</div>
</div>
</div>
<p>Here the bit width of the <code class="docutils literal notranslate"><span class="pre">int64</span></code> scalar is ignored, deferring to the bit width of the array.</p>
<p>There is another detail here: when NumPy type promotion involves a scalar, the output dtype is value-dependent: if the Python scalar is too large for the given dtype, it is promoted to a compatible type:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int8&#39;</span><span class="p">)</span>  <span class="c1"># int8 array</span>
<span class="n">y</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># int64 scalar</span>
<span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">dtype</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dtype(&#39;int16&#39;)
</pre></div>
</div>
</div>
</div>
<p>For the purposes of JAX, <strong>value-dependent promotion is a non-starter</strong> because of the nature of JIT compilation and other transformations, which act on abstract representations of data without reference to their value.</p>
<p>Ignoring value-dependent effects, the signed integer branch of NumPy‚Äôs type promotion can be represented in the following lattice, where we‚Äôll use <code class="docutils literal notranslate"><span class="pre">*</span></code> to mark scalar dtypes:</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="n">lattice</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;i8*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i16*&#39;</span><span class="p">],</span> <span class="s1">&#39;i16*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i32*&#39;</span><span class="p">],</span> <span class="s1">&#39;i32*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i64*&#39;</span><span class="p">],</span> <span class="s1">&#39;i64*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i8&#39;</span><span class="p">],</span>
  <span class="s1">&#39;i8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i16&#39;</span><span class="p">],</span> <span class="s1">&#39;i16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i32&#39;</span><span class="p">],</span> <span class="s1">&#39;i32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i64&#39;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_dict_of_lists</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">create_using</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;i8*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i16*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i32*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i64*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
  <span class="s1">&#39;i8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">13</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">1.6</span><span class="p">,</span> <span class="s2">&quot;Scalar Types&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mf">1.6</span><span class="p">,</span> <span class="s2">&quot;Array Types&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/7e8c3295e403209560d8e142c5c830d79456a4e6d207dd1a7e4d15b55c56006b.png" src="../_images/7e8c3295e403209560d8e142c5c830d79456a4e6d207dd1a7e4d15b55c56006b.png" />
</div>
</div>
<p>A similar pattern holds within the <code class="docutils literal notranslate"><span class="pre">uint</span></code>, <code class="docutils literal notranslate"><span class="pre">float</span></code>, and <code class="docutils literal notranslate"><span class="pre">complex</span></code> lattices.</p>
<p>For the sake of simplicity, let‚Äôs collapse each category of scalar types into a single node, denoted by <code class="docutils literal notranslate"><span class="pre">u*</span></code>, <code class="docutils literal notranslate"><span class="pre">i*</span></code>, <code class="docutils literal notranslate"><span class="pre">f*</span></code>, and <code class="docutils literal notranslate"><span class="pre">c*</span></code> respectively. Our set of in-category lattices can now be represented like this:</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="n">lattice</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;u*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u8&#39;</span><span class="p">],</span> <span class="s1">&#39;u8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u16&#39;</span><span class="p">],</span> <span class="s1">&#39;u16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u32&#39;</span><span class="p">],</span> <span class="s1">&#39;u32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u64&#39;</span><span class="p">],</span>
  <span class="s1">&#39;i*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i8&#39;</span><span class="p">],</span> <span class="s1">&#39;i8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i16&#39;</span><span class="p">],</span> <span class="s1">&#39;i16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i32&#39;</span><span class="p">],</span> <span class="s1">&#39;i32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i64&#39;</span><span class="p">],</span>
  <span class="s1">&#39;f*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f16&#39;</span><span class="p">],</span> <span class="s1">&#39;f16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f32&#39;</span><span class="p">],</span> <span class="s1">&#39;f32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f64&#39;</span><span class="p">],</span>
  <span class="s1">&#39;c*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c64&#39;</span><span class="p">],</span> <span class="s1">&#39;c64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c128&#39;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_dict_of_lists</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">create_using</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;u*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;u8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;u16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;u32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;u64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
  <span class="s1">&#39;i*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
  <span class="s1">&#39;f*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;f16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;f32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;f64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
  <span class="s1">&#39;c*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;c64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;c128&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/0fbe0c20cd350821e64f3742aa7864ec729565572b136950042095881672fdb9.png" src="../_images/0fbe0c20cd350821e64f3742aa7864ec729565572b136950042095881672fdb9.png" />
</div>
</div>
<p>In some senses, putting scalars at the left is a strange choice: the scalar types may contain values of any width, but when interacting with an array of a given type, the promotion result defers to the array type.
The benefit of this is that when you perform an operation like <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">+</span> <span class="pre">2</span></code> for an array <code class="docutils literal notranslate"><span class="pre">x</span></code>, the type of <code class="docutils literal notranslate"><span class="pre">x</span></code> will carry to the result no matter its width:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">]:</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
  <span class="k">assert</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">dtype</span>
</pre></div>
</div>
</div>
</div>
<p>This behavior gives motivation to our <code class="docutils literal notranslate"><span class="pre">*</span></code> notation for scalar values: the <code class="docutils literal notranslate"><span class="pre">*</span></code> is reminiscent of a wildcard that can take on any desired value.</p>
<p>The benefit of these semantics is that you can readily express sequences of operations with clean Python code, without having to explicitly cast scalars to the appropriate type. Imagine if rather than writing this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
</pre></div>
</div>
<p>you had to write this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>Although it is explicit, numerical code would become tedious to read or write. With the scalar promotion semantics described above, given an array <code class="docutils literal notranslate"><span class="pre">x</span></code> of type <code class="docutils literal notranslate"><span class="pre">int32</span></code>, the types in the second statement are implicit within the first.</p>
</section>
<section id="combining-lattices">
<h2>Combining Lattices<a class="headerlink" href="#combining-lattices" title="Link to this heading">#</a></h2>
<p>Recall that we began our discussion by introducing the lattice representing type promotion within Python: <code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">-&gt;</span> <span class="pre">float</span> <span class="pre">-&gt;</span> <span class="pre">complex</span></code>. Let‚Äôs rewrite this as <code class="docutils literal notranslate"><span class="pre">i*</span> <span class="pre">-&gt;</span> <span class="pre">f*</span> <span class="pre">-&gt;</span> <span class="pre">c*</span></code>, and let‚Äôs further allow <code class="docutils literal notranslate"><span class="pre">i*</span></code> to subsume <code class="docutils literal notranslate"><span class="pre">u*</span></code> (after all, there is no unsigned integer scalar type in Python).</p>
<p>Putting these all together, we get the following partial lattice representing type promotion between Python scalars and numpy arrays:</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="n">lattice</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;i*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f*&#39;</span><span class="p">,</span> <span class="s1">&#39;u8&#39;</span><span class="p">,</span> <span class="s1">&#39;i8&#39;</span><span class="p">],</span> <span class="s1">&#39;f*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c*&#39;</span><span class="p">,</span> <span class="s1">&#39;f16&#39;</span><span class="p">],</span> <span class="s1">&#39;c*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c64&#39;</span><span class="p">],</span>
  <span class="s1">&#39;u8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u16&#39;</span><span class="p">],</span> <span class="s1">&#39;u16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u32&#39;</span><span class="p">],</span> <span class="s1">&#39;u32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u64&#39;</span><span class="p">],</span>
  <span class="s1">&#39;i8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i16&#39;</span><span class="p">],</span> <span class="s1">&#39;i16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i32&#39;</span><span class="p">],</span> <span class="s1">&#39;i32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i64&#39;</span><span class="p">],</span>
  <span class="s1">&#39;f16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f32&#39;</span><span class="p">],</span> <span class="s1">&#39;f32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f64&#39;</span><span class="p">],</span>
  <span class="s1">&#39;c64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c128&#39;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_dict_of_lists</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">create_using</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;i*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="s1">&#39;f*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;c*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
  <span class="s1">&#39;u8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;u16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;u32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;u64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
  <span class="s1">&#39;i8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
  <span class="s1">&#39;f16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;f32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;f64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
  <span class="s1">&#39;c64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;c128&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/796586be87180b0de3171d39763f2d33a80a641b72d82c00f0c0e352f754f201.png" src="../_images/796586be87180b0de3171d39763f2d33a80a641b72d82c00f0c0e352f754f201.png" />
</div>
</div>
<p>Notice that this is not (yet) a true lattice: there are many pairs of nodes for which a join does not exist. However, we can think of this as a <em>partial</em> lattice, in which some pairs of nodes do not have a defined promotion behavior, and the defined portion of this partial lattice does correctly describe NumPy‚Äôs array promotion behavior (leaving aside value-dependent semantics mentioned above).</p>
<p>This sets up a nice framework by which we can think about filling-out these undefined promotion rules, by adding connections on this graph. But which connections to add?
Broadly speaking, we want any additional connections to satisfy a few properties:</p>
<ol class="arabic simple">
<li><p>Promotion should satisfy the commutative and associative properties: in other words, the graph should remain a (partial) lattice.</p></li>
<li><p>Promotion should never allow for dropping entire components of data: for example, we should never promote <code class="docutils literal notranslate"><span class="pre">complex</span></code> to <code class="docutils literal notranslate"><span class="pre">float</span></code>, as it would discard any imaginary parts.</p></li>
<li><p>Promotion should never lead to an unhandled overflow. For example, the maximum possible <code class="docutils literal notranslate"><span class="pre">uint32</span></code> is twice as large as the maximum possible <code class="docutils literal notranslate"><span class="pre">int32</span></code>, so we should not implicitly promote <code class="docutils literal notranslate"><span class="pre">uint32</span></code> to <code class="docutils literal notranslate"><span class="pre">int32</span></code>.</p></li>
<li><p>Wherever possible, promotion should avoid loss of precision. For example, an <code class="docutils literal notranslate"><span class="pre">int64</span></code> value may have 64 bits of mantissa, so promoting <code class="docutils literal notranslate"><span class="pre">int64</span></code> to <code class="docutils literal notranslate"><span class="pre">float64</span></code> represents a possible loss of precision. However, the maximum representable float64 is larger than the maximum representable int64, so in this case criterion #3 is still satisfied.</p></li>
<li><p>Wherever possible, binary promotion should avoid resulting in types that are wider than the inputs. This is to ensure that JAX‚Äôs implicit promotions remain friendly to accelerator-based workflows, in which users often want to restrict types to 32-bit (or in some cases 16-bit) values.</p></li>
</ol>
<p>Each new connection on the lattice introduces some level of convenience to the user (a new set of types that can interact without explicit casting), but the convenience may become too costly if any of the above criteria are violated. Developing a full promotion lattice involves striking a balance between this convenience and this cost.</p>
</section>
<section id="mixed-promotion-float-and-complex">
<h2>Mixed Promotion: Float and Complex<a class="headerlink" href="#mixed-promotion-float-and-complex" title="Link to this heading">#</a></h2>
<p>Let‚Äôs begin with what is perhaps the easiest case, that of promotion between float and complex values.</p>
<p>Complex numbers are made up of pairs of floating point numbers, and so we have a natural path of promotion between them: cast float to complex while maintaining the width of the real part. In terms of our partial lattice representation, it would look like this:</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="n">lattice</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;i*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f*&#39;</span><span class="p">,</span> <span class="s1">&#39;u8&#39;</span><span class="p">,</span> <span class="s1">&#39;i8&#39;</span><span class="p">],</span> <span class="s1">&#39;f*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c*&#39;</span><span class="p">,</span> <span class="s1">&#39;f16&#39;</span><span class="p">],</span> <span class="s1">&#39;c*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c64&#39;</span><span class="p">],</span>
  <span class="s1">&#39;u8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u16&#39;</span><span class="p">],</span> <span class="s1">&#39;u16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u32&#39;</span><span class="p">],</span> <span class="s1">&#39;u32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u64&#39;</span><span class="p">],</span>
  <span class="s1">&#39;i8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i16&#39;</span><span class="p">],</span> <span class="s1">&#39;i16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i32&#39;</span><span class="p">],</span> <span class="s1">&#39;i32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i64&#39;</span><span class="p">],</span>
  <span class="s1">&#39;f16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f32&#39;</span><span class="p">],</span> <span class="s1">&#39;f32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f64&#39;</span><span class="p">,</span> <span class="s1">&#39;c64&#39;</span><span class="p">],</span> <span class="s1">&#39;f64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c128&#39;</span><span class="p">],</span>
  <span class="s1">&#39;c64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c128&#39;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_dict_of_lists</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">create_using</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;i*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="s1">&#39;f*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;c*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
  <span class="s1">&#39;u8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;u16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;u32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;u64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
  <span class="s1">&#39;i8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
  <span class="s1">&#39;f16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;f32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;f64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
  <span class="s1">&#39;c64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;c128&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/bf87909b2344aed80590d1c6d91585a02b25898ac217526cb49948d91205318f.png" src="../_images/bf87909b2344aed80590d1c6d91585a02b25898ac217526cb49948d91205318f.png" />
</div>
</div>
<p>This turns out to represent exactly the semantics used by Numpy in mixed float/complex type promotion.</p>
</section>
<section id="mixed-promotion-signed-unsigned-integers">
<h2>Mixed Promotion: Signed &amp; Unsigned Integers<a class="headerlink" href="#mixed-promotion-signed-unsigned-integers" title="Link to this heading">#</a></h2>
<p>For the next case, let‚Äôs consider something a bit more difficult: promotion between signed and unsigned integers. For example, when promoting <code class="docutils literal notranslate"><span class="pre">uint8</span></code> to a signed integer, how many bits do we need?</p>
<p>At first glance, you might think it natural to promote <code class="docutils literal notranslate"><span class="pre">uint8</span></code> to <code class="docutils literal notranslate"><span class="pre">int8</span></code>; but the largest <code class="docutils literal notranslate"><span class="pre">uint8</span></code> numbers are not representable in <code class="docutils literal notranslate"><span class="pre">int8</span></code>. For this reason, it makes more sense to promote unsigned integers to integers with twice the number of bits; this promotion behavior can be represented by adding the following connections to the promotion lattice:</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="n">lattice</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;i*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f*&#39;</span><span class="p">,</span> <span class="s1">&#39;u8&#39;</span><span class="p">,</span> <span class="s1">&#39;i8&#39;</span><span class="p">],</span> <span class="s1">&#39;f*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c*&#39;</span><span class="p">,</span> <span class="s1">&#39;f16&#39;</span><span class="p">],</span> <span class="s1">&#39;c*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c64&#39;</span><span class="p">],</span>
  <span class="s1">&#39;u8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u16&#39;</span><span class="p">,</span> <span class="s1">&#39;i16&#39;</span><span class="p">],</span> <span class="s1">&#39;u16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u32&#39;</span><span class="p">,</span> <span class="s1">&#39;i32&#39;</span><span class="p">],</span> <span class="s1">&#39;u32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u64&#39;</span><span class="p">,</span> <span class="s1">&#39;i64&#39;</span><span class="p">],</span>
  <span class="s1">&#39;i8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i16&#39;</span><span class="p">],</span> <span class="s1">&#39;i16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i32&#39;</span><span class="p">],</span> <span class="s1">&#39;i32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i64&#39;</span><span class="p">],</span>
  <span class="s1">&#39;f16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f32&#39;</span><span class="p">],</span> <span class="s1">&#39;f32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f64&#39;</span><span class="p">,</span> <span class="s1">&#39;c64&#39;</span><span class="p">],</span> <span class="s1">&#39;f64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c128&#39;</span><span class="p">],</span>
  <span class="s1">&#39;c64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c128&#39;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_dict_of_lists</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">create_using</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;i*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="s1">&#39;f*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;c*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
  <span class="s1">&#39;u8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;u16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;u32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;u64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
  <span class="s1">&#39;i8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
  <span class="s1">&#39;f16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;f32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;f64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
  <span class="s1">&#39;c64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;c128&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/3be7e17889458ac823bb5dacf31525c0d96578c6854962f45dcc60ec987a30bd.png" src="../_images/3be7e17889458ac823bb5dacf31525c0d96578c6854962f45dcc60ec987a30bd.png" />
</div>
</div>
<p>Again, the connections added here are precisely the promotion semantics implemented by Numpy for mixed-integer promotion.</p>
<section id="how-to-handle-uint64">
<h3>How to handle <code class="docutils literal notranslate"><span class="pre">uint64</span></code>?<a class="headerlink" href="#how-to-handle-uint64" title="Link to this heading">#</a></h3>
<p>The approach to mixed signed/unsigned integer promotion leaves out one type: <code class="docutils literal notranslate"><span class="pre">uint64</span></code>. Following the pattern above, the output of a mixed-integer operation involving <code class="docutils literal notranslate"><span class="pre">uint64</span></code> should result in <code class="docutils literal notranslate"><span class="pre">int128</span></code>, but this is not a standard available dtype.</p>
<p>Numpy‚Äôs choice here is to promote to <code class="docutils literal notranslate"><span class="pre">float64</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dtype</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dtype(&#39;float64&#39;)
</pre></div>
</div>
</div>
</div>
<p>However, this may be a surprising convention: it‚Äôs the only case in which promotion of integer types does not result in an integer.
For now, we will leave <code class="docutils literal notranslate"><span class="pre">uint64</span></code> promotion undefined, and return to it later.</p>
</section>
</section>
<section id="mixed-promotion-integer-and-floating">
<h2>Mixed Promotion: Integer and Floating<a class="headerlink" href="#mixed-promotion-integer-and-floating" title="Link to this heading">#</a></h2>
<p>When promoting integers to floating point, we might start with the same thought process as mixed promotion between signed and unsigned integers. A 16-bit signed or unsigned integer cannot be represented at full precision by a 16-bit float, which has only 10 bits of mantissa. Therefore, it might make sense to promote integers to floats represented by twice the number of bits:</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="n">lattice</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;i*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f*&#39;</span><span class="p">,</span> <span class="s1">&#39;u8&#39;</span><span class="p">,</span> <span class="s1">&#39;i8&#39;</span><span class="p">],</span> <span class="s1">&#39;f*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c*&#39;</span><span class="p">,</span> <span class="s1">&#39;f16&#39;</span><span class="p">],</span> <span class="s1">&#39;c*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c64&#39;</span><span class="p">],</span>
  <span class="s1">&#39;u8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u16&#39;</span><span class="p">,</span> <span class="s1">&#39;i16&#39;</span><span class="p">,</span> <span class="s1">&#39;f16&#39;</span><span class="p">],</span> <span class="s1">&#39;u16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u32&#39;</span><span class="p">,</span> <span class="s1">&#39;i32&#39;</span><span class="p">,</span> <span class="s1">&#39;f32&#39;</span><span class="p">],</span> <span class="s1">&#39;u32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u64&#39;</span><span class="p">,</span> <span class="s1">&#39;i64&#39;</span><span class="p">,</span> <span class="s1">&#39;f64&#39;</span><span class="p">],</span>
  <span class="s1">&#39;i8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i16&#39;</span><span class="p">,</span> <span class="s1">&#39;f16&#39;</span><span class="p">],</span> <span class="s1">&#39;i16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i32&#39;</span><span class="p">,</span> <span class="s1">&#39;f32&#39;</span><span class="p">],</span> <span class="s1">&#39;i32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i64&#39;</span><span class="p">,</span> <span class="s1">&#39;f64&#39;</span><span class="p">],</span>
  <span class="s1">&#39;f16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f32&#39;</span><span class="p">],</span> <span class="s1">&#39;f32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f64&#39;</span><span class="p">,</span> <span class="s1">&#39;c64&#39;</span><span class="p">],</span> <span class="s1">&#39;f64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c128&#39;</span><span class="p">],</span>
  <span class="s1">&#39;c64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c128&#39;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_dict_of_lists</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">create_using</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;i*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="s1">&#39;f*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;c*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
  <span class="s1">&#39;u8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;u16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;u32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;u64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
  <span class="s1">&#39;i8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
  <span class="s1">&#39;f16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;f32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;f64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
  <span class="s1">&#39;c64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;c128&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/8b3247e8189fbfad46a7e5583b636866fc45576e07c9bfd904457926306299d1.png" src="../_images/8b3247e8189fbfad46a7e5583b636866fc45576e07c9bfd904457926306299d1.png" />
</div>
</div>
<p>This is effectively what Numpy type promotion does, but in doing so it breaks the lattice property of the graph: for example, the pair <em>{i8, u8}</em> no longer has a unique least upper bound: the possibilities are <em>i16</em> and <em>f16</em>, which are unorderable on the graph. This turns out to be the source of NumPy‚Äôs non-associative type promotion highlighted above.</p>
<p>Can we come up with a modification of NumPy‚Äôs promotion rules, such that it will satisfy the lattice property, while also giving sensible results for mixed type promotion? There are a few approaches we could take here.</p>
<section id="option-0-leave-integer-floating-mixed-precision-undefined">
<h3>Option 0: Leave integer/floating mixed precision undefined<a class="headerlink" href="#option-0-leave-integer-floating-mixed-precision-undefined" title="Link to this heading">#</a></h3>
<p>To make behavior utterly predictable (at some cost to user convenience), a defensible choice would be to leave as undefined any mixed integer/float promotion beyond Python scalars, stopping with the partial lattice from the previous section. The downside would be the requirement for users to explicitly type-cast when operating between integer and floating-point quantities.</p>
</section>
<section id="option-1-avoiding-all-precision-loss">
<h3>Option 1: Avoiding All Precision Loss<a class="headerlink" href="#option-1-avoiding-all-precision-loss" title="Link to this heading">#</a></h3>
<p>If our focus is on avoiding precision loss at all costs, we can restore the lattice property by promoting unsigned integers to float via their existing signed integer paths:</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="n">lattice</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;i*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f*&#39;</span><span class="p">,</span> <span class="s1">&#39;u8&#39;</span><span class="p">,</span> <span class="s1">&#39;i8&#39;</span><span class="p">],</span> <span class="s1">&#39;f*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c*&#39;</span><span class="p">,</span> <span class="s1">&#39;f16&#39;</span><span class="p">],</span> <span class="s1">&#39;c*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c64&#39;</span><span class="p">],</span>
  <span class="s1">&#39;u8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u16&#39;</span><span class="p">,</span> <span class="s1">&#39;i16&#39;</span><span class="p">],</span> <span class="s1">&#39;u16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u32&#39;</span><span class="p">,</span> <span class="s1">&#39;i32&#39;</span><span class="p">],</span> <span class="s1">&#39;u32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u64&#39;</span><span class="p">,</span> <span class="s1">&#39;i64&#39;</span><span class="p">],</span>
  <span class="s1">&#39;i8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i16&#39;</span><span class="p">,</span> <span class="s1">&#39;f16&#39;</span><span class="p">],</span> <span class="s1">&#39;i16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i32&#39;</span><span class="p">,</span> <span class="s1">&#39;f32&#39;</span><span class="p">],</span> <span class="s1">&#39;i32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i64&#39;</span><span class="p">,</span> <span class="s1">&#39;f64&#39;</span><span class="p">],</span>
  <span class="s1">&#39;f16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f32&#39;</span><span class="p">],</span> <span class="s1">&#39;f32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f64&#39;</span><span class="p">,</span> <span class="s1">&#39;c64&#39;</span><span class="p">],</span> <span class="s1">&#39;f64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c128&#39;</span><span class="p">],</span>
  <span class="s1">&#39;c64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c128&#39;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_dict_of_lists</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">create_using</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;i*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="s1">&#39;f*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;c*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
  <span class="s1">&#39;u8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;u16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;u32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;u64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
  <span class="s1">&#39;i8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
  <span class="s1">&#39;f16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;f32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;f64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
  <span class="s1">&#39;c64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;c128&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/1eda89d008a8c6dadf926229bf9f2245722006c5bc1c42961c555a2595c95117.png" src="../_images/1eda89d008a8c6dadf926229bf9f2245722006c5bc1c42961c555a2595c95117.png" />
</div>
</div>
<p>A disadvantage of this approach is that it still leaves <code class="docutils literal notranslate"><span class="pre">int64</span></code> and <code class="docutils literal notranslate"><span class="pre">uint64</span></code> promotion undefined, because there is no standard floating point type with enough bits of mantissa to represent their full range of values. We could relax the precision constraint and complete the lattice by drawing connections from <code class="docutils literal notranslate"><span class="pre">i64-&gt;f64</span></code> and <code class="docutils literal notranslate"><span class="pre">u64-&gt;f64</span></code>, but those links would run counter to the motivation for this promotion scheme.</p>
<p>A second disadvantage is that this lattice makes it difficult to find a sensible place to insert <code class="docutils literal notranslate"><span class="pre">bfloat16</span></code> (see below) while maintaining the lattice property.</p>
<p>A third disadvantage of this approach, more important for JAX‚Äôs accelerator backends, is that some operations result in types that are much wider than necessary; for example mixed operations between <code class="docutils literal notranslate"><span class="pre">uint16</span></code> and <code class="docutils literal notranslate"><span class="pre">float16</span></code> would promote all the way to <code class="docutils literal notranslate"><span class="pre">float64</span></code>, which is not ideal.</p>
</section>
<section id="option-2-avoid-most-wider-than-necessary-promotions">
<h3>Option 2: Avoid most wider-than-necessary promotions<a class="headerlink" href="#option-2-avoid-most-wider-than-necessary-promotions" title="Link to this heading">#</a></h3>
<p>To address the unnecessary promotions to wider types, we could accept the possibility of some precision loss in integer/float promotion, promoting signed integers to floats of the same width:</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="n">lattice</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;i*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f*&#39;</span><span class="p">,</span> <span class="s1">&#39;u8&#39;</span><span class="p">,</span> <span class="s1">&#39;i8&#39;</span><span class="p">],</span> <span class="s1">&#39;f*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c*&#39;</span><span class="p">,</span> <span class="s1">&#39;f16&#39;</span><span class="p">],</span> <span class="s1">&#39;c*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c64&#39;</span><span class="p">],</span>
  <span class="s1">&#39;u8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u16&#39;</span><span class="p">,</span> <span class="s1">&#39;i16&#39;</span><span class="p">],</span> <span class="s1">&#39;u16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u32&#39;</span><span class="p">,</span> <span class="s1">&#39;i32&#39;</span><span class="p">],</span> <span class="s1">&#39;u32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u64&#39;</span><span class="p">,</span> <span class="s1">&#39;i64&#39;</span><span class="p">],</span>
  <span class="s1">&#39;i8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i16&#39;</span><span class="p">],</span> <span class="s1">&#39;i16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f16&#39;</span><span class="p">,</span> <span class="s1">&#39;i32&#39;</span><span class="p">],</span> <span class="s1">&#39;i32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f32&#39;</span><span class="p">,</span> <span class="s1">&#39;i64&#39;</span><span class="p">],</span> <span class="s1">&#39;i64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f64&#39;</span><span class="p">],</span>
  <span class="s1">&#39;f16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f32&#39;</span><span class="p">],</span> <span class="s1">&#39;f32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f64&#39;</span><span class="p">,</span> <span class="s1">&#39;c64&#39;</span><span class="p">],</span> <span class="s1">&#39;f64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c128&#39;</span><span class="p">],</span>
  <span class="s1">&#39;c64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c128&#39;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_dict_of_lists</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">create_using</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;i*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="s1">&#39;f*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;c*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
  <span class="s1">&#39;u8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;u16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;u32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;u64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
  <span class="s1">&#39;i8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
  <span class="s1">&#39;f16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;f32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;f64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
  <span class="s1">&#39;c64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;c128&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/f41cee38a476bf636be901e7f64a5dc3687002f9d12532ab706b9077d602b175.png" src="../_images/f41cee38a476bf636be901e7f64a5dc3687002f9d12532ab706b9077d602b175.png" />
</div>
</div>
<p>While this does allow for precision-losing promotions between integers and floats, these promotions will not mis-represent the <em>magnitude</em> of the result: though the floating point mantissa is not wide enough to represent all values, the exponent is wide enough to approximate them.</p>
<p>This approach also allows a natural promotion path from <code class="docutils literal notranslate"><span class="pre">int64</span></code> to <code class="docutils literal notranslate"><span class="pre">float64</span></code>, though <code class="docutils literal notranslate"><span class="pre">uint64</span></code> remains unpromotable in this scheme. That said, a connection from <code class="docutils literal notranslate"><span class="pre">u64</span></code> to <code class="docutils literal notranslate"><span class="pre">f64</span></code> could be justified more readily here than before.</p>
<p>This promotion scheme still results in some wider than necessary promotion paths; for example operations between <code class="docutils literal notranslate"><span class="pre">float32</span></code> and <code class="docutils literal notranslate"><span class="pre">uint32</span></code> result in <code class="docutils literal notranslate"><span class="pre">float64</span></code>. Additionally, this lattice makes it difficult to find a sensible place to insert <code class="docutils literal notranslate"><span class="pre">bfloat16</span></code> (see below) while maintaining the lattice property.</p>
</section>
<section id="option-3-avoid-all-wider-than-necessary-promotions">
<h3>Option 3: Avoid all wider-than-necessary promotions<a class="headerlink" href="#option-3-avoid-all-wider-than-necessary-promotions" title="Link to this heading">#</a></h3>
<p>We can avoid <em>all</em> non-ideal 64-bit promotions if we‚Äôre willing to fundamentally change our thinking around integer and float promotions.
Just as scalars always defer to the widths of array types, we can make integers always defer to the width of float types:</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="n">lattice</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;i*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u8&#39;</span><span class="p">,</span> <span class="s1">&#39;i8&#39;</span><span class="p">],</span> <span class="s1">&#39;f*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c*&#39;</span><span class="p">,</span> <span class="s1">&#39;f16&#39;</span><span class="p">],</span> <span class="s1">&#39;c*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c64&#39;</span><span class="p">],</span>
  <span class="s1">&#39;u8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u16&#39;</span><span class="p">,</span> <span class="s1">&#39;i16&#39;</span><span class="p">],</span> <span class="s1">&#39;u16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u32&#39;</span><span class="p">,</span> <span class="s1">&#39;i32&#39;</span><span class="p">],</span> <span class="s1">&#39;u32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u64&#39;</span><span class="p">,</span> <span class="s1">&#39;i64&#39;</span><span class="p">],</span>
  <span class="s1">&#39;i8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i16&#39;</span><span class="p">],</span> <span class="s1">&#39;i16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i32&#39;</span><span class="p">],</span> <span class="s1">&#39;i32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i64&#39;</span><span class="p">],</span> <span class="s1">&#39;i64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f*&#39;</span><span class="p">],</span>
  <span class="s1">&#39;f16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f32&#39;</span><span class="p">],</span> <span class="s1">&#39;f32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f64&#39;</span><span class="p">,</span> <span class="s1">&#39;c64&#39;</span><span class="p">],</span> <span class="s1">&#39;f64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c128&#39;</span><span class="p">],</span>
  <span class="s1">&#39;c64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c128&#39;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_dict_of_lists</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">create_using</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;i*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="s1">&#39;f*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;c*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
  <span class="s1">&#39;u8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;u16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;u32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;u64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
  <span class="s1">&#39;i8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
  <span class="s1">&#39;f16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;f32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;f64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
  <span class="s1">&#39;c64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;c128&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/d3f5e5be4354238a60698cb4f228d4e1f75a665577343c36b2c1ade1207783a0.png" src="../_images/d3f5e5be4354238a60698cb4f228d4e1f75a665577343c36b2c1ade1207783a0.png" />
</div>
</div>
<p>This involves a small sleight of hand: previously we had used <code class="docutils literal notranslate"><span class="pre">f*</span></code> to refer to a scalar type. In this lattice, <code class="docutils literal notranslate"><span class="pre">f*</span></code> might be applied to the array output of a mixed computation. Instead of thinking of <code class="docutils literal notranslate"><span class="pre">f*</span></code> as a scalar, we could think of it as a special kind of <code class="docutils literal notranslate"><span class="pre">float</span></code> value with distinct promotion rules: in JAX we refer to this as a <em>weak float</em>; see below.</p>
<p>The advantage of this approach is that, outside unsigned ints, it avoids <em>all</em> wider-than-necessary promotions: you can never get an f64 output without a 64-bit input, and you can never get an f32 output without a 32-bit input: this results in convenient semantics for working on accelerators while avoiding inadvertent 64-bit values.</p>
<p>This feature of giving primacy to floating point types resembles the type promotion behavior of PyTorch.
This lattice also happens to generate a promotion table that very closely resembles JAX‚Äôs original <em>ad hoc</em> type promotion scheme, which was not based on a lattice but had the property of giving primacy to floating point types.</p>
<p>This lattice additionally offers a natural location to insert <code class="docutils literal notranslate"><span class="pre">bfloat16</span></code>, without the need to impose an ordering between <code class="docutils literal notranslate"><span class="pre">bf16</span></code> and <code class="docutils literal notranslate"><span class="pre">f16</span></code>:</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="n">lattice</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;i*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u8&#39;</span><span class="p">,</span> <span class="s1">&#39;i8&#39;</span><span class="p">],</span> <span class="s1">&#39;f*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c*&#39;</span><span class="p">,</span> <span class="s1">&#39;f16&#39;</span><span class="p">,</span> <span class="s1">&#39;bf16&#39;</span><span class="p">],</span> <span class="s1">&#39;c*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c64&#39;</span><span class="p">],</span>
  <span class="s1">&#39;u8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u16&#39;</span><span class="p">,</span> <span class="s1">&#39;i16&#39;</span><span class="p">],</span> <span class="s1">&#39;u16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u32&#39;</span><span class="p">,</span> <span class="s1">&#39;i32&#39;</span><span class="p">],</span> <span class="s1">&#39;u32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u64&#39;</span><span class="p">,</span> <span class="s1">&#39;i64&#39;</span><span class="p">],</span>
  <span class="s1">&#39;i8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i16&#39;</span><span class="p">],</span> <span class="s1">&#39;i16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i32&#39;</span><span class="p">],</span> <span class="s1">&#39;i32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i64&#39;</span><span class="p">],</span> <span class="s1">&#39;i64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f*&#39;</span><span class="p">],</span>
  <span class="s1">&#39;f16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f32&#39;</span><span class="p">],</span> <span class="s1">&#39;bf16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f32&#39;</span><span class="p">],</span> <span class="s1">&#39;f32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f64&#39;</span><span class="p">,</span> <span class="s1">&#39;c64&#39;</span><span class="p">],</span> <span class="s1">&#39;f64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c128&#39;</span><span class="p">],</span>
  <span class="s1">&#39;c64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c128&#39;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_dict_of_lists</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">create_using</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;i*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="s1">&#39;f*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;c*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
  <span class="s1">&#39;u8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;u16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;u32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;u64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
  <span class="s1">&#39;i8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
  <span class="s1">&#39;f16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.8</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">],</span> <span class="s1">&#39;bf16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.8</span><span class="p">,</span> <span class="mf">2.3</span><span class="p">],</span> <span class="s1">&#39;f32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;f64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">4.0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
  <span class="s1">&#39;c64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;c128&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">4.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/aa73688b580b02776fce218d6efe58792ae3b0976160a4b0c130b797780578af.png" src="../_images/aa73688b580b02776fce218d6efe58792ae3b0976160a4b0c130b797780578af.png" />
</div>
</div>
<p>This is important because <code class="docutils literal notranslate"><span class="pre">f16</span></code> and <code class="docutils literal notranslate"><span class="pre">bf16</span></code> are not comparable because they utilize their bits differently: <code class="docutils literal notranslate"><span class="pre">bf16</span></code> represents a larger range at lower precision, while <code class="docutils literal notranslate"><span class="pre">f16</span></code> represents a smaller range at higher precision.</p>
<p>However, these advantages comes with a few tradeoffs:</p>
<ul class="simple">
<li><p>mixed float/integer promotion is very prone to precision loss: for example, <code class="docutils literal notranslate"><span class="pre">int64</span></code> (with a maximum value of <span class="math notranslate nohighlight">\(9.2 \times 10^{18}\)</span>) can be promoted to <code class="docutils literal notranslate"><span class="pre">float16</span></code> (with a maximum value of <span class="math notranslate nohighlight">\(6.5 \times 10^4\)</span>), meaning most representable values will become <code class="docutils literal notranslate"><span class="pre">inf</span></code>.</p></li>
<li><p>as mentioned above, <code class="docutils literal notranslate"><span class="pre">f*</span></code> can no longer be thought of as a ‚Äúscalar type‚Äù, but as a different flavor of float64. In JAX‚Äôs parlance, this is referred to as a <a class="reference external" href="https://docs.jax.dev/en/latest/type_promotion.html#weakly-typed-values-in-jax"><em>weak type</em></a>, in that it is represented as 64-bit, but only weakly holds to this bit width in promotion with other values.</p></li>
</ul>
<p>Note that also, this approach still leaves the <code class="docutils literal notranslate"><span class="pre">uint64</span></code> promotion question unanswered, although it is perhaps reasonable to close the lattice by connecting <code class="docutils literal notranslate"><span class="pre">u64</span></code> to <code class="docutils literal notranslate"><span class="pre">f*</span></code>.</p>
</section>
</section>
<section id="type-promotion-in-jax">
<h2>Type Promotion in JAX<a class="headerlink" href="#type-promotion-in-jax" title="Link to this heading">#</a></h2>
<p>In designing the type promotion semantics of JAX, we kept in mind many of these ideas, and leaned heavily on a few things:</p>
<ol class="arabic simple">
<li><p>We chose to constrain JAX‚Äôs type promotion semantics to graphs that satisfy the lattice property: this is to ensure associativity and commutativity, but also to allow the semantics to be compactly described in a DAG, rather than requiring a large table.</p></li>
<li><p>We leaned toward semantics that avoid inadvertent promotion to wider types, particularly when it comes to float values, in order to benefit computation on accelerators.</p></li>
<li><p>We were fine accepting potential loss of precision (but not loss of magnitude) in mixed type promotion if it were required to maintain (1) and (2)</p></li>
</ol>
<p>With this in mind, JAX has adopted Option 3. Or rather, a slightly modified version of Option 3 that draws the connection between <code class="docutils literal notranslate"><span class="pre">u64</span></code> and <code class="docutils literal notranslate"><span class="pre">f*</span></code>, in order to create a true lattice.
Rearranging the nodes for clarity, JAX‚Äôs type promotion lattice then looks like this:</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="n">lattice</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;i*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u8&#39;</span><span class="p">,</span> <span class="s1">&#39;i8&#39;</span><span class="p">],</span> <span class="s1">&#39;f*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c*&#39;</span><span class="p">,</span> <span class="s1">&#39;f16&#39;</span><span class="p">,</span> <span class="s1">&#39;bf16&#39;</span><span class="p">],</span> <span class="s1">&#39;c*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c64&#39;</span><span class="p">],</span>
  <span class="s1">&#39;u8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u16&#39;</span><span class="p">,</span> <span class="s1">&#39;i16&#39;</span><span class="p">],</span> <span class="s1">&#39;u16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u32&#39;</span><span class="p">,</span> <span class="s1">&#39;i32&#39;</span><span class="p">],</span> <span class="s1">&#39;u32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;u64&#39;</span><span class="p">,</span> <span class="s1">&#39;i64&#39;</span><span class="p">],</span> <span class="s1">&#39;u64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f*&#39;</span><span class="p">],</span>
  <span class="s1">&#39;i8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i16&#39;</span><span class="p">],</span> <span class="s1">&#39;i16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i32&#39;</span><span class="p">],</span> <span class="s1">&#39;i32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i64&#39;</span><span class="p">],</span> <span class="s1">&#39;i64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f*&#39;</span><span class="p">],</span>
  <span class="s1">&#39;f16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f32&#39;</span><span class="p">],</span> <span class="s1">&#39;bf16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f32&#39;</span><span class="p">],</span> <span class="s1">&#39;f32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f64&#39;</span><span class="p">,</span> <span class="s1">&#39;c64&#39;</span><span class="p">],</span> <span class="s1">&#39;f64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c128&#39;</span><span class="p">],</span>
  <span class="s1">&#39;c64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;c128&#39;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_dict_of_lists</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">create_using</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;i*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="s1">&#39;f*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">4.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="s1">&#39;c*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">],</span>
  <span class="s1">&#39;u8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;u16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;u32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;u64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
  <span class="s1">&#39;i8&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;i64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
  <span class="s1">&#39;f16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.75</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">],</span> <span class="s1">&#39;bf16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.75</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span> <span class="s1">&#39;f32&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="s1">&#39;f64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>
  <span class="s1">&#39;c64&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">7.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">],</span> <span class="s1">&#39;c128&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">8.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="c1"># ax.patches[12].set_linestyle((0, (2, 4)))</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/d261add493a579484d9772634ce146f1240af3966d0845839c354417a3de2e53.png" src="../_images/d261add493a579484d9772634ce146f1240af3966d0845839c354417a3de2e53.png" />
</div>
</div>
<p>The behavior resulting from this choice is summarized in <a class="reference external" href="https://docs.jax.dev/en/latest/type_promotion.html">JAX Type Promotion Semantics</a>. Notably, aside from the inclusion of larger unsigned types (<code class="docutils literal notranslate"><span class="pre">u16</span></code>, <code class="docutils literal notranslate"><span class="pre">u32</span></code>, <code class="docutils literal notranslate"><span class="pre">u64</span></code>) and some details about the behavior of scalar/weak types (<code class="docutils literal notranslate"><span class="pre">i*</span></code>, <code class="docutils literal notranslate"><span class="pre">f*</span></code>, <code class="docutils literal notranslate"><span class="pre">c*</span></code>), this type promotion scheme turns out to be very close to that chosen by PyTorch.</p>
<p>For those interested, the appendix below prints the full promotion tables used by NumPy, Tensorflow, PyTorch, and JAX.</p>
</section>
<section id="appendix-example-type-promotion-tables">
<h2>Appendix: Example Type Promotion Tables<a class="headerlink" href="#appendix-example-type-promotion-tables" title="Link to this heading">#</a></h2>
<p>The following are some examples of implicit type promotion tables implemented by various Python array computing libraries.</p>
<section id="numpy-type-promotion">
<h3>NumPy Type Promotion<a class="headerlink" href="#numpy-type-promotion" title="Link to this heading">#</a></h3>
<p>Note that NumPy does not include the <code class="docutils literal notranslate"><span class="pre">bfloat16</span></code> dtype, and that the table below ignores value-dependent effects.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span>

<span class="n">np_dtypes</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">,</span>
  <span class="s1">&#39;u8&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="s1">&#39;u16&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">,</span> <span class="s1">&#39;u32&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span> <span class="s1">&#39;u64&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">,</span>
  <span class="s1">&#39;i8&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">,</span> <span class="s1">&#39;i16&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span> <span class="s1">&#39;i32&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="s1">&#39;i64&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
  <span class="s1">&#39;bf16&#39;</span><span class="p">:</span> <span class="s1">&#39;invalid&#39;</span><span class="p">,</span> <span class="s1">&#39;f16&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span> <span class="s1">&#39;f32&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="s1">&#39;f64&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
  <span class="s1">&#39;c64&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">,</span> <span class="s1">&#39;c128&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">,</span>
  <span class="s1">&#39;i*&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;f*&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s1">&#39;c*&#39;</span><span class="p">:</span> <span class="nb">complex</span><span class="p">}</span>

<span class="n">np_dtype_to_code</span> <span class="o">=</span> <span class="p">{</span><span class="n">val</span><span class="p">:</span> <span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">np_dtypes</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">make_np_zero</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">{</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">}:</span>
    <span class="k">return</span> <span class="n">dtype</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">np_result_code</span><span class="p">(</span><span class="n">dtype1</span><span class="p">,</span> <span class="n">dtype2</span><span class="p">):</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">make_np_zero</span><span class="p">(</span><span class="n">dtype1</span><span class="p">),</span> <span class="n">make_np_zero</span><span class="p">(</span><span class="n">dtype2</span><span class="p">))</span>
  <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
    <span class="k">return</span> <span class="s1">&#39;-&#39;</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">}:</span>
      <span class="k">return</span> <span class="n">np_dtype_to_code</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">out</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">np_dtype_to_code</span><span class="p">[</span><span class="n">out</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span><span class="p">]</span>


<span class="n">grid</span> <span class="o">=</span> <span class="p">[[</span><span class="n">np_result_code</span><span class="p">(</span><span class="n">dtype1</span><span class="p">,</span> <span class="n">dtype2</span><span class="p">)</span>
         <span class="k">for</span> <span class="n">dtype2</span> <span class="ow">in</span> <span class="n">np_dtypes</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="k">for</span> <span class="n">dtype1</span> <span class="ow">in</span> <span class="n">np_dtypes</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">np_dtypes</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="n">np_dtypes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">display</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">to_html</span><span class="p">())</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html"><table border="1" class="dataframe" style="font-size: 80%;">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>b</th>
      <th>u8</th>
      <th>u16</th>
      <th>u32</th>
      <th>u64</th>
      <th>i8</th>
      <th>i16</th>
      <th>i32</th>
      <th>i64</th>
      <th>bf16</th>
      <th>f16</th>
      <th>f32</th>
      <th>f64</th>
      <th>c64</th>
      <th>c128</th>
      <th>i*</th>
      <th>f*</th>
      <th>c*</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>b</th>
      <td>b</td>
      <td>u8</td>
      <td>u16</td>
      <td>u32</td>
      <td>u64</td>
      <td>i8</td>
      <td>i16</td>
      <td>i32</td>
      <td>i64</td>
      <td>-</td>
      <td>f16</td>
      <td>f32</td>
      <td>f64</td>
      <td>c64</td>
      <td>c128</td>
      <td>i64</td>
      <td>f64</td>
      <td>c128</td>
    </tr>
    <tr>
      <th>u8</th>
      <td>u8</td>
      <td>u8</td>
      <td>u16</td>
      <td>u32</td>
      <td>u64</td>
      <td>i16</td>
      <td>i16</td>
      <td>i32</td>
      <td>i64</td>
      <td>-</td>
      <td>f16</td>
      <td>f32</td>
      <td>f64</td>
      <td>c64</td>
      <td>c128</td>
      <td>u8</td>
      <td>f64</td>
      <td>c128</td>
    </tr>
    <tr>
      <th>u16</th>
      <td>u16</td>
      <td>u16</td>
      <td>u16</td>
      <td>u32</td>
      <td>u64</td>
      <td>i32</td>
      <td>i32</td>
      <td>i32</td>
      <td>i64</td>
      <td>-</td>
      <td>f32</td>
      <td>f32</td>
      <td>f64</td>
      <td>c64</td>
      <td>c128</td>
      <td>u16</td>
      <td>f64</td>
      <td>c128</td>
    </tr>
    <tr>
      <th>u32</th>
      <td>u32</td>
      <td>u32</td>
      <td>u32</td>
      <td>u32</td>
      <td>u64</td>
      <td>i64</td>
      <td>i64</td>
      <td>i64</td>
      <td>i64</td>
      <td>-</td>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>c128</td>
      <td>c128</td>
      <td>u32</td>
      <td>f64</td>
      <td>c128</td>
    </tr>
    <tr>
      <th>u64</th>
      <td>u64</td>
      <td>u64</td>
      <td>u64</td>
      <td>u64</td>
      <td>u64</td>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>-</td>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>c128</td>
      <td>c128</td>
      <td>u64</td>
      <td>f64</td>
      <td>c128</td>
    </tr>
    <tr>
      <th>i8</th>
      <td>i8</td>
      <td>i16</td>
      <td>i32</td>
      <td>i64</td>
      <td>f64</td>
      <td>i8</td>
      <td>i16</td>
      <td>i32</td>
      <td>i64</td>
      <td>-</td>
      <td>f16</td>
      <td>f32</td>
      <td>f64</td>
      <td>c64</td>
      <td>c128</td>
      <td>i8</td>
      <td>f64</td>
      <td>c128</td>
    </tr>
    <tr>
      <th>i16</th>
      <td>i16</td>
      <td>i16</td>
      <td>i32</td>
      <td>i64</td>
      <td>f64</td>
      <td>i16</td>
      <td>i16</td>
      <td>i32</td>
      <td>i64</td>
      <td>-</td>
      <td>f32</td>
      <td>f32</td>
      <td>f64</td>
      <td>c64</td>
      <td>c128</td>
      <td>i16</td>
      <td>f64</td>
      <td>c128</td>
    </tr>
    <tr>
      <th>i32</th>
      <td>i32</td>
      <td>i32</td>
      <td>i32</td>
      <td>i64</td>
      <td>f64</td>
      <td>i32</td>
      <td>i32</td>
      <td>i32</td>
      <td>i64</td>
      <td>-</td>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>c128</td>
      <td>c128</td>
      <td>i32</td>
      <td>f64</td>
      <td>c128</td>
    </tr>
    <tr>
      <th>i64</th>
      <td>i64</td>
      <td>i64</td>
      <td>i64</td>
      <td>i64</td>
      <td>f64</td>
      <td>i64</td>
      <td>i64</td>
      <td>i64</td>
      <td>i64</td>
      <td>-</td>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>c128</td>
      <td>c128</td>
      <td>i64</td>
      <td>f64</td>
      <td>c128</td>
    </tr>
    <tr>
      <th>bf16</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <th>f16</th>
      <td>f16</td>
      <td>f16</td>
      <td>f32</td>
      <td>f64</td>
      <td>f64</td>
      <td>f16</td>
      <td>f32</td>
      <td>f64</td>
      <td>f64</td>
      <td>-</td>
      <td>f16</td>
      <td>f32</td>
      <td>f64</td>
      <td>c64</td>
      <td>c128</td>
      <td>f16</td>
      <td>f16</td>
      <td>c64</td>
    </tr>
    <tr>
      <th>f32</th>
      <td>f32</td>
      <td>f32</td>
      <td>f32</td>
      <td>f64</td>
      <td>f64</td>
      <td>f32</td>
      <td>f32</td>
      <td>f64</td>
      <td>f64</td>
      <td>-</td>
      <td>f32</td>
      <td>f32</td>
      <td>f64</td>
      <td>c64</td>
      <td>c128</td>
      <td>f32</td>
      <td>f32</td>
      <td>c64</td>
    </tr>
    <tr>
      <th>f64</th>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>-</td>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>c128</td>
      <td>c128</td>
      <td>f64</td>
      <td>f64</td>
      <td>c128</td>
    </tr>
    <tr>
      <th>c64</th>
      <td>c64</td>
      <td>c64</td>
      <td>c64</td>
      <td>c128</td>
      <td>c128</td>
      <td>c64</td>
      <td>c64</td>
      <td>c128</td>
      <td>c128</td>
      <td>-</td>
      <td>c64</td>
      <td>c64</td>
      <td>c128</td>
      <td>c64</td>
      <td>c128</td>
      <td>c64</td>
      <td>c64</td>
      <td>c64</td>
    </tr>
    <tr>
      <th>c128</th>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>-</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
    </tr>
    <tr>
      <th>i*</th>
      <td>i64</td>
      <td>u8</td>
      <td>u16</td>
      <td>u32</td>
      <td>u64</td>
      <td>i8</td>
      <td>i16</td>
      <td>i32</td>
      <td>i64</td>
      <td>-</td>
      <td>f16</td>
      <td>f32</td>
      <td>f64</td>
      <td>c64</td>
      <td>c128</td>
      <td>i64</td>
      <td>f64</td>
      <td>c128</td>
    </tr>
    <tr>
      <th>f*</th>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>-</td>
      <td>f16</td>
      <td>f32</td>
      <td>f64</td>
      <td>c64</td>
      <td>c128</td>
      <td>f64</td>
      <td>f64</td>
      <td>c128</td>
    </tr>
    <tr>
      <th>c*</th>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>-</td>
      <td>c64</td>
      <td>c64</td>
      <td>c128</td>
      <td>c64</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
    </tr>
  </tbody>
</table></div></div>
</div>
</section>
<section id="tensorflow-type-promotion">
<h3>Tensorflow Type Promotion<a class="headerlink" href="#tensorflow-type-promotion" title="Link to this heading">#</a></h3>
<p>Tensorflow avoids defining implicit type promotion, except for Python scalars in limited cases. The table is asymmetric because in <code class="docutils literal notranslate"><span class="pre">tf.add(x,</span> <span class="pre">y)</span></code>, the type of <code class="docutils literal notranslate"><span class="pre">y</span></code> must be coercible to the type of <code class="docutils literal notranslate"><span class="pre">x</span></code>.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">tensorflow</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tf</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span>

<span class="n">tf_dtypes</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span>
  <span class="s1">&#39;u8&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="s1">&#39;u16&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">uint16</span><span class="p">,</span> <span class="s1">&#39;u32&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span> <span class="s1">&#39;u64&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">uint64</span><span class="p">,</span>
  <span class="s1">&#39;i8&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">int8</span><span class="p">,</span> <span class="s1">&#39;i16&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span> <span class="s1">&#39;i32&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="s1">&#39;i64&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
  <span class="s1">&#39;bf16&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">,</span> <span class="s1">&#39;f16&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span> <span class="s1">&#39;f32&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="s1">&#39;f64&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
  <span class="s1">&#39;c64&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">complex64</span><span class="p">,</span> <span class="s1">&#39;c128&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">complex128</span><span class="p">,</span>
  <span class="s1">&#39;i*&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;f*&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s1">&#39;c*&#39;</span><span class="p">:</span> <span class="nb">complex</span><span class="p">}</span>

<span class="n">tf_dtype_to_code</span> <span class="o">=</span> <span class="p">{</span><span class="n">val</span><span class="p">:</span> <span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">tf_dtypes</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">make_tf_zero</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">{</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">}:</span>
    <span class="k">return</span> <span class="n">dtype</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">result_code</span><span class="p">(</span><span class="n">dtype1</span><span class="p">,</span> <span class="n">dtype2</span><span class="p">):</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">make_tf_zero</span><span class="p">(</span><span class="n">dtype1</span><span class="p">),</span> <span class="n">make_tf_zero</span><span class="p">(</span><span class="n">dtype2</span><span class="p">))</span>
  <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidArgumentError</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;-&#39;</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">}:</span>
      <span class="k">return</span> <span class="n">tf_dtype_to_code</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">out</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">tf_dtype_to_code</span><span class="p">[</span><span class="n">out</span><span class="o">.</span><span class="n">dtype</span><span class="p">]</span>


<span class="n">grid</span> <span class="o">=</span> <span class="p">[[</span><span class="n">result_code</span><span class="p">(</span><span class="n">dtype1</span><span class="p">,</span> <span class="n">dtype2</span><span class="p">)</span>
         <span class="k">for</span> <span class="n">dtype2</span> <span class="ow">in</span> <span class="n">tf_dtypes</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="k">for</span> <span class="n">dtype1</span> <span class="ow">in</span> <span class="n">tf_dtypes</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">tf_dtypes</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="n">tf_dtypes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">display</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">to_html</span><span class="p">())</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html"><table border="1" class="dataframe" style="font-size: 80%;">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>b</th>
      <th>u8</th>
      <th>u16</th>
      <th>u32</th>
      <th>u64</th>
      <th>i8</th>
      <th>i16</th>
      <th>i32</th>
      <th>i64</th>
      <th>bf16</th>
      <th>f16</th>
      <th>f32</th>
      <th>f64</th>
      <th>c64</th>
      <th>c128</th>
      <th>i*</th>
      <th>f*</th>
      <th>c*</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>b</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <th>u8</th>
      <td>-</td>
      <td>u8</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>u8</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <th>u16</th>
      <td>-</td>
      <td>-</td>
      <td>u16</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>u16</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <th>u32</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>u32</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>u32</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <th>u64</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>u64</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>u64</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <th>i8</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>i8</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>i8</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <th>i16</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>i16</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>i16</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <th>i32</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>i32</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>i32</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <th>i64</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>i64</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>i64</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <th>bf16</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>bf16</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>bf16</td>
      <td>bf16</td>
      <td>-</td>
    </tr>
    <tr>
      <th>f16</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>f16</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>f16</td>
      <td>f16</td>
      <td>-</td>
    </tr>
    <tr>
      <th>f32</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>f32</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>f32</td>
      <td>f32</td>
      <td>-</td>
    </tr>
    <tr>
      <th>f64</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>f64</td>
      <td>-</td>
      <td>-</td>
      <td>f64</td>
      <td>f64</td>
      <td>-</td>
    </tr>
    <tr>
      <th>c64</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>c64</td>
      <td>-</td>
      <td>c64</td>
      <td>c64</td>
      <td>c64</td>
    </tr>
    <tr>
      <th>c128</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
    </tr>
    <tr>
      <th>i*</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>i32</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>i32</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <th>f*</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>f32</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>f32</td>
      <td>f32</td>
      <td>-</td>
    </tr>
    <tr>
      <th>c*</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
    </tr>
  </tbody>
</table></div></div>
</div>
</section>
<section id="pytorch-type-promotion">
<h3>PyTorch Type Promotion<a class="headerlink" href="#pytorch-type-promotion" title="Link to this heading">#</a></h3>
<p>Notice that torch does not include unsigned integer types larger than <code class="docutils literal notranslate"><span class="pre">uint8</span></code>.
Aside from this and some details about promotion with scalar/weak types, the table is close to that used by <code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code>.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span>

<span class="n">torch_dtypes</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span>
  <span class="s1">&#39;u8&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="s1">&#39;u16&#39;</span><span class="p">:</span> <span class="s1">&#39;invalid&#39;</span><span class="p">,</span> <span class="s1">&#39;u32&#39;</span><span class="p">:</span> <span class="s1">&#39;invalid&#39;</span><span class="p">,</span> <span class="s1">&#39;u64&#39;</span><span class="p">:</span> <span class="s1">&#39;invalid&#39;</span><span class="p">,</span>
  <span class="s1">&#39;i8&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">int8</span><span class="p">,</span> <span class="s1">&#39;i16&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span> <span class="s1">&#39;i32&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="s1">&#39;i64&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
  <span class="s1">&#39;bf16&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">,</span> <span class="s1">&#39;f16&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span> <span class="s1">&#39;f32&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="s1">&#39;f64&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
  <span class="s1">&#39;c64&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">complex64</span><span class="p">,</span> <span class="s1">&#39;c128&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">complex128</span><span class="p">,</span>
  <span class="s1">&#39;i*&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;f*&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s1">&#39;c*&#39;</span><span class="p">:</span> <span class="nb">complex</span><span class="p">}</span>

<span class="n">torch_dtype_to_code</span> <span class="o">=</span> <span class="p">{</span><span class="n">val</span><span class="p">:</span> <span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">torch_dtypes</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">make_torch_zero</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">{</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">}:</span>
    <span class="k">return</span> <span class="n">dtype</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">torch_result_code</span><span class="p">(</span><span class="n">dtype1</span><span class="p">,</span> <span class="n">dtype2</span><span class="p">):</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">make_torch_zero</span><span class="p">(</span><span class="n">dtype1</span><span class="p">),</span> <span class="n">make_torch_zero</span><span class="p">(</span><span class="n">dtype2</span><span class="p">))</span>
  <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
    <span class="k">return</span> <span class="s1">&#39;-&#39;</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">}:</span>
      <span class="k">return</span> <span class="n">torch_dtype_to_code</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">out</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">torch_dtype_to_code</span><span class="p">[</span><span class="n">out</span><span class="o">.</span><span class="n">dtype</span><span class="p">]</span>


<span class="n">grid</span> <span class="o">=</span> <span class="p">[[</span><span class="n">torch_result_code</span><span class="p">(</span><span class="n">dtype1</span><span class="p">,</span> <span class="n">dtype2</span><span class="p">)</span>
         <span class="k">for</span> <span class="n">dtype2</span> <span class="ow">in</span> <span class="n">torch_dtypes</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="k">for</span> <span class="n">dtype1</span> <span class="ow">in</span> <span class="n">torch_dtypes</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">torch_dtypes</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="n">torch_dtypes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">display</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">to_html</span><span class="p">())</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html"><table border="1" class="dataframe" style="font-size: 80%;">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>b</th>
      <th>u8</th>
      <th>u16</th>
      <th>u32</th>
      <th>u64</th>
      <th>i8</th>
      <th>i16</th>
      <th>i32</th>
      <th>i64</th>
      <th>bf16</th>
      <th>f16</th>
      <th>f32</th>
      <th>f64</th>
      <th>c64</th>
      <th>c128</th>
      <th>i*</th>
      <th>f*</th>
      <th>c*</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>b</th>
      <td>b</td>
      <td>u8</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>i8</td>
      <td>i16</td>
      <td>i32</td>
      <td>i64</td>
      <td>bf16</td>
      <td>f16</td>
      <td>f32</td>
      <td>f64</td>
      <td>c64</td>
      <td>c128</td>
      <td>i64</td>
      <td>f32</td>
      <td>c64</td>
    </tr>
    <tr>
      <th>u8</th>
      <td>u8</td>
      <td>u8</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>i16</td>
      <td>i16</td>
      <td>i32</td>
      <td>i64</td>
      <td>bf16</td>
      <td>f16</td>
      <td>f32</td>
      <td>f64</td>
      <td>c64</td>
      <td>c128</td>
      <td>u8</td>
      <td>f32</td>
      <td>c64</td>
    </tr>
    <tr>
      <th>u16</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <th>u32</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <th>u64</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <th>i8</th>
      <td>i8</td>
      <td>i16</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>i8</td>
      <td>i16</td>
      <td>i32</td>
      <td>i64</td>
      <td>bf16</td>
      <td>f16</td>
      <td>f32</td>
      <td>f64</td>
      <td>c64</td>
      <td>c128</td>
      <td>i8</td>
      <td>f32</td>
      <td>c64</td>
    </tr>
    <tr>
      <th>i16</th>
      <td>i16</td>
      <td>i16</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>i16</td>
      <td>i16</td>
      <td>i32</td>
      <td>i64</td>
      <td>bf16</td>
      <td>f16</td>
      <td>f32</td>
      <td>f64</td>
      <td>c64</td>
      <td>c128</td>
      <td>i16</td>
      <td>f32</td>
      <td>c64</td>
    </tr>
    <tr>
      <th>i32</th>
      <td>i32</td>
      <td>i32</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>i32</td>
      <td>i32</td>
      <td>i32</td>
      <td>i64</td>
      <td>bf16</td>
      <td>f16</td>
      <td>f32</td>
      <td>f64</td>
      <td>c64</td>
      <td>c128</td>
      <td>i32</td>
      <td>f32</td>
      <td>c64</td>
    </tr>
    <tr>
      <th>i64</th>
      <td>i64</td>
      <td>i64</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>i64</td>
      <td>i64</td>
      <td>i64</td>
      <td>i64</td>
      <td>bf16</td>
      <td>f16</td>
      <td>f32</td>
      <td>f64</td>
      <td>c64</td>
      <td>c128</td>
      <td>i64</td>
      <td>f32</td>
      <td>c64</td>
    </tr>
    <tr>
      <th>bf16</th>
      <td>bf16</td>
      <td>bf16</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>bf16</td>
      <td>bf16</td>
      <td>bf16</td>
      <td>bf16</td>
      <td>bf16</td>
      <td>f32</td>
      <td>f32</td>
      <td>f64</td>
      <td>c64</td>
      <td>c128</td>
      <td>bf16</td>
      <td>bf16</td>
      <td>c64</td>
    </tr>
    <tr>
      <th>f16</th>
      <td>f16</td>
      <td>f16</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>f16</td>
      <td>f16</td>
      <td>f16</td>
      <td>f16</td>
      <td>f32</td>
      <td>f16</td>
      <td>f32</td>
      <td>f64</td>
      <td>c64</td>
      <td>c128</td>
      <td>f16</td>
      <td>f16</td>
      <td>c64</td>
    </tr>
    <tr>
      <th>f32</th>
      <td>f32</td>
      <td>f32</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>f32</td>
      <td>f32</td>
      <td>f32</td>
      <td>f32</td>
      <td>f32</td>
      <td>f32</td>
      <td>f32</td>
      <td>f64</td>
      <td>c64</td>
      <td>c128</td>
      <td>f32</td>
      <td>f32</td>
      <td>c64</td>
    </tr>
    <tr>
      <th>f64</th>
      <td>f64</td>
      <td>f64</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>c128</td>
      <td>c128</td>
      <td>f64</td>
      <td>f64</td>
      <td>c128</td>
    </tr>
    <tr>
      <th>c64</th>
      <td>c64</td>
      <td>c64</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>c64</td>
      <td>c64</td>
      <td>c64</td>
      <td>c64</td>
      <td>c64</td>
      <td>c64</td>
      <td>c64</td>
      <td>c128</td>
      <td>c64</td>
      <td>c128</td>
      <td>c64</td>
      <td>c64</td>
      <td>c64</td>
    </tr>
    <tr>
      <th>c128</th>
      <td>c128</td>
      <td>c128</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
    </tr>
    <tr>
      <th>i*</th>
      <td>i64</td>
      <td>u8</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>i8</td>
      <td>i16</td>
      <td>i32</td>
      <td>i64</td>
      <td>bf16</td>
      <td>f16</td>
      <td>f32</td>
      <td>f64</td>
      <td>c64</td>
      <td>c128</td>
      <td>i64</td>
      <td>f32</td>
      <td>c64</td>
    </tr>
    <tr>
      <th>f*</th>
      <td>f32</td>
      <td>f32</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>f32</td>
      <td>f32</td>
      <td>f32</td>
      <td>f32</td>
      <td>bf16</td>
      <td>f16</td>
      <td>f32</td>
      <td>f64</td>
      <td>c64</td>
      <td>c128</td>
      <td>f32</td>
      <td>f64</td>
      <td>c64</td>
    </tr>
    <tr>
      <th>c*</th>
      <td>c64</td>
      <td>c64</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>c64</td>
      <td>c64</td>
      <td>c64</td>
      <td>c64</td>
      <td>c64</td>
      <td>c64</td>
      <td>c64</td>
      <td>c128</td>
      <td>c64</td>
      <td>c128</td>
      <td>c64</td>
      <td>c64</td>
      <td>c128</td>
    </tr>
  </tbody>
</table></div></div>
</div>
</section>
<section id="jax-type-promotion-jax-numpy">
<h3>JAX Type Promotion: <code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code><a class="headerlink" href="#jax-type-promotion-jax-numpy" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code> follows type promotion rules laid out at https://docs.jax.dev/en/latest/type_promotion.html. Here we use <code class="docutils literal notranslate"><span class="pre">i*</span></code>, <code class="docutils literal notranslate"><span class="pre">f*</span></code>, <code class="docutils literal notranslate"><span class="pre">c*</span></code> to indicate both Python scalars and weakly-typed arrays.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jax</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jax.numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">jnp</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span>
<span class="n">jax</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s1">&#39;jax_enable_x64&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

<span class="n">jnp_dtypes</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">bool_</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
  <span class="s1">&#39;u8&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">uint8</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">&#39;u16&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">uint16</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">&#39;u32&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">uint32</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">&#39;u64&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">uint64</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
  <span class="s1">&#39;i8&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">int8</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">&#39;i16&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">int16</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">&#39;i32&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">&#39;i64&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">int64</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
  <span class="s1">&#39;bf16&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">bfloat16</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">&#39;f16&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float16</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">&#39;f32&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">&#39;f64&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float64</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
  <span class="s1">&#39;c64&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">complex64</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">&#39;c128&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">complex128</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
  <span class="s1">&#39;i*&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;f*&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s1">&#39;c*&#39;</span><span class="p">:</span> <span class="nb">complex</span><span class="p">}</span>


<span class="n">jnp_dtype_to_code</span> <span class="o">=</span> <span class="p">{</span><span class="n">val</span><span class="p">:</span> <span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">jnp_dtypes</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">make_jnp_zero</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">{</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">}:</span>
    <span class="k">return</span> <span class="n">dtype</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">jnp_result_code</span><span class="p">(</span><span class="n">dtype1</span><span class="p">,</span> <span class="n">dtype2</span><span class="p">):</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">make_jnp_zero</span><span class="p">(</span><span class="n">dtype1</span><span class="p">),</span> <span class="n">make_jnp_zero</span><span class="p">(</span><span class="n">dtype2</span><span class="p">))</span>
  <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
    <span class="k">return</span> <span class="s1">&#39;-&#39;</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s1">&#39;aval&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">out</span><span class="o">.</span><span class="n">aval</span><span class="o">.</span><span class="n">weak_type</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">}:</span>
      <span class="k">return</span> <span class="n">jnp_dtype_to_code</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">out</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">jnp_dtype_to_code</span><span class="p">[</span><span class="n">out</span><span class="o">.</span><span class="n">dtype</span><span class="p">]</span>

<span class="n">grid</span> <span class="o">=</span> <span class="p">[[</span><span class="n">jnp_result_code</span><span class="p">(</span><span class="n">dtype1</span><span class="p">,</span> <span class="n">dtype2</span><span class="p">)</span>
         <span class="k">for</span> <span class="n">dtype2</span> <span class="ow">in</span> <span class="n">jnp_dtypes</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="k">for</span> <span class="n">dtype1</span> <span class="ow">in</span> <span class="n">jnp_dtypes</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">jnp_dtypes</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="n">jnp_dtypes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">display</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">to_html</span><span class="p">())</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html"><table border="1" class="dataframe" style="font-size: 80%;">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>b</th>
      <th>u8</th>
      <th>u16</th>
      <th>u32</th>
      <th>u64</th>
      <th>i8</th>
      <th>i16</th>
      <th>i32</th>
      <th>i64</th>
      <th>bf16</th>
      <th>f16</th>
      <th>f32</th>
      <th>f64</th>
      <th>c64</th>
      <th>c128</th>
      <th>i*</th>
      <th>f*</th>
      <th>c*</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>b</th>
      <td>b</td>
      <td>u8</td>
      <td>u16</td>
      <td>u32</td>
      <td>u64</td>
      <td>i8</td>
      <td>i16</td>
      <td>i32</td>
      <td>i64</td>
      <td>bf16</td>
      <td>f16</td>
      <td>f32</td>
      <td>f64</td>
      <td>c64</td>
      <td>c128</td>
      <td>i*</td>
      <td>f*</td>
      <td>c*</td>
    </tr>
    <tr>
      <th>u8</th>
      <td>u8</td>
      <td>u8</td>
      <td>u16</td>
      <td>u32</td>
      <td>u64</td>
      <td>i16</td>
      <td>i16</td>
      <td>i32</td>
      <td>i64</td>
      <td>bf16</td>
      <td>f16</td>
      <td>f32</td>
      <td>f64</td>
      <td>c64</td>
      <td>c128</td>
      <td>u8</td>
      <td>f*</td>
      <td>c*</td>
    </tr>
    <tr>
      <th>u16</th>
      <td>u16</td>
      <td>u16</td>
      <td>u16</td>
      <td>u32</td>
      <td>u64</td>
      <td>i32</td>
      <td>i32</td>
      <td>i32</td>
      <td>i64</td>
      <td>bf16</td>
      <td>f16</td>
      <td>f32</td>
      <td>f64</td>
      <td>c64</td>
      <td>c128</td>
      <td>u16</td>
      <td>f*</td>
      <td>c*</td>
    </tr>
    <tr>
      <th>u32</th>
      <td>u32</td>
      <td>u32</td>
      <td>u32</td>
      <td>u32</td>
      <td>u64</td>
      <td>i64</td>
      <td>i64</td>
      <td>i64</td>
      <td>i64</td>
      <td>bf16</td>
      <td>f16</td>
      <td>f32</td>
      <td>f64</td>
      <td>c64</td>
      <td>c128</td>
      <td>u32</td>
      <td>f*</td>
      <td>c*</td>
    </tr>
    <tr>
      <th>u64</th>
      <td>u64</td>
      <td>u64</td>
      <td>u64</td>
      <td>u64</td>
      <td>u64</td>
      <td>f*</td>
      <td>f*</td>
      <td>f*</td>
      <td>f*</td>
      <td>bf16</td>
      <td>f16</td>
      <td>f32</td>
      <td>f64</td>
      <td>c64</td>
      <td>c128</td>
      <td>u64</td>
      <td>f*</td>
      <td>c*</td>
    </tr>
    <tr>
      <th>i8</th>
      <td>i8</td>
      <td>i16</td>
      <td>i32</td>
      <td>i64</td>
      <td>f*</td>
      <td>i8</td>
      <td>i16</td>
      <td>i32</td>
      <td>i64</td>
      <td>bf16</td>
      <td>f16</td>
      <td>f32</td>
      <td>f64</td>
      <td>c64</td>
      <td>c128</td>
      <td>i8</td>
      <td>f*</td>
      <td>c*</td>
    </tr>
    <tr>
      <th>i16</th>
      <td>i16</td>
      <td>i16</td>
      <td>i32</td>
      <td>i64</td>
      <td>f*</td>
      <td>i16</td>
      <td>i16</td>
      <td>i32</td>
      <td>i64</td>
      <td>bf16</td>
      <td>f16</td>
      <td>f32</td>
      <td>f64</td>
      <td>c64</td>
      <td>c128</td>
      <td>i16</td>
      <td>f*</td>
      <td>c*</td>
    </tr>
    <tr>
      <th>i32</th>
      <td>i32</td>
      <td>i32</td>
      <td>i32</td>
      <td>i64</td>
      <td>f*</td>
      <td>i32</td>
      <td>i32</td>
      <td>i32</td>
      <td>i64</td>
      <td>bf16</td>
      <td>f16</td>
      <td>f32</td>
      <td>f64</td>
      <td>c64</td>
      <td>c128</td>
      <td>i32</td>
      <td>f*</td>
      <td>c*</td>
    </tr>
    <tr>
      <th>i64</th>
      <td>i64</td>
      <td>i64</td>
      <td>i64</td>
      <td>i64</td>
      <td>f*</td>
      <td>i64</td>
      <td>i64</td>
      <td>i64</td>
      <td>i64</td>
      <td>bf16</td>
      <td>f16</td>
      <td>f32</td>
      <td>f64</td>
      <td>c64</td>
      <td>c128</td>
      <td>i64</td>
      <td>f*</td>
      <td>c*</td>
    </tr>
    <tr>
      <th>bf16</th>
      <td>bf16</td>
      <td>bf16</td>
      <td>bf16</td>
      <td>bf16</td>
      <td>bf16</td>
      <td>bf16</td>
      <td>bf16</td>
      <td>bf16</td>
      <td>bf16</td>
      <td>bf16</td>
      <td>f32</td>
      <td>f32</td>
      <td>f64</td>
      <td>c64</td>
      <td>c128</td>
      <td>bf16</td>
      <td>bf16</td>
      <td>c64</td>
    </tr>
    <tr>
      <th>f16</th>
      <td>f16</td>
      <td>f16</td>
      <td>f16</td>
      <td>f16</td>
      <td>f16</td>
      <td>f16</td>
      <td>f16</td>
      <td>f16</td>
      <td>f16</td>
      <td>f32</td>
      <td>f16</td>
      <td>f32</td>
      <td>f64</td>
      <td>c64</td>
      <td>c128</td>
      <td>f16</td>
      <td>f16</td>
      <td>c64</td>
    </tr>
    <tr>
      <th>f32</th>
      <td>f32</td>
      <td>f32</td>
      <td>f32</td>
      <td>f32</td>
      <td>f32</td>
      <td>f32</td>
      <td>f32</td>
      <td>f32</td>
      <td>f32</td>
      <td>f32</td>
      <td>f32</td>
      <td>f32</td>
      <td>f64</td>
      <td>c64</td>
      <td>c128</td>
      <td>f32</td>
      <td>f32</td>
      <td>c64</td>
    </tr>
    <tr>
      <th>f64</th>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>f64</td>
      <td>c128</td>
      <td>c128</td>
      <td>f64</td>
      <td>f64</td>
      <td>c128</td>
    </tr>
    <tr>
      <th>c64</th>
      <td>c64</td>
      <td>c64</td>
      <td>c64</td>
      <td>c64</td>
      <td>c64</td>
      <td>c64</td>
      <td>c64</td>
      <td>c64</td>
      <td>c64</td>
      <td>c64</td>
      <td>c64</td>
      <td>c64</td>
      <td>c128</td>
      <td>c64</td>
      <td>c128</td>
      <td>c64</td>
      <td>c64</td>
      <td>c64</td>
    </tr>
    <tr>
      <th>c128</th>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
      <td>c128</td>
    </tr>
    <tr>
      <th>i*</th>
      <td>i*</td>
      <td>u8</td>
      <td>u16</td>
      <td>u32</td>
      <td>u64</td>
      <td>i8</td>
      <td>i16</td>
      <td>i32</td>
      <td>i64</td>
      <td>bf16</td>
      <td>f16</td>
      <td>f32</td>
      <td>f64</td>
      <td>c64</td>
      <td>c128</td>
      <td>i*</td>
      <td>f*</td>
      <td>c*</td>
    </tr>
    <tr>
      <th>f*</th>
      <td>f*</td>
      <td>f*</td>
      <td>f*</td>
      <td>f*</td>
      <td>f*</td>
      <td>f*</td>
      <td>f*</td>
      <td>f*</td>
      <td>f*</td>
      <td>bf16</td>
      <td>f16</td>
      <td>f32</td>
      <td>f64</td>
      <td>c64</td>
      <td>c128</td>
      <td>f*</td>
      <td>f*</td>
      <td>c*</td>
    </tr>
    <tr>
      <th>c*</th>
      <td>c*</td>
      <td>c*</td>
      <td>c*</td>
      <td>c*</td>
      <td>c*</td>
      <td>c*</td>
      <td>c*</td>
      <td>c*</td>
      <td>c*</td>
      <td>c64</td>
      <td>c64</td>
      <td>c64</td>
      <td>c128</td>
      <td>c64</td>
      <td>c128</td>
      <td>c*</td>
      <td>c*</td>
      <td>c*</td>
    </tr>
  </tbody>
</table></div></div>
</div>
</section>
<section id="jax-type-promotion-jax-lax">
<h3>JAX Type Promotion: <code class="docutils literal notranslate"><span class="pre">jax.lax</span></code><a class="headerlink" href="#jax-type-promotion-jax-lax" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">jax.lax</span></code> is lower-level, and does not do any implicit promotion. Here we use <code class="docutils literal notranslate"><span class="pre">i*</span></code>, <code class="docutils literal notranslate"><span class="pre">f*</span></code>, <code class="docutils literal notranslate"><span class="pre">c*</span></code> to indicate both Python scalars and weakly-typed arrays.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jax</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jax.numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">jnp</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span>
<span class="n">jax</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s1">&#39;jax_enable_x64&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

<span class="n">jnp_dtypes</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">bool_</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
  <span class="s1">&#39;u8&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">uint8</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">&#39;u16&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">uint16</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">&#39;u32&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">uint32</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">&#39;u64&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">uint64</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
  <span class="s1">&#39;i8&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">int8</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">&#39;i16&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">int16</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">&#39;i32&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">&#39;i64&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">int64</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
  <span class="s1">&#39;bf16&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">bfloat16</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">&#39;f16&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float16</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">&#39;f32&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">&#39;f64&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float64</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
  <span class="s1">&#39;c64&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">complex64</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">&#39;c128&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">complex128</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
  <span class="s1">&#39;i*&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;f*&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s1">&#39;c*&#39;</span><span class="p">:</span> <span class="nb">complex</span><span class="p">}</span>


<span class="n">jnp_dtype_to_code</span> <span class="o">=</span> <span class="p">{</span><span class="n">val</span><span class="p">:</span> <span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">jnp_dtypes</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">make_jnp_zero</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">{</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">}:</span>
    <span class="k">return</span> <span class="n">dtype</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">jnp_result_code</span><span class="p">(</span><span class="n">dtype1</span><span class="p">,</span> <span class="n">dtype2</span><span class="p">):</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">make_jnp_zero</span><span class="p">(</span><span class="n">dtype1</span><span class="p">),</span> <span class="n">make_jnp_zero</span><span class="p">(</span><span class="n">dtype2</span><span class="p">))</span>
  <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
    <span class="k">return</span> <span class="s1">&#39;-&#39;</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s1">&#39;aval&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">out</span><span class="o">.</span><span class="n">aval</span><span class="o">.</span><span class="n">weak_type</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">}:</span>
      <span class="k">return</span> <span class="n">jnp_dtype_to_code</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">out</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">jnp_dtype_to_code</span><span class="p">[</span><span class="n">out</span><span class="o">.</span><span class="n">dtype</span><span class="p">]</span>

<span class="n">grid</span> <span class="o">=</span> <span class="p">[[</span><span class="n">jnp_result_code</span><span class="p">(</span><span class="n">dtype1</span><span class="p">,</span> <span class="n">dtype2</span><span class="p">)</span>
         <span class="k">for</span> <span class="n">dtype2</span> <span class="ow">in</span> <span class="n">jnp_dtypes</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="k">for</span> <span class="n">dtype1</span> <span class="ow">in</span> <span class="n">jnp_dtypes</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">jnp_dtypes</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="n">jnp_dtypes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">display</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">to_html</span><span class="p">())</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html"><table border="1" class="dataframe" style="font-size: 80%;">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>b</th>
      <th>u8</th>
      <th>u16</th>
      <th>u32</th>
      <th>u64</th>
      <th>i8</th>
      <th>i16</th>
      <th>i32</th>
      <th>i64</th>
      <th>bf16</th>
      <th>f16</th>
      <th>f32</th>
      <th>f64</th>
      <th>c64</th>
      <th>c128</th>
      <th>i*</th>
      <th>f*</th>
      <th>c*</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>b</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <th>u8</th>
      <td>-</td>
      <td>u8</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <th>u16</th>
      <td>-</td>
      <td>-</td>
      <td>u16</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <th>u32</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>u32</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <th>u64</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>u64</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <th>i8</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>i8</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <th>i16</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>i16</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <th>i32</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>i32</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <th>i64</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>i64</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>i64</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <th>bf16</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>bf16</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <th>f16</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>f16</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <th>f32</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>f32</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <th>f64</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>f64</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>f64</td>
      <td>-</td>
    </tr>
    <tr>
      <th>c64</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>c64</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <th>c128</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>c128</td>
      <td>-</td>
      <td>-</td>
      <td>c128</td>
    </tr>
    <tr>
      <th>i*</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>i64</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>i*</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <th>f*</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>f64</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>f*</td>
      <td>-</td>
    </tr>
    <tr>
      <th>c*</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>c128</td>
      <td>-</td>
      <td>-</td>
      <td>c*</td>
    </tr>
  </tbody>
</table></div></div>
</div>
</section>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="9263-typed-keys.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">JEP 9263: Typed keys &amp; pluggable RNGs</p>
      </div>
    </a>
    <a class="right-next"
       href="9419-jax-versioning.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Jax and Jaxlib versioning</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#goals-of-jax-type-promotion">Goals of JAX Type Promotion</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#stepping-back-tables-and-lattices">Stepping Back: Tables and Lattices</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#properties-of-a-type-promotion-lattice">Properties of a Type Promotion Lattice</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#type-promotion-within-categories">Type Promotion within Categories</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#enter-python-scalars">Enter Python Scalars</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#combining-lattices">Combining Lattices</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mixed-promotion-float-and-complex">Mixed Promotion: Float and Complex</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mixed-promotion-signed-unsigned-integers">Mixed Promotion: Signed &amp; Unsigned Integers</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-handle-uint64">How to handle <code class="docutils literal notranslate"><span class="pre">uint64</span></code>?</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mixed-promotion-integer-and-floating">Mixed Promotion: Integer and Floating</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#option-0-leave-integer-floating-mixed-precision-undefined">Option 0: Leave integer/floating mixed precision undefined</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#option-1-avoiding-all-precision-loss">Option 1: Avoiding All Precision Loss</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#option-2-avoid-most-wider-than-necessary-promotions">Option 2: Avoid most wider-than-necessary promotions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#option-3-avoid-all-wider-than-necessary-promotions">Option 3: Avoid all wider-than-necessary promotions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#type-promotion-in-jax">Type Promotion in JAX</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#appendix-example-type-promotion-tables">Appendix: Example Type Promotion Tables</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#numpy-type-promotion">NumPy Type Promotion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tensorflow-type-promotion">Tensorflow Type Promotion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pytorch-type-promotion">PyTorch Type Promotion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#jax-type-promotion-jax-numpy">JAX Type Promotion: <code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#jax-type-promotion-jax-lax">JAX Type Promotion: <code class="docutils literal notranslate"><span class="pre">jax.lax</span></code></a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The JAX authors
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      ¬© Copyright 2024, The JAX Authors.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>