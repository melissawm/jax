
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Efficient transposition of replication-inducing collectives &#8212; JAX  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/style.css?v=537c1ddb" />
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=30646c52"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'jep/17111-shmap-transpose';</script>
    <link rel="icon" href="../_static/favicon.png"/>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="JEP 18137: Scope of JAX NumPy &amp; SciPy Wrappers" href="18137-numpy-scipy-scope.html" />
    <link rel="prev" title="jax.extend: a module for extensions" href="15856-jex.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/jax_logo_250px.png" class="logo__image only-light" alt="JAX  documentation - Home"/>
    <script>document.write(`<img src="../_static/jax_logo_250px.png" class="logo__image only-dark" alt="JAX  documentation - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/thinking_in_jax.html">Quickstart: How to think in JAX</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../notebooks/Common_Gotchas_in_JAX.html">🔪 JAX - The Sharp Bits 🔪</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../tutorials.html">Tutorials</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../jit-compilation.html">Just-in-time compilation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../automatic-vectorization.html">Automatic vectorization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../automatic-differentiation.html">Automatic differentiation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tracing.html">Tracing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../random-numbers.html">Pseudorandom numbers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../stateful-computations.html">Stateful computations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../control-flow.html">Control flow and logical operators with JIT</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pytrees.html">Pytrees</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro_parallel.html">Introduction to Parallel Programming with JAX</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Resources and Advanced Guides</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../key-concepts.html">Key concepts</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../advanced_guide.html">Resources and Advanced Guides</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/autodiff_cookbook.html">The Autodiff Cookbook</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/Custom_derivative_rules_for_Python_code.html">Custom derivative rules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/autodiff_remat.html">Control autodiff’s saved values with <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code> (aka <code class="docutils literal notranslate"><span class="pre">jax.remat</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../advanced-autodiff.html">Advanced automatic differentiation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../custom_pytrees.html">Custom pytrees and initialization with unexpected values</a></li>
<li class="toctree-l2"><a class="reference internal" href="../errors.html">Errors</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../debugging.html">Introduction to debugging</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../debugging/print_breakpoint.html">Compiled prints and breakpoints</a></li>
<li class="toctree-l3"><a class="reference internal" href="../debugging/checkify_guide.html">The <code class="docutils literal notranslate"><span class="pre">checkify</span></code> transformation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../debugging/flags.html">JAX debugging flags</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../debugging/flags.html">JAX debugging flags</a></li>
<li class="toctree-l2"><a class="reference internal" href="../transfer_guard.html">Transfer guard</a></li>
<li class="toctree-l2"><a class="reference internal" href="../persistent_compilation_cache.html">Persistent compilation cache</a></li>
<li class="toctree-l2"><a class="reference internal" href="../buffer_donation.html">Buffer donation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gpu_performance_tips.html">GPU performance tips</a></li>
<li class="toctree-l2"><a class="reference internal" href="../benchmarking.html">Benchmarking JAX code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../profiling.html">Profiling computation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../device_memory_profiling.html">Profiling device memory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/Distributed_arrays_and_automatic_parallelization.html">Distributed arrays and automatic parallelization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/explicit-sharding.html">Explicit sharding (a.k.a. “sharding in types”)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/shard_map.html">Manual parallelism with <code class="docutils literal notranslate"><span class="pre">shard_map</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/host-offloading.html">JAX Memories and Host Offloading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../multi_process.html">Introduction to multi-controller JAX (aka multi-process/multi-host JAX)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../distributed_data_loading.html">Distributed data loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../external-callbacks.html">External callbacks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ffi.html">Foreign function interface (FFI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gradient-checkpointing.html">Gradient checkpointing with <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code> (<code class="docutils literal notranslate"><span class="pre">jax.remat</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../aot.html">Ahead-of-time lowering and compilation</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../export/index.html">Exporting and serialization</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../export/export.html">Exporting and serializing staged-out computations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../export/shape_poly.html">Shape polymorphism</a></li>
<li class="toctree-l3"><a class="reference internal" href="../export/jax2tf.html">Interoperation with TensorFlow</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../type_promotion.html">Type promotion semantics</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../pallas/index.html">Pallas: a JAX kernel language</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../pallas/quickstart.html">Pallas Quickstart</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pallas/pipelining.html">Software Pipelining</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pallas/grid_blockspec.html">Grids and BlockSpecs</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../pallas/tpu/index.html">Pallas TPU</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../pallas/tpu/details.html">Writing TPU kernels with Pallas</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pallas/tpu/pipelining.html">TPU Pipelining</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pallas/tpu/matmul.html">Matrix Multiplication</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pallas/tpu/sparse.html">Scalar Prefetch and Block-Sparse Computation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pallas/tpu/distributed.html">Distributed Computing in Pallas for TPUs</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../pallas/gpu/index.html">Pallas:Mosaic GPU</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../pallas/gpu/reference.html">Writing Mosaic GPU kernels with Pallas</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../pallas/design/index.html">Pallas Design Notes</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../pallas/design/design.html">Pallas Design</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pallas/design/async_note.html">Pallas Async Operations</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../pallas/CHANGELOG.html">Pallas Changelog</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/neural_network_with_tfds_data.html">Training a simple neural network, with tensorflow/datasets data loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/Neural_Network_and_Data_Loading.html">Training a simple neural network, with PyTorch data loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/vmapped_log_probs.html">Autobatching for Bayesian inference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/convolutions.html">Generalized convolutions in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../xla_flags.html">List of XLA compiler flags</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sharded-computation.html">Introduction to parallel programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-primitives.html">JAX Internals: primitives</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jaxpr.html">JAX internals: The jaxpr language</a></li>
</ul>
</li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../contributor_guide.html">Developer notes</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-9"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../contributing.html">Contributing to JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer.html">Building from source</a></li>
<li class="toctree-l2"><a class="reference internal" href="../investigating_a_regression.html">Investigating a regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../autodidax.html">Autodidax: JAX core from scratch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../autodidax2_part1.html">Autodidax2, part 1: JAX from scratch, again</a></li>

<li class="toctree-l2 current active has-children"><a class="reference internal" href="index.html">JAX Enhancement Proposals (JEPs)</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-10"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="263-prng.html">263: JAX PRNG Design</a></li>
<li class="toctree-l3"><a class="reference internal" href="2026-custom-derivatives.html">2026: Custom JVP/VJP rules for JAX-transformable functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="4008-custom-vjp-update.html">4008: Custom VJP and `nondiff_argnums` update</a></li>
<li class="toctree-l3"><a class="reference internal" href="4410-omnistaging.html">4410: Omnistaging</a></li>
<li class="toctree-l3"><a class="reference internal" href="9263-typed-keys.html">9263: Typed keys &amp; pluggable RNGs</a></li>
<li class="toctree-l3"><a class="reference internal" href="9407-type-promotion.html">9407: Design of Type Promotion Semantics for JAX</a></li>
<li class="toctree-l3"><a class="reference internal" href="9419-jax-versioning.html">9419: Jax and Jaxlib versioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="10657-sequencing-effects.html">10657: Sequencing side-effects in JAX</a></li>
<li class="toctree-l3"><a class="reference internal" href="11830-new-remat-checkpoint.html">11830: `jax.remat` / `jax.checkpoint` new implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="12049-type-annotations.html">12049: Type Annotation Roadmap for JAX</a></li>
<li class="toctree-l3"><a class="reference internal" href="14273-shard-map.html">14273: `shard_map` (`shmap`) for simple per-device code</a></li>
<li class="toctree-l3"><a class="reference internal" href="15856-jex.html">15856: `jax.extend`, an extensions module</a></li>
<li class="toctree-l3 current active"><a class="current reference internal" href="#">17111: Efficient transposition of `shard_map` (and other maps)</a></li>
<li class="toctree-l3"><a class="reference internal" href="18137-numpy-scipy-scope.html">18137: Scope of JAX NumPy &amp; SciPy Wrappers</a></li>
<li class="toctree-l3"><a class="reference internal" href="25516-effver.html">25516: Effort-based versioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="28661-jax-array-protocol.html">28661: Supporting the `__jax_array__` protocol</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../extensions.html">Extension guides</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-11"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/Writing_custom_interpreters_in_Jax.html">Writing custom Jaxpr interpreters in JAX</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.extend.html"><code class="docutils literal notranslate"><span class="pre">jax.extend</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-12"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.core.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.core</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.linear_util.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.linear_util</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.mlir.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.mlir</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.random.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.random</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../building_on_jax.html">Building on JAX</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../notes.html">Notes</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-13"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../api_compatibility.html">API compatibility</a></li>
<li class="toctree-l2"><a class="reference internal" href="../deprecation.html">Python and NumPy version support policy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../async_dispatch.html">Asynchronous dispatch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concurrency.html">Concurrency</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gpu_memory_allocation.html">GPU memory allocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rank_promotion_warning.html">Rank promotion warning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../default_dtypes.html">Default dtypes and the X64 flag</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../jax.html">Public API: <code class="docutils literal notranslate"><span class="pre">jax</span></code> package</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-14"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.numpy.html"><code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-15"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fft.html">jax.numpy.fft.fft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fft2.html">jax.numpy.fft.fft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fftfreq.html">jax.numpy.fft.fftfreq</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fftn.html">jax.numpy.fft.fftn</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fftshift.html">jax.numpy.fft.fftshift</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.hfft.html">jax.numpy.fft.hfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ifft.html">jax.numpy.fft.ifft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ifft2.html">jax.numpy.fft.ifft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ifftn.html">jax.numpy.fft.ifftn</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ifftshift.html">jax.numpy.fft.ifftshift</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ihfft.html">jax.numpy.fft.ihfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.irfft.html">jax.numpy.fft.irfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.irfft2.html">jax.numpy.fft.irfft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.irfftn.html">jax.numpy.fft.irfftn</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.rfft.html">jax.numpy.fft.rfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.rfft2.html">jax.numpy.fft.rfft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.rfftfreq.html">jax.numpy.fft.rfftfreq</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.rfftn.html">jax.numpy.fft.rfftn</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.scipy.html"><code class="docutils literal notranslate"><span class="pre">jax.scipy</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-16"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.scipy.stats.bernoulli.logpmf.html">jax.scipy.stats.bernoulli.logpmf</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.scipy.stats.bernoulli.pmf.html">jax.scipy.stats.bernoulli.pmf</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.scipy.stats.bernoulli.cdf.html">jax.scipy.stats.bernoulli.cdf</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.scipy.stats.bernoulli.ppf.html">jax.scipy.stats.bernoulli.ppf</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../jax.lax.html"><code class="docutils literal notranslate"><span class="pre">jax.lax</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.random.html"><code class="docutils literal notranslate"><span class="pre">jax.random</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.sharding.html"><code class="docutils literal notranslate"><span class="pre">jax.sharding</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.debug.html"><code class="docutils literal notranslate"><span class="pre">jax.debug</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.dlpack.html"><code class="docutils literal notranslate"><span class="pre">jax.dlpack</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.distributed.html"><code class="docutils literal notranslate"><span class="pre">jax.distributed</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.dtypes.html"><code class="docutils literal notranslate"><span class="pre">jax.dtypes</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.ffi.html"><code class="docutils literal notranslate"><span class="pre">jax.ffi</span></code> module</a></li>

<li class="toctree-l2"><a class="reference internal" href="../jax.flatten_util.html"><code class="docutils literal notranslate"><span class="pre">jax.flatten_util</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.image.html"><code class="docutils literal notranslate"><span class="pre">jax.image</span></code> module</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.nn.html"><code class="docutils literal notranslate"><span class="pre">jax.nn</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-17"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jax.nn.initializers.html"><code class="docutils literal notranslate"><span class="pre">jax.nn.initializers</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../jax.ops.html"><code class="docutils literal notranslate"><span class="pre">jax.ops</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.profiler.html"><code class="docutils literal notranslate"><span class="pre">jax.profiler</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.stages.html"><code class="docutils literal notranslate"><span class="pre">jax.stages</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.test_util.html"><code class="docutils literal notranslate"><span class="pre">jax.test_util</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.tree.html"><code class="docutils literal notranslate"><span class="pre">jax.tree</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.tree_util.html"><code class="docutils literal notranslate"><span class="pre">jax.tree_util</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.typing.html"><code class="docutils literal notranslate"><span class="pre">jax.typing</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.export.html"><code class="docutils literal notranslate"><span class="pre">jax.export</span></code> module</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.extend.html"><code class="docutils literal notranslate"><span class="pre">jax.extend</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-18"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.core.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.core</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.linear_util.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.linear_util</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.mlir.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.mlir</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.random.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.random</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.example_libraries.html"><code class="docutils literal notranslate"><span class="pre">jax.example_libraries</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-19"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jax.example_libraries.optimizers.html"><code class="docutils literal notranslate"><span class="pre">jax.example_libraries.optimizers</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.example_libraries.stax.html"><code class="docutils literal notranslate"><span class="pre">jax.example_libraries.stax</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.experimental.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-20" name="toctree-checkbox-20" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-20"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.checkify.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.checkify</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.compilation_cache.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.compilation_cache</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.custom_dce.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.custom_dce</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.custom_partitioning.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.custom_partitioning</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.jet.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.jet</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.key_reuse.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.key_reuse</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.mesh_utils.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.mesh_utils</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.multihost_utils.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.multihost_utils</span></code> module</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../jax.experimental.pallas.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.pallas</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-21" name="toctree-checkbox-21" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-21"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../jax.experimental.pallas.mosaic_gpu.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.pallas.mosaic_gpu</span></code> module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../jax.experimental.pallas.triton.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.pallas.triton</span></code> module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../jax.experimental.pallas.tpu.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.pallas.tpu</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.pjit.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.pjit</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.serialize_executable.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.serialize_executable</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.shard_map.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.shard_map</span></code> module</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../jax.experimental.sparse.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.sparse</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-22" name="toctree-checkbox-22" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-22"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.BCOO.html">jax.experimental.sparse.BCOO</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_broadcast_in_dim.html">jax.experimental.sparse.bcoo_broadcast_in_dim</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_concatenate.html">jax.experimental.sparse.bcoo_concatenate</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_dot_general.html">jax.experimental.sparse.bcoo_dot_general</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_dot_general_sampled.html">jax.experimental.sparse.bcoo_dot_general_sampled</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_dynamic_slice.html">jax.experimental.sparse.bcoo_dynamic_slice</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_extract.html">jax.experimental.sparse.bcoo_extract</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_fromdense.html">jax.experimental.sparse.bcoo_fromdense</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_gather.html">jax.experimental.sparse.bcoo_gather</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_multiply_dense.html">jax.experimental.sparse.bcoo_multiply_dense</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_multiply_sparse.html">jax.experimental.sparse.bcoo_multiply_sparse</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_update_layout.html">jax.experimental.sparse.bcoo_update_layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_reduce_sum.html">jax.experimental.sparse.bcoo_reduce_sum</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_reshape.html">jax.experimental.sparse.bcoo_reshape</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_slice.html">jax.experimental.sparse.bcoo_slice</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_sort_indices.html">jax.experimental.sparse.bcoo_sort_indices</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_squeeze.html">jax.experimental.sparse.bcoo_squeeze</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_sum_duplicates.html">jax.experimental.sparse.bcoo_sum_duplicates</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_todense.html">jax.experimental.sparse.bcoo_todense</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_transpose.html">jax.experimental.sparse.bcoo_transpose</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../jax.lib.html"><code class="docutils literal notranslate"><span class="pre">jax.lib</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.addressable_shards.html">jax.Array.addressable_shards</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.all.html">jax.Array.all</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.any.html">jax.Array.any</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.argmax.html">jax.Array.argmax</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.argmin.html">jax.Array.argmin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.argpartition.html">jax.Array.argpartition</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.argsort.html">jax.Array.argsort</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.astype.html">jax.Array.astype</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.at.html">jax.Array.at</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.choose.html">jax.Array.choose</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.clip.html">jax.Array.clip</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.compress.html">jax.Array.compress</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.committed.html">jax.Array.committed</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.conj.html">jax.Array.conj</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.conjugate.html">jax.Array.conjugate</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.copy.html">jax.Array.copy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.copy_to_host_async.html">jax.Array.copy_to_host_async</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.cumprod.html">jax.Array.cumprod</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.cumsum.html">jax.Array.cumsum</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.device.html">jax.Array.device</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.diagonal.html">jax.Array.diagonal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.dot.html">jax.Array.dot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.dtype.html">jax.Array.dtype</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.flat.html">jax.Array.flat</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.flatten.html">jax.Array.flatten</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.global_shards.html">jax.Array.global_shards</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.imag.html">jax.Array.imag</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.is_fully_addressable.html">jax.Array.is_fully_addressable</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.is_fully_replicated.html">jax.Array.is_fully_replicated</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.item.html">jax.Array.item</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.itemsize.html">jax.Array.itemsize</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.max.html">jax.Array.max</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.mean.html">jax.Array.mean</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.min.html">jax.Array.min</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.nbytes.html">jax.Array.nbytes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.ndim.html">jax.Array.ndim</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.nonzero.html">jax.Array.nonzero</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.prod.html">jax.Array.prod</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.ptp.html">jax.Array.ptp</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.ravel.html">jax.Array.ravel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.real.html">jax.Array.real</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.repeat.html">jax.Array.repeat</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.reshape.html">jax.Array.reshape</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.round.html">jax.Array.round</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.searchsorted.html">jax.Array.searchsorted</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.shape.html">jax.Array.shape</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.sharding.html">jax.Array.sharding</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.size.html">jax.Array.size</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.sort.html">jax.Array.sort</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.squeeze.html">jax.Array.squeeze</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.std.html">jax.Array.std</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.sum.html">jax.Array.sum</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.swapaxes.html">jax.Array.swapaxes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.take.html">jax.Array.take</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.to_device.html">jax.Array.to_device</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.trace.html">jax.Array.trace</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.transpose.html">jax.Array.transpose</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.var.html">jax.Array.var</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.view.html">jax.Array.view</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.T.html">jax.Array.T</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_autosummary/jax.Array.mT.html">jax.Array.mT</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../about.html">About the project</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../faq.html">Frequently asked questions (FAQ)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Change log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary of terms</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../config_options.html">Configuration Options</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../contributor_guide.html" class="nav-link">Developer notes</a></li>
    
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">JAX Enhancement Proposals (JEPs)</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Efficient...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/jax-ml/jax" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/jep/17111-shmap-transpose.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Efficient transposition of replication-inducing collectives</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#motivation">Motivation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-efficient-transpose-of-psum-or-all-gather-depends-on-whether-cotangents-are-invariant-across-devices">Problem: efficient transpose of <code class="docutils literal notranslate"><span class="pre">psum</span></code> or <code class="docutils literal notranslate"><span class="pre">all_gather</span></code> depends on whether cotangents are invariant across devices</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#solutions">Solutions</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#partial-solution-p-sum-build-the-ability-to-express-a-psum-into-out-specs">Partial solution “P-sum”: build the ability to express a <code class="docutils literal notranslate"><span class="pre">psum</span></code> into <code class="docutils literal notranslate"><span class="pre">out_specs</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#full-solution-statically-track-device-varying-vs-device-invariant-intermediates-plus-new-primitives">Full solution: statically track device-varying vs device-invariant intermediates, plus new primitives</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#tracking-device-invariance-in-avals-a-k-a-avals-with-names-revived">Tracking device invariance in avals (a.k.a. avals-with-names, revived)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#how-this-system-solves-the-inefficient-transpose-examples">How this system solves the inefficient transpose examples</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-make-the-api-convenient-for-users-and-backward-compatible">How to make the API convenient for users (and backward compatible)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-implement-the-solution">How to implement the solution</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#appendix-defining-and-motivating-maps-with-unmapped-inputs-and-outputs">Appendix: defining and motivating maps with unmapped inputs and outputs</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="efficient-transposition-of-replication-inducing-collectives">
<h1>Efficient transposition of replication-inducing collectives<a class="headerlink" href="#efficient-transposition-of-replication-inducing-collectives" title="Link to this heading">#</a></h1>
<p><em>mattjj&#64;</em>, <em>dougalm&#64;</em></p>
<p><em>August 2023</em></p>
<section id="motivation">
<h2>Motivation<a class="headerlink" href="#motivation" title="Link to this heading">#</a></h2>
<p>We have an efficiency problem in automatically transposing <code class="docutils literal notranslate"><span class="pre">shmap</span></code>s containing
certain collectives. The issue arises with <code class="docutils literal notranslate"><span class="pre">psum</span></code> and <code class="docutils literal notranslate"><span class="pre">all_gather</span></code>, specifically
when the output of the collective is returned to the caller as an unmapped
output. And it’s not an edge case: for example, it arises when applying <code class="docutils literal notranslate"><span class="pre">grad</span></code>
to a <code class="docutils literal notranslate"><span class="pre">shmap</span></code>-based batch data parallel neural network loss function which uses
<code class="docutils literal notranslate"><span class="pre">psum</span></code> to compute the total loss.</p>
<p>We’ve known about this problem for some time. An analogous issue exists with
<code class="docutils literal notranslate"><span class="pre">pmap</span></code>, though it’s been worked around by keeping <code class="docutils literal notranslate"><span class="pre">grad</span></code> inside <code class="docutils literal notranslate"><span class="pre">pmap</span></code> rather than
outside. A primary goal of the incomplete avals-with-names work was to address a
version of this transpose efficiency problem. This doc draws on those ideas,
while extending and revising them to handle more cases and to be much easier to
land. Indeed the solution proposed here only affects the <code class="docutils literal notranslate"><span class="pre">shmap</span></code> implementation.
The rest of the system need not be changed (yet).</p>
<p>The main purpose of this doc is to define this transpose efficiency problem and
propose an easy-to-land solution.</p>
<p>This doc is not about:</p>
<ul class="simple">
<li><p>logical axis names on arrays (the only axis names here are just like in
<code class="docutils literal notranslate"><span class="pre">shmap</span></code> and OG <code class="docutils literal notranslate"><span class="pre">pmap</span></code>);</p></li>
<li><p>changing autodiff semantics (all the numbers and (non)errors are staying the
same, we’re just making things more efficient);</p></li>
<li><p>allowing user code to reflect on any new information, or really affecting user
code at all.</p></li>
</ul>
</section>
<section id="problem-efficient-transpose-of-psum-or-all-gather-depends-on-whether-cotangents-are-invariant-across-devices">
<h2>Problem: efficient transpose of <code class="docutils literal notranslate"><span class="pre">psum</span></code> or <code class="docutils literal notranslate"><span class="pre">all_gather</span></code> depends on whether cotangents are invariant across devices<a class="headerlink" href="#problem-efficient-transpose-of-psum-or-all-gather-depends-on-whether-cotangents-are-invariant-across-devices" title="Link to this heading">#</a></h2>
<p>Consider this semi-realistic example, meant to resemble a replicated-parameter
batch data parallel loss function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">devices</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">devices</span><span class="p">()</span>  <span class="c1"># 8 devices</span>

<span class="nd">@partial</span><span class="p">(</span><span class="n">shmap</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="n">Mesh</span><span class="p">(</span><span class="n">devices</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;batch&#39;</span><span class="p">,)),</span>
         <span class="n">in_specs</span><span class="o">=</span><span class="p">(</span><span class="n">P</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">P</span><span class="p">(</span><span class="s1">&#39;batch&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
         <span class="n">out_specs</span><span class="o">=</span><span class="n">P</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">loss</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
  <span class="n">inputs</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="n">batch</span>
  <span class="n">predictions</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
  <span class="n">local_loss</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">predictions</span> <span class="o">-</span> <span class="n">targets</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
  <span class="n">global_loss</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">pmean</span><span class="p">(</span><span class="n">local_loss</span><span class="p">,</span> <span class="s1">&#39;batch&#39;</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">global_loss</span>
</pre></div>
</div>
<p>Notice the <code class="docutils literal notranslate"><span class="pre">out_specs=P()</span></code>, which indicates an unmapped output. If you’re not
familiar with the notion of unmapped outputs, see the appendix at the bottom of
this document.</p>
<p>Most of the details in the <code class="docutils literal notranslate"><span class="pre">loss</span></code> example aren’t important. All that matters for
our purposes is that we’re applying <code class="docutils literal notranslate"><span class="pre">psum</span></code> (or rather <code class="docutils literal notranslate"><span class="pre">pmean</span> <span class="pre">=</span> <span class="pre">lambda</span> <span class="pre">x,</span> <span class="pre">name:</span> <span class="pre">psum(x,</span> <span class="pre">name)</span> <span class="pre">/</span> <span class="pre">psum(1,</span> <span class="pre">name)</span></code>) at the end. So a distilled version looks like
this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example 1: shmap involving psum and unmapped output with inefficient transpose</span>
<span class="n">f1</span> <span class="o">=</span> <span class="n">shmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">psum</span><span class="p">(</span><span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="s1">&#39;i&#39;</span><span class="p">),</span>
           <span class="n">in_specs</span><span class="o">=</span><span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">),</span> <span class="n">out_specs</span><span class="o">=</span><span class="n">P</span><span class="p">())</span>
</pre></div>
</div>
<p>We even simplified notation by suppressing the <code class="docutils literal notranslate"><span class="pre">mesh</span></code> argument. In the examples to
follow it can be inferred from context.</p>
<p>What does the transpose look like? Writing <code class="docutils literal notranslate"><span class="pre">t</span></code> to mean function transpose, we
could evaluate <code class="docutils literal notranslate"><span class="pre">t(f1)(ybar)</span></code> for any <code class="docutils literal notranslate"><span class="pre">ybar</span></code> efficiently by applying the function
<code class="docutils literal notranslate"><span class="pre">¿f1_transpose?</span></code> below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># An efficient &quot;transpose&quot; of Example 1 (but don&#39;t transpose this again!)</span>
<span class="err">¿</span><span class="n">f1_transpose</span><span class="err">?</span> <span class="o">=</span> <span class="n">shmap</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">g</span><span class="p">),</span> <span class="n">in_specs</span><span class="o">=</span><span class="n">P</span><span class="p">(),</span> <span class="n">out_specs</span><span class="o">=</span><span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>But that’s not the transpose we currently get as t(f1).</p>
<p>Instead, the current recipe for transposition is roughly that we switch
<code class="docutils literal notranslate"><span class="pre">in_specs</span></code> and <code class="docutils literal notranslate"><span class="pre">out_specs</span></code>, do some division rescaling for unmapped outputs, and
transpose the body. Because <code class="docutils literal notranslate"><span class="pre">psum</span></code> is its own transpose (as an all-reduce sum),
we end up producing this transpose:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># The transpose we currently get for Example 1 (which is fine to transpose again)</span>
<span class="n">t</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span> <span class="o">=</span> <span class="n">shmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ybar</span><span class="p">:</span> <span class="n">t</span><span class="p">(</span><span class="n">g</span><span class="p">)(</span><span class="n">psum</span><span class="p">(</span><span class="n">ybar</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">)),</span>
              <span class="n">in_specs</span><span class="o">=</span><span class="n">P</span><span class="p">(),</span> <span class="n">out_specs</span><span class="o">=</span><span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>This transpose gets the numbers right, but it’s wasteful. We know statically
from the transpose’s <code class="docutils literal notranslate"><span class="pre">in_specs=P()</span></code> that <code class="docutils literal notranslate"><span class="pre">ybar</span></code> has the same value for each function
instance, i.e. that its value is device-invariant for devices along the mesh
axis named <code class="docutils literal notranslate"><span class="pre">i</span></code>, and yet we apply a <code class="docutils literal notranslate"><span class="pre">psum</span></code> to it! That uses expensive communication
just to multiply the value on each device by 8. (Here 8 refers to the size of
axis i. The division by 8 comes from the original function’s <code class="docutils literal notranslate"><span class="pre">out_specs=P()</span></code>; it
and the trivial <code class="docutils literal notranslate"><span class="pre">psum</span></code> basically cancel each other out.)</p>
<p>What are we doing wrong? We’re not exploiting the fact that cotangents <code class="docutils literal notranslate"><span class="pre">ybar</span></code>
corresponding to <code class="docutils literal notranslate"><span class="pre">f1</span></code>’s unmapped outputs are guaranteed to be device-invariant;
instead, we’re defensively <code class="docutils literal notranslate"><span class="pre">psum</span></code>ming them as if they weren’t because <code class="docutils literal notranslate"><span class="pre">psum</span></code>’s
transpose can’t be sure given the local information it has. Sometimes the <code class="docutils literal notranslate"><span class="pre">psum</span></code>
is necessary, as in transposing <code class="docutils literal notranslate"><span class="pre">f2</span></code> with respect to its first argument:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example 2: shmap involving psum and *mapped* output with efficient transpose</span>
<span class="n">f2</span> <span class="o">=</span> <span class="n">shmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">psum</span><span class="p">(</span><span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="s1">&#39;i&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span>
          <span class="n">in_specs</span><span class="o">=</span><span class="p">(</span><span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">),</span> <span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">)),</span> <span class="n">out_specs</span><span class="o">=</span><span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">))</span>

<span class="c1"># The transpose we currently get for Example 2 is efficient</span>
<span class="n">t</span><span class="p">(</span><span class="n">f2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">shmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y</span><span class="p">,</span> <span class="n">zbar</span><span class="p">:</span> <span class="n">t</span><span class="p">(</span><span class="n">g</span><span class="p">)(</span><span class="n">psum</span><span class="p">(</span><span class="n">zbar</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">)),</span>
                <span class="n">in_specs</span><span class="o">=</span><span class="p">(</span><span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">),</span> <span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">)),</span> <span class="n">out_specs</span><span class="o">=</span><span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>Intuitively, if our transpose machinery could tell the difference between
Example 1 and Example 2, we could do better by avoiding the psum and division
where possible.</p>
<p>The inefficient examples can be even smaller. Consider transposing this cursed
identity function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example 3: cursed identity</span>
<span class="n">cursed_identity</span> <span class="o">=</span> <span class="n">shmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">P</span><span class="p">(),</span> <span class="n">P</span><span class="p">())</span>

<span class="c1"># Currently we get these inefficient transposes</span>
<span class="n">t</span><span class="p">(</span><span class="n">cursed_identity</span><span class="p">)</span> <span class="o">=</span> <span class="n">shmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">psum</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">),</span> <span class="n">P</span><span class="p">(),</span> <span class="n">P</span><span class="p">())</span>
<span class="n">t</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">cursed_identity</span><span class="p">))</span> <span class="o">=</span> <span class="n">shmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">psum</span><span class="p">(</span><span class="n">psum</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">),</span> <span class="s1">&#39;i&#39;</span><span class="p">)),</span> <span class="n">P</span><span class="p">(),</span> <span class="n">P</span><span class="p">())</span>
<span class="o">...</span>
</pre></div>
</div>
<p>It keeps getting bigger the more we transpose. How embarrassing!</p>
<p>And <code class="docutils literal notranslate"><span class="pre">psum</span></code> isn’t the only culprit. Something analogous holds true for
<code class="docutils literal notranslate"><span class="pre">all_gather</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example 4: all_gather to an unmapped output</span>
<span class="n">f4</span> <span class="o">=</span> <span class="n">shmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">all_gather</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">),</span> <span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">),</span> <span class="n">P</span><span class="p">())</span>

<span class="c1"># Currently we get this inefficient transpose</span>
<span class="n">t</span><span class="p">(</span><span class="n">f4</span><span class="p">)</span> <span class="o">=</span> <span class="n">shmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ybar</span><span class="p">:</span> <span class="n">psum_scatter</span><span class="p">(</span><span class="n">ybar</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">),</span> <span class="n">P</span><span class="p">(),</span> <span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>This program is a bit artificial. Why do an <code class="docutils literal notranslate"><span class="pre">all_gather</span></code> and feed the result into
an unmapped output, rather than skipping the <code class="docutils literal notranslate"><span class="pre">all_gather</span></code> in the body and just
using <code class="docutils literal notranslate"><span class="pre">out_specs=P('i')</span></code> to collect the results? But even though it’s cooked-up,
this example nevertheless exhibits a transpose which unnecessarily performs
communication (we could have just performed a non-communicating slice),
analogous to Example 1 for <code class="docutils literal notranslate"><span class="pre">psum</span></code>.</p>
<p>Also analogously to the <code class="docutils literal notranslate"><span class="pre">psum</span></code> examples, the defensive <code class="docutils literal notranslate"><span class="pre">psum_scatter</span></code> is
necessary in some cases:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example 5: all_gather to a mapped output</span>
<span class="n">f5</span> <span class="o">=</span> <span class="n">shmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">all_gather</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span>
           <span class="n">in_specs</span><span class="o">=</span><span class="p">(</span><span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">),</span> <span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">)),</span> <span class="n">out_specs</span><span class="o">=</span><span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">))</span>

<span class="c1"># Currently we get this efficient transpose</span>
<span class="n">t</span><span class="p">(</span><span class="n">f5</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">shmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y</span><span class="p">,</span> <span class="n">zbar</span><span class="p">:</span> <span class="n">psum_scatter</span><span class="p">(</span><span class="n">zbar</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">),</span>
                 <span class="n">in_specs</span><span class="o">=</span><span class="p">(</span><span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">),</span> <span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">)),</span> <span class="n">out_specs</span><span class="o">=</span><span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>So how do we avoid these inefficient transposes?</p>
</section>
<section id="solutions">
<h2>Solutions<a class="headerlink" href="#solutions" title="Link to this heading">#</a></h2>
<p>Here are two solution ideas. They aren’t mutually exclusive. But (spoilers) the
second one is better, and it’s all we need.</p>
<section id="partial-solution-p-sum-build-the-ability-to-express-a-psum-into-out-specs">
<h3>Partial solution “P-sum”: build the ability to express a <code class="docutils literal notranslate"><span class="pre">psum</span></code> into <code class="docutils literal notranslate"><span class="pre">out_specs</span></code><a class="headerlink" href="#partial-solution-p-sum-build-the-ability-to-express-a-psum-into-out-specs" title="Link to this heading">#</a></h3>
<p>This solution is a bit of a strawperson because it would offer only an awkward
way to write programs. And it wouldn’t even fix everything! But it’s worth
considering, if only to motivate a more complete solution.</p>
<p>Example 4 above is artificial because we could have just used <code class="docutils literal notranslate"><span class="pre">out_specs</span></code> instead
of an <code class="docutils literal notranslate"><span class="pre">all_gather</span></code> in the body:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example 4 again</span>
<span class="n">f4</span> <span class="o">=</span> <span class="n">shmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">all_gather</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">),</span> <span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">),</span> <span class="n">P</span><span class="p">())</span>

<span class="c1"># Why didn&#39;t we just write it like this?</span>
<span class="n">f4_better</span> <span class="o">=</span> <span class="n">shmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">),</span> <span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">f4_better</span></code> version doesn’t have any transposition problems, since the
transpose problems arise from collectives in the body.</p>
<p>Analogously, we could fix Example 1 by extending <code class="docutils literal notranslate"><span class="pre">out_specs</span></code> so that they can
express summing:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example 1 again</span>
<span class="n">f1</span> <span class="o">=</span> <span class="n">shmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">psum</span><span class="p">(</span><span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="s1">&#39;i&#39;</span><span class="p">),</span>
           <span class="n">in_specs</span><span class="o">=</span><span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">),</span> <span class="n">out_specs</span><span class="o">=</span><span class="n">P</span><span class="p">())</span>

<span class="c1"># What if we could write an output sum like this?</span>
<span class="n">f1_better</span> <span class="o">=</span> <span class="n">shmap</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">in_specs</span><span class="o">=</span><span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">),</span> <span class="n">out_specs</span><span class="o">=</span><span class="n">P</span><span class="p">(</span><span class="nb">sum</span><span class="o">=</span><span class="s1">&#39;i&#39;</span><span class="p">))</span>  <span class="c1"># sum=&#39;i&#39; means sum over that axis</span>

<span class="c1"># Then it could transpose like this:</span>
<span class="n">t</span><span class="p">(</span><span class="n">f1_better</span><span class="p">)</span> <span class="o">=</span> <span class="n">shmap</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">g</span><span class="p">),</span> <span class="n">in_specs</span><span class="o">=</span><span class="n">P</span><span class="p">(),</span> <span class="n">out_specs</span><span class="o">=</span><span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">))</span>
<span class="n">t</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">f1_better</span><span class="p">))</span> <span class="o">=</span> <span class="n">shmap</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">g</span><span class="p">)),</span> <span class="n">in_specs</span><span class="o">=</span><span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">),</span> <span class="n">P</span><span class="p">(</span><span class="nb">sum</span><span class="o">=</span><span class="s1">&#39;i&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>So offering <code class="docutils literal notranslate"><span class="pre">psum</span></code>s built into <code class="docutils literal notranslate"><span class="pre">out_specs</span></code> fixes the transpose problem of
Example 1. But it doesn’t fully fix the cursed identity transpose in Example 3:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example 3 again</span>
<span class="n">cursed_identity</span> <span class="o">=</span> <span class="n">shmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">P</span><span class="p">(),</span> <span class="n">P</span><span class="p">())</span>

<span class="c1"># How it would transpose with the P-sum partial solution:</span>
<span class="n">t</span><span class="p">(</span><span class="n">cursed_identity</span><span class="p">)</span> <span class="o">=</span> <span class="n">shmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="n">P</span><span class="p">(),</span> <span class="n">P</span><span class="p">(</span><span class="nb">sum</span><span class="o">=</span><span class="s1">&#39;i&#39;</span><span class="p">))</span>
<span class="n">t</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">cursed_identity</span><span class="p">))</span> <span class="o">=</span> <span class="n">shmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="n">P</span><span class="p">(),</span> <span class="n">P</span><span class="p">(</span><span class="nb">sum</span><span class="o">=</span><span class="s1">&#39;i&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>It’s an improvement since the program doesn’t continue to get bigger as we keep
transposing, but we’re still doing wasteful communication.</p>
</section>
<section id="full-solution-statically-track-device-varying-vs-device-invariant-intermediates-plus-new-primitives">
<h3>Full solution: statically track device-varying vs device-invariant intermediates, plus new primitives<a class="headerlink" href="#full-solution-statically-track-device-varying-vs-device-invariant-intermediates-plus-new-primitives" title="Link to this heading">#</a></h3>
<p>This solution has two components:</p>
<ol class="arabic simple">
<li><p>track when values are guaranteed to be device-invariant vs device-varying
over particular mesh axes, and</p></li>
<li><p>decompose <code class="docutils literal notranslate"><span class="pre">psum</span></code> into a two-step process, introducing a new <code class="docutils literal notranslate"><span class="pre">pbroadcast</span></code>
primitive, and introduce new primitives for <code class="docutils literal notranslate"><span class="pre">all_gather</span></code> and its transposes.</p></li>
</ol>
<p>Morally, the tracking of device-invariant vs device-varying information is a
type-level consideration. But for the expedience of our first implementation, we
don’t need to literally add the information to abstract values or jaxpr types.
Before we get to implementation, we’ll first introduce the idea using types.</p>
<p>Also to follow is a discussion of making the user API convenient and backward
compatible. But to first introduce the idea, we’ll ignore convenience and
instead write code that is as explicit as possible.</p>
<section id="tracking-device-invariance-in-avals-a-k-a-avals-with-names-revived">
<h4>Tracking device invariance in avals (a.k.a. avals-with-names, revived)<a class="headerlink" href="#tracking-device-invariance-in-avals-a-k-a-avals-with-names-revived" title="Link to this heading">#</a></h4>
<p>We can sometimes tell from static information alone that the values of some
intermediate variables in the body of a <code class="docutils literal notranslate"><span class="pre">shmap</span></code> are guaranteed to be invariant
along a mesh axis, in the sense that the function instances (and their
corresponding devices) along the mesh axis must all be computing with the same
value. We’ll call such values device-invariant. For values that are not
device-invariant, we’ll say they’re device-varying, though really we mean
potentially device-varying from the point of view of the type system.</p>
<p>To encode device variance in types, we’ll extend the syntax of types for arrays.
We’ll write things like <code class="docutils literal notranslate"><span class="pre">x:f32[3,4]{i}</span></code> to indicate that <code class="docutils literal notranslate"><span class="pre">x</span></code> is (potentially)
device-varying along mesh axis <code class="docutils literal notranslate"><span class="pre">i</span></code> (and device-invariant over any other mesh
axes of the <code class="docutils literal notranslate"><span class="pre">shmap</span></code>). More generally, we’ll say the grammar for array type
syntax is something like</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">shaped_array</span> <span class="p">:</span><span class="o">:=</span> <span class="o">&lt;</span><span class="n">dtype</span><span class="o">&gt;</span><span class="p">[</span><span class="o">&lt;</span><span class="n">int_literal</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span><span class="o">&lt;</span><span class="n">device_variance_type</span><span class="o">&gt;</span>
<span class="n">device_variance_type</span> <span class="p">:</span><span class="o">:=</span> <span class="p">{</span><span class="o">&lt;</span><span class="n">axis_name</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">...</span><span class="p">}</span>
</pre></div>
</div>
<p>We’ll also update the typing rules to handle device variance types:</p>
<ul class="simple">
<li><p>for first-order primitives other than collectives</p>
<ul>
<li><p>for multi-arity primitives, the operand device variance types must be equal
where shapes must be equal, e.g. <code class="docutils literal notranslate"><span class="pre">mul</span> <span class="pre">x:f32[s1]{r1}</span> <span class="pre">y:f32[s2][r2]</span></code> requires
<code class="docutils literal notranslate"><span class="pre">r1</span> <span class="pre">==</span> <span class="pre">r2</span></code> in addition to <code class="docutils literal notranslate"><span class="pre">s1</span> <span class="pre">==</span> <span class="pre">s2</span></code></p></li>
<li><p>the output device variance type must be the same as the operand(s)</p></li>
</ul>
</li>
<li><p>for higher-order primitives</p>
<ul>
<li><p>we just instantiate any type variables including the device variance type
(and checking types for equality checks their device variance types are
equal)</p></li>
<li><p>(when performing type inference, e.g. for branches of a <code class="docutils literal notranslate"><span class="pre">cond</span></code>, we take the
union of the sets of axis names in device variance types)</p></li>
</ul>
</li>
<li><p>for first-order collectives</p>
<ul>
<li><p>a collective can either accept a device-varying or device-invariant input
(along a mesh axis corresponding to its axis name parameter); it’s an error
to pass a device-invariant operand to a collective which accepts
device-varying operands and vice-versa</p></li>
<li><p>a collective can either produce a device-varying or device-invariant output</p></li>
<li><p>see the table below
As a side benefit, whatever logic implements this type checking can subsume
<code class="docutils literal notranslate"><span class="pre">shmap</span></code>’s “static analysis” check for whether a <code class="docutils literal notranslate"><span class="pre">shmap</span></code> body function is
compatible with any unmapped <code class="docutils literal notranslate"><span class="pre">out_specs</span></code>.</p></li>
</ul>
</li>
</ul>
<p>Here’s a table summarizing the device variance typing for collective primitives:</p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Device variance type</p></th>
<th class="head"><p>Example</p></th>
<th class="head"><p>Lowers to HLO</p></th>
<th class="head"><p>Transpose</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">psum2</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Varying</span> <span class="pre">-&gt;</span> <span class="pre">Invariant</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">y:f32[3]{j}</span> <span class="pre">=</span> <span class="pre">psum(x:f32[3]{i,j},</span> <span class="pre">axis='i')</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">AllReduceSum</span></code> (communication)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">pbroadcast</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">pbroadcast</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Invariant</span> <span class="pre">-&gt;</span> <span class="pre">Varying</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">y:f32[3]{i}</span> <span class="pre">=</span> <span class="pre">pbroadcast(x:f32[3],</span> <span class="pre">'i')</span></code></p></td>
<td><p>no-op (no communication)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">psum</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">all_to_all</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Varying</span> <span class="pre">-&gt;</span> <span class="pre">Varying</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">y:f32[16]{i}</span> <span class="pre">=</span> <span class="pre">all_to_all(x:f32[16]{i},</span> <span class="pre">'i',</span> <span class="pre">0,</span> <span class="pre">0)</span></code> <code class="docutils literal notranslate"><span class="pre">AllToAll</span></code> (communication)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">all_to_all</span></code></p></td>
<td><p></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">axis_index</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">()</span> <span class="pre">-&gt;</span> <span class="pre">Varying</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">idx:i32[]{i}</span> <span class="pre">=</span> <span class="pre">axis_index('i')</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">ReplicaId</span></code> and some arithmetic (no communication)</p></td>
<td><p>n/a</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">psum_scatter</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Varying</span> <span class="pre">-&gt;</span> <span class="pre">Varying</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">y:f32[2]{i}</span> <span class="pre">=</span> <span class="pre">psum_scatter(x:f32[16]{i},</span> <span class="pre">'i')</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">ReduceScatterSum</span></code> (communication)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">all_gather</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">all_gather</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Varying</span> <span class="pre">-&gt;</span> <span class="pre">Varying</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">y:f32[16]{i}</span> <span class="pre">=</span> <span class="pre">all_gather(x:f32[2]{i},</span> <span class="pre">'i')</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">AllGather</span></code> (communication)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">psum_scatter</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">pscatter</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Invariant</span> <span class="pre">-&gt;</span> <span class="pre">Varying</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">y:f32[2]{i}</span> <span class="pre">=</span> <span class="pre">pscatter(x:f32[16],</span> <span class="pre">'i')</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">lambda</span> <span class="pre">x:</span> <span class="pre">x[axis_index('i'),</span> <span class="pre">None]</span></code> (no communication)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">all_gather_invariant</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">all_gather_invariant</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Varying</span> <span class="pre">-&gt;</span> <span class="pre">Invariant</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">y:f32[16]</span> <span class="pre">=</span> <span class="pre">all_gather_invariant(x:f32[2]{i},</span> <span class="pre">'i')</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">AllGather</span></code> (communication)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">pscatter</span></code></p></td>
</tr>
</tbody>
</table>
<p>There are some surprising things here!</p>
<ul class="simple">
<li><p>We introduced several new primitives, including</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">pbroadcast</span></code>, which interestingly lowers to a no-op</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">all_gather_invariant</span></code>, which lowers to the same thing as <code class="docutils literal notranslate"><span class="pre">all_gather</span></code> but
has a different device variance type (essentially <code class="docutils literal notranslate"><span class="pre">all_gather</span></code> has a
<code class="docutils literal notranslate"><span class="pre">pbroadcast</span></code> fused into it, whereas <code class="docutils literal notranslate"><span class="pre">all_gather_invariant</span></code> does not)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pscatter</span></code> which is the dual (transpose) of <code class="docutils literal notranslate"><span class="pre">all_gather_invariant</span></code></p></li>
</ul>
</li>
<li><p>all_gather has a device-varying result</p></li>
</ul>
<p>Intuitively, the reason to introduce <code class="docutils literal notranslate"><span class="pre">pbroadcast</span></code> (other than to make the typing
rules work) is so that <code class="docutils literal notranslate"><span class="pre">psum</span></code> can transpose to a physical no-op. The reason we
need <code class="docutils literal notranslate"><span class="pre">all_gather</span></code> to have a device-varying result is so that we can transpose it
to <code class="docutils literal notranslate"><span class="pre">psum_scatter</span></code>; if we instead left it with a device-invariant result, we
might need a downstream <code class="docutils literal notranslate"><span class="pre">pbroadcast</span></code>, and that composition would transpose to an
inefficient <code class="docutils literal notranslate"><span class="pre">psum</span></code> followed by slicing / <code class="docutils literal notranslate"><span class="pre">pscatter</span></code>. So instead we have a
<code class="docutils literal notranslate"><span class="pre">pbroadcast</span></code> “fused into” the <code class="docutils literal notranslate"><span class="pre">all_gather</span></code>, thus allowing for an efficient
transpose into <code class="docutils literal notranslate"><span class="pre">psum_scatter</span></code>. We provide <code class="docutils literal notranslate"><span class="pre">all_gather_invariant</span></code> and its
transpose <code class="docutils literal notranslate"><span class="pre">pscatter</span></code> mainly for completeness; it’s unlikely users will need it
(it corresponds to the situation in Example 4, which is easy to write
differently using <code class="docutils literal notranslate"><span class="pre">out_specs</span></code>).</p>
<p>Interestingly, the <code class="docutils literal notranslate"><span class="pre">psum</span></code> and <code class="docutils literal notranslate"><span class="pre">pbroadcast</span></code> transpose pair correspond to the
<code class="docutils literal notranslate"><span class="pre">psum_idrev</span></code> and <code class="docutils literal notranslate"><span class="pre">id_psumrev</span></code> that users introduced while training LLMs with
<code class="docutils literal notranslate"><span class="pre">pmap</span></code>.</p>
</section>
<section id="how-this-system-solves-the-inefficient-transpose-examples">
<h4>How this system solves the inefficient transpose examples<a class="headerlink" href="#how-this-system-solves-the-inefficient-transpose-examples" title="Link to this heading">#</a></h4>
<p>Consider again the simplified motivating example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example 1 again</span>
<span class="n">f1</span> <span class="o">=</span> <span class="n">shmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">psum</span><span class="p">(</span><span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="s1">&#39;i&#39;</span><span class="p">),</span>
           <span class="n">in_specs</span><span class="o">=</span><span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">),</span> <span class="n">out_specs</span><span class="o">=</span><span class="n">P</span><span class="p">())</span>

<span class="c1"># Example 1 with intermediate device variance types annotated</span>
<span class="nd">@partial</span><span class="p">(</span><span class="n">shmap</span><span class="p">,</span> <span class="n">in_specs</span><span class="o">=</span><span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">),</span> <span class="n">out_specs</span><span class="o">=</span><span class="n">P</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">f1</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">f32</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]{</span><span class="n">i</span><span class="p">}):</span>
  <span class="n">w</span><span class="p">:</span><span class="n">f32</span><span class="p">[]{</span><span class="n">i</span><span class="p">}</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">y</span><span class="p">:</span><span class="n">f32</span><span class="p">[]{}</span> <span class="o">=</span> <span class="n">psum</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">y</span>
</pre></div>
</div>
<p>With these new rules, the transpose is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example 1 transpose using device variance types (go ahead and transpose this again!)</span>
<span class="n">t</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span> <span class="o">=</span> <span class="n">shmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ybar</span><span class="p">:</span> <span class="n">t</span><span class="p">(</span><span class="n">g</span><span class="p">)(</span><span class="n">pbroadcast</span><span class="p">(</span><span class="n">ybar</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">)),</span>
              <span class="n">in_specs</span><span class="o">=</span><span class="n">P</span><span class="p">(),</span> <span class="n">out_specs</span><span class="o">=</span><span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">))</span>

<span class="c1"># Example 1 transpose with intermediate device variance types annotated</span>
<span class="nd">@partial</span><span class="p">(</span><span class="n">shmap</span><span class="p">,</span> <span class="n">in_specs</span><span class="o">=</span><span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">),</span> <span class="n">out_specs</span><span class="o">=</span><span class="n">P</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">f1_transpose</span><span class="p">(</span><span class="n">ybar</span><span class="p">:</span> <span class="n">f32</span><span class="p">[]):</span>
  <span class="n">wbar</span><span class="p">:</span><span class="n">f32</span><span class="p">[]{</span><span class="n">i</span><span class="p">}</span> <span class="o">=</span> <span class="n">pbroadcast</span><span class="p">(</span><span class="n">ybar</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">)</span>
  <span class="n">xbar</span><span class="p">:</span><span class="n">f32</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]{</span><span class="n">i</span><span class="p">}</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">g</span><span class="p">)(</span><span class="n">wbar</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">xbar</span>
</pre></div>
</div>
<p>where evaluating the <code class="docutils literal notranslate"><span class="pre">pbroadcast</span></code> application involves no communication or FLOPs
at all; it’s a no-op. Notice that if we keep transposing the body does not grow
in size; indeed <code class="docutils literal notranslate"><span class="pre">t(t(f1))</span> <span class="pre">==</span> <span class="pre">f1</span></code>. Efficiency achieved!</p>
<p>And we wouldn’t mess up the other examples either, so long as we <code class="docutils literal notranslate"><span class="pre">pbroadcast</span></code> to
make the types check where needed:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example 2 rewritten with explicit pbroadcast</span>
<span class="n">f2</span> <span class="o">=</span> <span class="n">shmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">pbroadcast</span><span class="p">(</span><span class="n">psum</span><span class="p">(</span><span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="s1">&#39;i&#39;</span><span class="p">),</span> <span class="s1">&#39;i&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span>
           <span class="n">in_specs</span><span class="o">=</span><span class="p">(</span><span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">),</span> <span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">)),</span> <span class="n">out_specs</span><span class="o">=</span><span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">))</span>

<span class="c1"># Example 2 transpose using device variance types</span>
<span class="n">t</span><span class="p">(</span><span class="n">f2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">shmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y</span><span class="p">,</span> <span class="n">zbar</span><span class="p">:</span> <span class="n">t</span><span class="p">(</span><span class="n">g</span><span class="p">)(</span><span class="n">pbroadcast</span><span class="p">(</span><span class="n">psum</span><span class="p">(</span><span class="n">zbar</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">),</span> <span class="s1">&#39;i&#39;</span><span class="p">)),</span>
                 <span class="n">in_specs</span><span class="o">=</span><span class="p">(</span><span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">),</span> <span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">)),</span> <span class="n">out_specs</span><span class="o">=</span><span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">))</span>


<span class="c1"># Example 3 again</span>
<span class="n">cursed_identity</span> <span class="o">=</span> <span class="n">shmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">P</span><span class="p">(),</span> <span class="n">P</span><span class="p">())</span>
<span class="c1"># Notice here the body is `f32[...] -&gt; f32[...]`, i.e. no device varying type.</span>

<span class="c1"># Example 3 transpose using device variance types</span>
<span class="n">t</span><span class="p">(</span><span class="n">cursed_identity</span><span class="p">)</span> <span class="o">=</span> <span class="n">shmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">P</span><span class="p">(),</span> <span class="n">P</span><span class="p">())</span>
<span class="n">t</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">cursed_identity</span><span class="p">))</span> <span class="o">=</span> <span class="n">shmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">P</span><span class="p">(),</span> <span class="n">P</span><span class="p">())</span>
</pre></div>
</div>
<p>Intuitively, in Example 1 we now only have “half the original psum”, whereas in
Example 2 we get both “halves”. For Example 3 we never need any operations in
the body at all.</p>
<p>For the <code class="docutils literal notranslate"><span class="pre">all_gather</span></code> examples, Example 4 would need to use
<code class="docutils literal notranslate"><span class="pre">all_reduce_invariant</span></code> to have an efficient transpose (though it’d be better to
instead use <code class="docutils literal notranslate"><span class="pre">out_specs</span></code> instead of the collective in the body):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example 4 rewritten with explicit all_reduce_invariant</span>
<span class="n">f4</span> <span class="o">=</span> <span class="n">shmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">all_gather_invariant</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">),</span> <span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">),</span> <span class="n">P</span><span class="p">())</span>

<span class="c1"># Example 4 with intermediate device variance types annotated</span>
<span class="nd">@partial</span><span class="p">(</span><span class="n">shmap</span><span class="p">,</span> <span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">),</span> <span class="n">P</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">f4</span><span class="p">(</span><span class="n">x</span><span class="p">:</span><span class="n">f32</span><span class="p">[</span><span class="mi">1</span><span class="p">]{</span><span class="n">i</span><span class="p">}):</span>
  <span class="n">y</span><span class="p">:</span><span class="n">f32</span><span class="p">[</span><span class="mi">8</span><span class="p">]{}</span> <span class="o">=</span> <span class="n">all_gather_invariant</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">y</span>

<span class="c1"># Example 4 transpose with intermediate device variance types annotated</span>
<span class="nd">@partial</span><span class="p">(</span><span class="n">shmap</span><span class="p">,</span> <span class="n">in_specs</span><span class="o">=</span><span class="n">P</span><span class="p">(),</span> <span class="n">out_specs</span><span class="o">=</span><span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">f4_transpose</span><span class="p">(</span><span class="n">ybar</span><span class="p">:</span><span class="n">f32</span><span class="p">[</span><span class="mi">8</span><span class="p">]):</span>
  <span class="n">xbar</span><span class="p">:</span><span class="n">f32</span><span class="p">[</span><span class="mi">1</span><span class="p">]{</span><span class="n">i</span><span class="p">}</span> <span class="o">=</span> <span class="n">pscatter</span><span class="p">(</span><span class="n">ybar</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">xbar</span>
</pre></div>
</div>
<p>For Example 5, using the device-varying <code class="docutils literal notranslate"><span class="pre">all_gather</span></code> works as we’d want:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example 5 with intermediate device variance types annotated</span>
<span class="nd">@partial</span><span class="p">(</span><span class="n">shmap</span><span class="p">,</span> <span class="n">in_specs</span><span class="o">=</span><span class="p">(</span><span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">),</span> <span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">)),</span> <span class="n">out_specs</span><span class="o">=</span><span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">f5</span><span class="p">(</span><span class="n">x</span><span class="p">:</span><span class="n">f32</span><span class="p">[</span><span class="mi">1</span><span class="p">]{</span><span class="n">i</span><span class="p">},</span> <span class="n">y</span><span class="p">:</span><span class="n">f32</span><span class="p">[</span><span class="mi">8</span><span class="p">]{</span><span class="n">i</span><span class="p">}):</span>
  <span class="n">z</span><span class="p">:</span><span class="n">f32</span><span class="p">[</span><span class="mi">8</span><span class="p">]{</span><span class="n">i</span><span class="p">}</span> <span class="o">=</span> <span class="n">all_gather</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">)</span>
  <span class="n">w</span><span class="p">:</span><span class="n">f32</span><span class="p">[</span><span class="mi">8</span><span class="p">]{</span><span class="n">i</span><span class="p">}</span> <span class="o">=</span> <span class="n">z</span> <span class="o">*</span> <span class="n">y</span>
  <span class="k">return</span> <span class="n">w</span>

<span class="c1"># Transpose with respect to first argument</span>
<span class="nd">@partial</span><span class="p">(</span><span class="n">shmap</span><span class="p">,</span> <span class="n">in_specs</span><span class="o">=</span><span class="p">(</span><span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">),</span> <span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">)),</span> <span class="n">out_specs</span><span class="o">=</span><span class="n">P</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">f5_transpose</span><span class="p">(</span><span class="n">y</span><span class="p">:</span><span class="n">f32</span><span class="p">[</span><span class="mi">8</span><span class="p">]{</span><span class="n">i</span><span class="p">},</span> <span class="n">wbar</span><span class="p">:</span><span class="n">f32</span><span class="p">[</span><span class="mi">8</span><span class="p">]{</span><span class="n">i</span><span class="p">}):</span>
  <span class="n">zbar</span><span class="p">:</span><span class="n">f32</span><span class="p">[</span><span class="mi">8</span><span class="p">]{</span><span class="n">i</span><span class="p">}</span> <span class="o">=</span> <span class="n">wbar</span> <span class="o">*</span> <span class="n">y</span>
  <span class="n">xbar</span><span class="p">:</span><span class="n">f32</span><span class="p">[</span><span class="mi">1</span><span class="p">]{</span><span class="n">i</span><span class="p">}</span> <span class="o">=</span> <span class="n">psum_scatter</span><span class="p">(</span><span class="n">zbar</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">xbar</span>
</pre></div>
</div>
</section>
</section>
<section id="how-to-make-the-api-convenient-for-users-and-backward-compatible">
<h3>How to make the API convenient for users (and backward compatible)<a class="headerlink" href="#how-to-make-the-api-convenient-for-users-and-backward-compatible" title="Link to this heading">#</a></h3>
<p>But what user wants to write <code class="docutils literal notranslate"><span class="pre">pbroadcast</span></code>s? And what developer wants to break
lots of existing user code involving <code class="docutils literal notranslate"><span class="pre">psum</span></code>s which are not fed into unmapped
outputs? Not me!</p>
<p>Instead we can automatically insert the <code class="docutils literal notranslate"><span class="pre">pbroadcast</span></code>s. It’s a bit analogous to how
we do automatic rank promotion at the <code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code> layer, inserting broadcasts to
avoid rank mismatch errors in binary operators. But it’s much simpler since we
don’t need to contend with shape tuples. The typical rule is: whenever we see a
multi-arity operation where the operands disagree in their device variance
types, take the union of operands’ device variance types’ axis name sets and
insert <code class="docutils literal notranslate"><span class="pre">pbroadcast</span></code>s to lift each operand to the resulting device variance type.</p>
<p>Automatically inserting <code class="docutils literal notranslate"><span class="pre">pbroadcast</span></code>s just before they’re needed may mean we apply
the same <code class="docutils literal notranslate"><span class="pre">pbroadcast</span></code> to the same operand multiple times, creating common
subexpressions. When we transpose, those could turn into a sum-of-<code class="docutils literal notranslate"><span class="pre">psum</span></code>s rather
than a <code class="docutils literal notranslate"><span class="pre">psum</span></code>-of-sum. We’ll rely on the compiler to clean that up as appropriate.
If it’s a problem then we could add some simple memoization to the
<code class="docutils literal notranslate"><span class="pre">pbroadcast</span></code>-insertion pass.</p>
<p>The user API for <code class="docutils literal notranslate"><span class="pre">all_gather</span></code> will mean <code class="docutils literal notranslate"><span class="pre">all_gather_p</span></code> by default (not
<code class="docutils literal notranslate"><span class="pre">all_gather_invariant_p</span></code>), covering the common case and meaning no <code class="docutils literal notranslate"><span class="pre">pbroadcast</span></code>s
must be inserted.</p>
<p>We can provide an option on <code class="docutils literal notranslate"><span class="pre">shmap</span></code> to disable this automatic insertion of
<code class="docutils literal notranslate"><span class="pre">pbroadcast</span></code>s, in which case it’ll be up to the user to ensure type-correctness.
This explicit option may be appealing to some who want to be explicit about
where the <code class="docutils literal notranslate"><span class="pre">psum</span></code>s occur in the backward pass.</p>
</section>
<section id="how-to-implement-the-solution">
<h3>How to implement the solution<a class="headerlink" href="#how-to-implement-the-solution" title="Link to this heading">#</a></h3>
<p>The key to making the implementation lightweight is that <strong>we aren’t going to
add these types to avals or jaxprs</strong>. At least, not at first. That can be
expensive because it requires updating the rest of JAX, e.g. all consumers of
avals and jaxprs may need to handle the new types. We’re not falling for that
again!</p>
<p>Instead we’re going to keep these extended types as metadata internal to
<code class="docutils literal notranslate"><span class="pre">shmap</span></code>, just like the current “replication checking for <code class="docutils literal notranslate"><span class="pre">out_specs</span></code>” machinery
is internal to <code class="docutils literal notranslate"><span class="pre">shmap</span></code>. Indeed this solution amounts to a relatively small
extension to that existing machinery: it was already tracking the same
information; now we’re just adding the <code class="docutils literal notranslate"><span class="pre">pbroadcast</span></code>s.</p>
<p>We have at least two options for where to perform the <code class="docutils literal notranslate"><span class="pre">pbroadcast</span></code> insertion:</p>
<ol class="arabic simple">
<li><p>just before transposition, in the transpose rule, where we have a jaxpr of
the computation to be transposed;</p></li>
<li><p>in every <code class="docutils literal notranslate"><span class="pre">shmap</span></code> body, whether eagerly executed or staged out, like the
current “replication checking for <code class="docutils literal notranslate"><span class="pre">out_specs</span></code>” machinery.
The former may end up being easier since we only have to handle the jaxpr case,
and only linear primitives. But we’ll start by trying the latter so the
implementation here is a strict revision/extension to the existing
replication-checking logic.</p></li>
</ol>
</section>
</section>
<section id="appendix-defining-and-motivating-maps-with-unmapped-inputs-and-outputs">
<h2>Appendix: defining and motivating maps with unmapped inputs and outputs<a class="headerlink" href="#appendix-defining-and-motivating-maps-with-unmapped-inputs-and-outputs" title="Link to this heading">#</a></h2>
<p>For concreteness, we’ll mostly focus on <code class="docutils literal notranslate"><span class="pre">shmap</span></code>, though these same ideas apply
to e.g. <code class="docutils literal notranslate"><span class="pre">pmap</span></code> and probably <code class="docutils literal notranslate"><span class="pre">xmap</span></code>.</p>
<p>An argument/input is <em>unmapped</em> along a mesh axis when the corresponding entry
of <code class="docutils literal notranslate"><span class="pre">in_specs</span></code> doesn’t mention that mesh axis’s name. Logically it means that
each function instance along that mesh axis gets the same value for the
argument. To the caller, each operand is sliced according to the mesh axes over
which the operand is mapped, whereas there is no slicing for mesh axes over
which the operand is unmapped.</p>
<p>An output is <em>unmapped</em> along a mesh axis when the corresponding entry of
<code class="docutils literal notranslate"><span class="pre">out_specs</span></code> doesn’t mention that mesh axis’s name. Logically it means each
function instance along that mesh axis must return the same value. To the
caller, each result of the <code class="docutils literal notranslate"><span class="pre">shmap</span></code> is formed by concatenating the return values
of every function instance along which the outputs are mapped, whereas for mesh
axes over which the output is unmapped only one copy of the value is used.</p>
<p>See <a class="reference external" href="https://docs.jax.dev/en/latest/jep/14273-shard-map.html">the <code class="docutils literal notranslate"><span class="pre">shmap</span></code>
JEP</a> for examples
of unmapped inputs and outputs. For comparison, in <code class="docutils literal notranslate"><span class="pre">vmap</span></code> unmapped
inputs/outputs are indicated by using <code class="docutils literal notranslate"><span class="pre">in_axes</span></code> / <code class="docutils literal notranslate"><span class="pre">out_axes</span></code> of <code class="docutils literal notranslate"><span class="pre">None</span></code> (rather
than an <code class="docutils literal notranslate"><span class="pre">int</span></code>).</p>
<p>Here are reasons we like unmapped inputs and outputs for <code class="docutils literal notranslate"><span class="pre">shmap</span></code>:</p>
<ul class="simple">
<li><p><strong>Same expressiveness as <code class="docutils literal notranslate"><span class="pre">pjit</span></code>.</strong> Anything <code class="docutils literal notranslate"><span class="pre">pjit</span></code> can do, the <code class="docutils literal notranslate"><span class="pre">shmap</span></code> escape
hatch should be able to do too. Or else we’d have a lacking escape hatch! If
we didn’t have unmapped outputs in <code class="docutils literal notranslate"><span class="pre">shmap</span></code> then we couldn’t express the same
batch-parallel loss function computations as <code class="docutils literal notranslate"><span class="pre">pjit</span></code>.</p></li>
<li><p><strong>Closed-over inputs.</strong> Closed-over inputs essentially correspond to unmapped
inputs, and…</p></li>
<li><p><strong>Closure under transposition.</strong> Once we have unmapped inputs, it’s natural to
be able to transpose to unmapped outputs.</p></li>
</ul>
<p>So unmapped outputs are both canonical and useful!</p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="15856-jex.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><code class="docutils literal notranslate"><span class="pre">jax.extend</span></code>: a module for extensions</p>
      </div>
    </a>
    <a class="right-next"
       href="18137-numpy-scipy-scope.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">JEP 18137: Scope of JAX NumPy &amp; SciPy Wrappers</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#motivation">Motivation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-efficient-transpose-of-psum-or-all-gather-depends-on-whether-cotangents-are-invariant-across-devices">Problem: efficient transpose of <code class="docutils literal notranslate"><span class="pre">psum</span></code> or <code class="docutils literal notranslate"><span class="pre">all_gather</span></code> depends on whether cotangents are invariant across devices</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#solutions">Solutions</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#partial-solution-p-sum-build-the-ability-to-express-a-psum-into-out-specs">Partial solution “P-sum”: build the ability to express a <code class="docutils literal notranslate"><span class="pre">psum</span></code> into <code class="docutils literal notranslate"><span class="pre">out_specs</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#full-solution-statically-track-device-varying-vs-device-invariant-intermediates-plus-new-primitives">Full solution: statically track device-varying vs device-invariant intermediates, plus new primitives</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#tracking-device-invariance-in-avals-a-k-a-avals-with-names-revived">Tracking device invariance in avals (a.k.a. avals-with-names, revived)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#how-this-system-solves-the-inefficient-transpose-examples">How this system solves the inefficient transpose examples</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-make-the-api-convenient-for-users-and-backward-compatible">How to make the API convenient for users (and backward compatible)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-implement-the-solution">How to implement the solution</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#appendix-defining-and-motivating-maps-with-unmapped-inputs-and-outputs">Appendix: defining and motivating maps with unmapped inputs and outputs</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The JAX authors
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024, The JAX Authors.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>